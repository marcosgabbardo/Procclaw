<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcClaw</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶û</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['IBM Plex Sans', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            900: '#0d1117',
                            800: '#161b22',
                            700: '#21262d',
                            600: '#30363d',
                            500: '#484f58',
                            400: '#6e7681',
                            300: '#8b949e',
                            200: '#c9d1d9',
                            100: '#f0f6fc',
                        },
                        accent: {
                            500: '#f97316',
                            400: '#fb923c',
                            600: '#ea580c',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #21262d; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #484f58; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #6e7681; }
        @media (prefers-reduced-motion: no-preference) {
            @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
            .animate-pulse-slow { animation: pulse-slow 2s infinite; }
            @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
            .animate-slide-in { animation: slide-in 0.2s ease-out; }
        }
        .log-line { font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.5; }
        .log-timestamp { color: #6e7681; margin-right: 8px; user-select: none; }
        kbd { background: #30363d; padding: 2px 6px; border-radius: 4px; font-size: 11px; border: 1px solid #484f58; }
        button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible {
            outline: 2px solid #f97316;
            outline-offset: 2px;
        }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .tag-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #30363d; border-radius: 9999px; font-size: 12px; }
        .tag-badge:hover .tag-remove { opacity: 1; }
        .tag-remove { opacity: 0; cursor: pointer; transition: opacity 0.15s; }
        .tag-add-btn { cursor: pointer; padding: 2px 6px; border-radius: 9999px; background: #21262d; border: 1px dashed #484f58; font-size: 11px; }
        .tag-add-btn:hover { border-color: #6e7681; background: #30363d; }
        .dep-node { padding: 8px 12px; border-radius: 8px; border: 1px solid #30363d; background: #21262d; }
        .column-toggle { cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .column-toggle.active { background: #30363d; color: #f0f6fc; }
        .column-toggle:not(.active) { background: transparent; color: #6e7681; }
        /* Drag handle for column reorder */
        .drag-handle { cursor: grab; opacity: 0.5; }
        .drag-handle:hover { opacity: 1; }
    </style>
</head>
<body class="bg-dark-900 text-dark-200 min-h-dvh font-sans" x-data="app()" x-init="init()">
    
    <!-- Header -->
    <header class="bg-dark-800 border-b border-dark-600 sticky top-0 z-50">
        <div class="max-w-[95vw] mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ü¶û</span>
                <h1 class="text-xl font-semibold text-dark-100">ProcClaw</h1>
                <span class="text-xs text-dark-400 bg-dark-700 px-2 py-0.5 rounded" x-text="version"></span>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-green-400 tabular-nums" x-text="stats.running"></span>
                        <span class="text-dark-400">running</span>
                    </div>
                    <div class="flex items-center gap-2" x-show="stats.failed > 0">
                        <span class="text-red-400 tabular-nums" x-text="stats.failed"></span>
                        <span class="text-dark-400">failed</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-dark-300 tabular-nums" x-text="stats.total"></span>
                        <span class="text-dark-400">total</span>
                    </div>
                </div>
                <div class="h-4 w-px bg-dark-600 hidden md:block"></div>
                <div class="flex items-center gap-2" x-show="health.status === 'healthy'">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse-slow"></span>
                    <span class="text-sm text-dark-300">Healthy</span>
                </div>
                <div class="flex items-center gap-2" x-show="health.status !== 'healthy'">
                    <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                    <span class="text-sm text-red-400">Offline</span>
                </div>
                <button @click="refresh()" class="p-2 hover:bg-dark-700 rounded-lg transition" aria-label="Refresh">
                    <svg class="w-5 h-5" :class="loading && 'animate-spin'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-dark-800 border-b border-dark-600">
        <div class="max-w-[95vw] mx-auto px-4">
            <div class="flex gap-1">
                <button @click="currentTab = 'jobs'" 
                    :class="currentTab === 'jobs' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    ‚öôÔ∏è Jobs
                </button>
                <button @click="currentTab = 'runs'; loadRuns()" 
                    :class="currentTab === 'runs' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üìä Runs
                </button>
                <button @click="currentTab = 'dependencies'" 
                    :class="currentTab === 'dependencies' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üîó Dependencies
                </button>
                <button @click="currentTab = 'workflows'; loadWorkflows()" 
                    :class="currentTab === 'workflows' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    ‚õìÔ∏è Workflows
                </button>
                <button @click="currentTab = 'logs'" 
                    :class="currentTab === 'logs' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üìú Logs
                </button>
                <button @click="currentTab = 'dlq'" 
                    :class="currentTab === 'dlq' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üíÄ DLQ
                    <span x-show="dlqStats.pending > 0" class="ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full" x-text="dlqStats.pending"></span>
                </button>
                <button @click="currentTab = 'config'; loadFullYaml(); loadAuthConfig()" 
                    :class="currentTab === 'config' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üîß Config
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-[95vw] mx-auto px-4 py-6 pb-16">
        
        <!-- Jobs Tab -->
        <div x-show="currentTab === 'jobs'" x-cloak>
            <!-- Filters -->
            <div class="bg-dark-800 border border-dark-600 rounded-xl p-4 mb-4">
                <div class="flex flex-wrap gap-3 items-center">
                    <input type="text" x-model="filters.search" placeholder="Search jobs..." 
                        class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-accent-500 w-64">
                    <select x-model="filters.type" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Types</option>
                        <option value="continuous">Continuous</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="oneshot">One-shot</option>
                        <option value="manual">Manual</option>
                        <option value="openclaw">OpenClaw</option>
                    </select>
                    <select x-model="filters.status" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Status</option>
                        <option value="running">Running</option>
                        <option value="queued">Queued</option>
                        <option value="planned">Planned</option>
                        <option value="stopped">Stopped</option>
                        <option value="failed">Failed</option>
                    </select>
                    <select x-model="filters.tag" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Tags</option>
                        <template x-for="tag in allTags" :key="tag">
                            <option :value="tag" x-text="tag"></option>
                        </template>
                    </select>
                    <select x-model="filters.queue" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Queues</option>
                        <option value="__none__">No Queue</option>
                        <template x-for="q in allQueues" :key="q">
                            <option :value="q" x-text="q"></option>
                        </template>
                    </select>
                    <div class="ml-auto flex gap-2">
                        <button @click="showColumnSettings = true" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition" title="Column settings">
                            ‚öôÔ∏è Columns
                        </button>
                        <button @click="viewMode = viewMode === 'table' ? 'cards' : 'table'" 
                            class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition"
                            :title="viewMode === 'table' ? 'Card view' : 'Table view'">
                            <span x-show="viewMode === 'table'">üìá</span>
                            <span x-show="viewMode === 'cards'">üìä</span>
                        </button>
                        <button @click="showCreateModal = true" class="bg-accent-500 hover:bg-accent-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                            + New Job
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table View -->
            <div x-show="viewMode === 'table'" class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-dark-700">
                            <tr>
                                <template x-for="col in visibleColumns" :key="col.id">
                                    <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3 select-none"
                                        :class="col.sortable !== false && 'cursor-pointer hover:text-dark-200'"
                                        @click="col.sortable !== false && toggleSort(col.id)">
                                        <span class="flex items-center gap-1">
                                            <span x-text="col.label"></span>
                                            <span x-show="isSortedBy(col.id)" class="text-accent-400" x-text="sortDir === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                        </span>
                                    </th>
                                </template>
                                <th class="text-right text-xs font-medium text-dark-400 uppercase px-4 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-dark-700">
                            <template x-for="job in filteredJobs" :key="job.id">
                                <tr class="hover:bg-dark-700/50 transition">
                                    <!-- Dynamic columns -->
                                    <template x-for="col in visibleColumns" :key="col.id">
                                        <td class="px-4 py-3">
                                            <!-- Job ID -->
                                            <template x-if="col.id === 'id'">
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <button @click="selectJob(job)" class="font-medium text-dark-100 hover:text-accent-400 transition text-left" x-text="job.id"></button>
                                                        <button @click="openEditModal(job)" class="opacity-0 hover:opacity-100 focus:opacity-100 text-dark-400 hover:text-dark-200 transition text-xs" title="Edit">‚úèÔ∏è</button>
                                                    </div>
                                                    <div class="text-xs text-dark-400" x-text="job.name"></div>
                                                </div>
                                            </template>
                                            <!-- Type -->
                                            <template x-if="col.id === 'type'">
                                                <span class="text-xs px-2 py-1 rounded-full"
                                                    :class="getTypeClass(job.type)"
                                                    x-text="job.type">
                                                </span>
                                            </template>
                                            <!-- Status -->
                                            <template x-if="col.id === 'status'">
                                                <div class="flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full"
                                                        :class="job.status === 'running' ? 'bg-green-500' : job.status === 'failed' ? 'bg-red-500' : job.status === 'planned' ? 'bg-cyan-500' : job.status === 'paused' ? 'bg-yellow-500' : job.status === 'queued' ? 'bg-indigo-500' : 'bg-dark-500'">
                                                    </span>
                                                    <span class="text-sm" :class="!job.enabled && 'text-dark-500'">
                                                        <span x-text="job.enabled ? job.status : 'disabled'"></span>
                                                        <span x-show="job.status === 'queued' && job.queue_status" class="text-dark-400 text-xs ml-1" x-text="'#' + (job.queue_status?.position + 1)"></span>
                                                    </span>
                                                </div>
                                            </template>
                                            <!-- Queue -->
                                            <template x-if="col.id === 'queue'">
                                                <div class="flex items-center gap-1">
                                                    <span x-show="job.queue" class="text-xs px-2 py-0.5 rounded-full bg-indigo-500/20 text-indigo-300" x-text="job.queue"></span>
                                                    <span x-show="!job.queue" class="text-dark-500">-</span>
                                                </div>
                                            </template>
                                            <!-- Last Run -->
                                            <template x-if="col.id === 'last_run'">
                                                <span class="text-sm text-dark-400" x-text="job.started_at ? formatDate(job.started_at) : '-'"></span>
                                            </template>
                                            <!-- Next Run -->
                                            <template x-if="col.id === 'next_run'">
                                                <span class="text-sm text-dark-400" x-text="job.next_run ? formatNextRun(job.next_run) : '-'"></span>
                                            </template>
                                            <!-- Tags -->
                                            <template x-if="col.id === 'tags'">
                                                <div class="flex flex-wrap gap-1 items-center" @click.stop>
                                                    <template x-for="tag in (job.tags || [])" :key="tag">
                                                        <span class="tag-badge text-dark-300">
                                                            <span x-text="tag"></span>
                                                            <span class="tag-remove text-dark-500 hover:text-red-400" @click="removeTag(job.id, tag)">√ó</span>
                                                        </span>
                                                    </template>
                                                    <button class="tag-add-btn text-dark-400 hover:text-dark-200" @click="openTagInput(job.id)" title="Add tag">+</button>
                                                </div>
                                            </template>
                                            <!-- Workflows -->
                                            <template x-if="col.id === 'workflows'">
                                                <div class="flex flex-wrap gap-1 items-center">
                                                    <template x-for="wf in getWorkflowsForJob(job.id)" :key="wf.id">
                                                        <span class="text-xs px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300 cursor-pointer hover:bg-purple-500/30"
                                                            :title="wf.type + ': ' + wf.jobs.join(' ‚Üí ')"
                                                            x-text="wf.name">
                                                        </span>
                                                    </template>
                                                    <span x-show="getWorkflowsForJob(job.id).length === 0" class="text-dark-500">-</span>
                                                </div>
                                            </template>
                                            <!-- Dependencies -->
                                            <template x-if="col.id === 'deps'">
                                                <div class="flex items-center gap-1 text-sm">
                                                    <span x-show="job.depends_on?.length > 0" class="text-blue-400" :title="'Depends on: ' + job.depends_on?.map(d => d.job).join(', ')">
                                                        ‚¨ÖÔ∏è <span x-text="job.depends_on?.length"></span>
                                                    </span>
                                                    <span x-show="job.dependents?.length > 0" class="text-green-400" :title="'Dependents: ' + job.dependents?.map(d => d.job).join(', ')">
                                                        ‚û°Ô∏è <span x-text="job.dependents?.length"></span>
                                                    </span>
                                                    <span x-show="!job.depends_on?.length && !job.dependents?.length" class="text-dark-500">-</span>
                                                </div>
                                            </template>
                                            <!-- Created -->
                                            <template x-if="col.id === 'created'">
                                                <span class="text-sm text-dark-400" x-text="job.created_at ? formatDate(job.created_at) : '-'"></span>
                                            </template>
                                            <!-- Modified -->
                                            <template x-if="col.id === 'modified'">
                                                <span class="text-sm text-dark-400" x-text="job.updated_at ? formatDate(job.updated_at) : '-'"></span>
                                            </template>
                                            <!-- Schedule -->
                                            <template x-if="col.id === 'schedule'">
                                                <div class="flex items-center gap-1">
                                                    <span class="text-xs font-mono text-dark-400" x-text="job.schedule || '-'"></span>
                                                    <span x-show="job.schedule" 
                                                          class="text-dark-500 hover:text-dark-300 cursor-help text-xs" 
                                                          :title="cronToHuman(job.schedule)">?</span>
                                                </div>
                                            </template>
                                            <!-- Restarts -->
                                            <template x-if="col.id === 'restarts'">
                                                <span class="text-sm text-dark-400 tabular-nums" x-text="job.restart_count || 0"></span>
                                            </template>
                                        </td>
                                    </template>
                                    <!-- Actions -->
                                    <td class="px-4 py-3 text-right" @click.stop>
                                        <div class="flex justify-end gap-0.5">
                                            <button @click="startJob(job.id)" x-show="job.status !== 'running' && job.status !== 'paused' && job.status !== 'queued'" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-green-400 text-sm" title="Start">‚ñ∂</button>
                                            <button @click="forceStartJob(job.id)" x-show="job.status === 'queued'" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-orange-400 text-sm" title="Force Start (bypass queue)">‚ö°</button>
                                            <button @click="stopJob(job.id)" x-show="job.status === 'running'" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Stop">‚óº</button>
                                            <button @click="pauseJob(job.id)" x-show="!job.paused && (job.type === 'scheduled' || job.type === 'oneshot' || job.type === 'openclaw' || job.type === 'continuous')" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-yellow-400 text-sm" title="Pause">‚è∏</button>
                                            <button @click="resumeJob(job.id)" x-show="job.paused" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-green-400 text-sm" title="Resume">‚ñ∂Ô∏è</button>
                                            <button @click="forceRunJob(job.id)" x-show="job.schedule && job.status !== 'running' && !job.paused" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-purple-400 text-sm" title="Run Now">‚ö°</button>
                                            <button @click="viewLogs(job.id)" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-blue-400 text-sm" title="Logs">üìã</button>
                                            <button @click="deleteJob(job.id)" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Delete">‚úï</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="filteredJobs.length === 0" class="text-center py-8 text-dark-400">
                    No jobs match your filters
                </div>
            </div>

            <!-- Cards View -->
            <div x-show="viewMode === 'cards'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="job in filteredJobs" :key="job.id">
                    <div class="bg-dark-800 border border-dark-600 rounded-xl p-4 hover:border-dark-500 transition cursor-pointer" @click="selectJob(job)">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="font-medium text-dark-100" x-text="job.id"></div>
                                <div class="text-xs text-dark-400" x-text="job.name"></div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full" :class="job.status === 'running' ? 'bg-green-500 animate-pulse-slow' : job.status === 'failed' ? 'bg-red-500' : job.status === 'planned' ? 'bg-cyan-500' : job.status === 'paused' ? 'bg-yellow-500' : job.status === 'queued' ? 'bg-indigo-500 animate-pulse-slow' : 'bg-dark-500'"></span>
                                <span class="text-xs px-2 py-1 rounded-full" :class="getTypeClass(job.type)" x-text="job.type"></span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 mb-3" @click.stop>
                            <template x-for="tag in (job.tags || [])" :key="tag">
                                <span class="tag-badge text-dark-300">
                                    <span x-text="tag"></span>
                                    <span class="tag-remove text-dark-500 hover:text-red-400" @click="removeTag(job.id, tag)">√ó</span>
                                </span>
                            </template>
                            <button class="tag-add-btn text-dark-400 hover:text-dark-200" @click="openTagInput(job.id)" title="Add tag">+</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs text-dark-400 mb-3">
                            <div>Last: <span class="text-dark-300" x-text="job.started_at ? formatDate(job.started_at) : '-'"></span></div>
                            <div>Next: <span class="text-dark-300" x-text="job.next_run ? formatNextRun(job.next_run) : '-'"></span></div>
                        </div>
                        <div class="flex justify-between items-center" @click.stop>
                            <div class="flex items-center gap-1 text-xs">
                                <span x-show="job.depends_on?.length > 0" class="text-blue-400">‚¨ÖÔ∏è <span x-text="job.depends_on?.length"></span></span>
                                <span x-show="job.dependents?.length > 0" class="text-green-400">‚û°Ô∏è <span x-text="job.dependents?.length"></span></span>
                            </div>
                            <div class="flex gap-0.5">
                                <button @click="startJob(job.id)" x-show="job.status !== 'running' && job.status !== 'paused' && job.status !== 'queued'" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-green-400 text-sm" title="Start">‚ñ∂</button>
                                <button @click="forceStartJob(job.id)" x-show="job.status === 'queued'" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-orange-400 text-sm" title="Force Start (bypass queue)">‚ö°</button>
                                <button @click="stopJob(job.id)" x-show="job.status === 'running'" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Stop">‚óº</button>
                                <button @click="pauseJob(job.id)" x-show="!job.paused && (job.type === 'scheduled' || job.type === 'oneshot' || job.type === 'openclaw' || job.type === 'continuous')" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-yellow-400 text-sm" title="Pause">‚è∏</button>
                                <button @click="resumeJob(job.id)" x-show="job.paused" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-green-400 text-sm" title="Resume">‚ñ∂Ô∏è</button>
                                <button @click="forceRunJob(job.id)" x-show="job.schedule && job.status !== 'running' && !job.paused" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-purple-400 text-sm" title="Run Now">‚ö°</button>
                                <button @click="viewLogs(job.id)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-blue-400 text-sm" title="Logs">üìã</button>
                                <button @click="deleteJob(job.id)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Delete">‚úï</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Runs Tab -->
        <div x-show="currentTab === 'runs'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <!-- Filters -->
                <div class="p-4 border-b border-dark-600 flex flex-wrap gap-4 items-center">
                    <select x-model="runsFilter.job_id" @change="loadRuns()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Jobs</option>
                        <template x-for="job in jobs" :key="job.id">
                            <option :value="job.id" x-text="job.id"></option>
                        </template>
                    </select>
                    <select x-model="runsFilter.status" @change="loadRuns()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Status</option>
                        <option value="completed">Completed (Success + Failed)</option>
                        <option value="success">Success only</option>
                        <option value="failed">Failed only</option>
                        <option value="running">Running only</option>
                    </select>
                    <select x-model="runsFilter.trigger" @change="loadRuns()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Triggers</option>
                        <option value="manual">Manual</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="oneshot">One-shot</option>
                        <option value="restart">Restart</option>
                        <option value="dependency">Dependency</option>
                        <option value="api">API</option>
                    </select>
                    <select x-model="runsFilter.hasSession" @change="runsPage = 1; selectedRuns = []" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Runs</option>
                        <option value="yes">üß† With AI Session</option>
                        <option value="no">No AI Session</option>
                    </select>
                    <button @click="loadRuns(); loadHealingQueue()" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm">üîÑ Refresh</button>
                    <span class="text-sm text-dark-400 ml-auto">
                        Showing <span class="text-dark-200" x-text="((runsPage-1)*runsPerPage+1) + '-' + Math.min(runsPage*runsPerPage, filteredRuns.length)"></span> 
                        of <span class="text-dark-200" x-text="filteredRuns.length"></span>
                    </span>
                </div>
                
                <!-- Healing Queue Status -->
                <div x-show="healingQueue && (healingQueue.processing || healingQueue.pending_count > 0)" 
                     class="mx-4 mt-4 p-3 bg-purple-500/10 border border-purple-500/30 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-purple-400">üîß</span>
                            <div>
                                <span class="text-sm font-medium text-purple-300">Healing Queue</span>
                                <span x-show="healingQueue?.processing" class="ml-2 text-xs text-purple-400 animate-pulse">
                                    Processing: <span x-text="healingQueue?.current_job"></span>
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <span class="text-dark-400">Pending:</span>
                            <span class="text-purple-300 font-mono" x-text="healingQueue?.pending_count || 0"></span>
                        </div>
                    </div>
                    <div x-show="healingQueue?.pending_jobs?.length > 0" class="mt-2 flex flex-wrap gap-1">
                        <template x-for="job in healingQueue?.pending_jobs || []">
                            <span class="text-xs px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded" x-text="job"></span>
                        </template>
                    </div>
                </div>
                
                <!-- Bulk Actions -->
                <div x-show="selectedRuns.length > 0" class="mx-4 mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-red-400">üóëÔ∏è</span>
                        <span class="text-sm text-red-300">
                            <span class="font-medium" x-text="selectedRuns.length"></span> run(s) selected
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="selectedRuns = []" class="px-3 py-1.5 text-sm bg-dark-600 hover:bg-dark-500 rounded-lg text-dark-300">
                            Clear
                        </button>
                        <button @click="bulkDeleteRuns()" class="px-3 py-1.5 text-sm bg-red-600 hover:bg-red-500 rounded-lg text-white flex items-center gap-1">
                            <span>üóëÔ∏è</span> Delete Selected
                        </button>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="overflow-x-auto">
                <table class="w-full min-w-[800px]">
                    <thead class="bg-dark-700">
                        <tr>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3 w-10">
                                <input type="checkbox" 
                                    :checked="selectedRuns.length > 0 && selectedRuns.length === paginatedRuns.length"
                                    :indeterminate="selectedRuns.length > 0 && selectedRuns.length < paginatedRuns.length"
                                    @change="toggleSelectAllRuns($event)"
                                    class="w-4 h-4 rounded border-dark-500 bg-dark-700 text-accent-500 focus:ring-accent-500 cursor-pointer">
                            </th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Job</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Status</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Trigger</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Workflow</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Started</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Duration</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Exit Code</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Healing</th>
                            <th class="text-right text-xs font-medium text-dark-400 uppercase px-4 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-dark-700">
                        <template x-for="run in paginatedRuns" :key="run.id">
                            <tr class="hover:bg-dark-750 transition cursor-pointer" :class="selectedRuns.includes(run.id) ? 'bg-red-500/5' : ''" @click="selectRun(run)">
                                <td class="px-4 py-3" @click.stop>
                                    <input type="checkbox" 
                                        :checked="selectedRuns.includes(run.id)"
                                        @change="toggleRunSelection(run.id)"
                                        class="w-4 h-4 rounded border-dark-500 bg-dark-700 text-accent-500 focus:ring-accent-500 cursor-pointer">
                                </td>
                                <td class="px-4 py-3">
                                    <div class="font-medium text-dark-100" x-text="run.job_id"></div>
                                    <div class="text-xs text-dark-400" x-text="run.job_name || ''"></div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full"
                                            :class="run.status === 'success' ? 'bg-green-500' : run.status === 'failed' ? 'bg-red-500' : 'bg-yellow-500 animate-pulse'">
                                        </span>
                                        <span class="text-sm" x-text="run.status"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="text-xs px-2 py-1 rounded-full bg-dark-600 text-dark-300" x-text="run.trigger"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span x-show="run.composite_id" class="text-xs px-2 py-1 rounded-full bg-purple-500/20 text-purple-300 font-mono" x-text="run.composite_id"></span>
                                    <span x-show="!run.composite_id" class="text-dark-500">-</span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="text-sm text-dark-300" x-text="formatDateFull(run.started_at)"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="text-sm text-dark-400" x-text="run.duration_seconds ? formatDuration(run.duration_seconds) : '-'"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="font-mono text-sm" :class="run.exit_code === 0 ? 'text-green-400' : run.exit_code ? 'text-red-400' : 'text-dark-400'" x-text="run.exit_code ?? '-'"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <template x-if="run.healing">
                                        <span class="text-sm cursor-help" 
                                            :class="{
                                                'text-green-400': run.healing.status === 'fixed',
                                                'text-yellow-400 animate-pulse': run.healing.status === 'in_progress',
                                                'text-red-400': run.healing.status === 'gave_up',
                                                'text-orange-400': run.healing.status === 'awaiting_approval'
                                            }"
                                            :title="run.healing.fix_summary || run.healing.root_cause || 'Healing ' + run.healing.status">
                                            <span x-show="run.healing.status === 'fixed'">‚úÖ</span>
                                            <span x-show="run.healing.status === 'in_progress'">üîß</span>
                                            <span x-show="run.healing.status === 'gave_up'">‚ùå</span>
                                            <span x-show="run.healing.status === 'awaiting_approval'">‚è∏Ô∏è</span>
                                            <span class="text-xs ml-1" x-text="run.healing.attempts + '/' + 3"></span>
                                        </span>
                                    </template>
                                    <span x-show="!run.healing" class="text-dark-500">-</span>
                                </td>
                                <td class="px-4 py-3 text-right flex items-center justify-end gap-1">
                                    <button x-show="run.healing?.status === 'in_progress'" @click.stop="cancelHealing(run)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Cancel Healing">‚èπÔ∏è</button>
                                    <button x-show="run.healing" @click.stop="viewRunHealing(run)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-purple-400 text-sm" title="View Healing Details">üîß</button>
                                    <button x-show="run.has_transcript" @click.stop="viewRunSession(run)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-orange-400 text-sm" title="View AI Session">üß†</button>
                                    <button @click.stop="viewRunLogs(run)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-blue-400 text-sm" title="View Logs">üìã</button>
                                    <button @click.stop="deleteRun(run)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Delete Run">üóëÔ∏è</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                </div>
                
                <!-- Pagination -->
                <div x-show="totalRunsPages > 1" class="p-4 border-t border-dark-600 flex items-center justify-center gap-2">
                    <button @click="runsPage = 1" :disabled="runsPage === 1" 
                        class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">‚èÆÔ∏è</button>
                    <button @click="runsPage--" :disabled="runsPage === 1" 
                        class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">‚óÄÔ∏è</button>
                    <span class="px-4 text-sm">
                        Page <span class="text-dark-200" x-text="runsPage"></span> of <span class="text-dark-200" x-text="totalRunsPages"></span>
                    </span>
                    <button @click="runsPage++" :disabled="runsPage === totalRunsPages" 
                        class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">‚ñ∂Ô∏è</button>
                    <button @click="runsPage = totalRunsPages" :disabled="runsPage === totalRunsPages" 
                        class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">‚è≠Ô∏è</button>
                </div>
                
                <div x-show="runs.length === 0" class="text-center py-8 text-dark-400">
                    No runs found
                </div>
            </div>
        </div>

        <!-- Run Detail Modal -->
        <div x-show="selectedRun" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="selectedRun = null">
            <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-2xl" @click.stop>
                <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-medium" x-text="'Run #' + selectedRun?.id"></h2>
                        <p class="text-sm text-dark-400" x-text="selectedRun?.job_id"></p>
                    </div>
                    <button @click="selectedRun = null" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                </div>
                <div class="p-4 space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Status</div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full" :class="selectedRun?.status === 'success' ? 'bg-green-500' : selectedRun?.status === 'failed' ? 'bg-red-500' : 'bg-yellow-500'"></span>
                                <span x-text="selectedRun?.status"></span>
                            </div>
                        </div>
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Trigger</div>
                            <span x-text="selectedRun?.trigger"></span>
                        </div>
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Exit Code</div>
                            <span class="font-mono" :class="selectedRun?.exit_code === 0 ? 'text-green-400' : 'text-red-400'" x-text="selectedRun?.exit_code ?? '-'"></span>
                        </div>
                    </div>
                    <div x-show="selectedRun?.composite_id" class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3">
                        <div class="text-xs text-purple-400 mb-1">‚õìÔ∏è Part of Workflow</div>
                        <span class="font-mono text-purple-300" x-text="selectedRun?.composite_id"></span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Started</div>
                            <span x-text="selectedRun?.started_at ? formatDateFull(selectedRun.started_at) : '-'"></span>
                        </div>
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Finished</div>
                            <span x-text="selectedRun?.finished_at ? formatDateFull(selectedRun.finished_at) : '-'"></span>
                        </div>
                    </div>
                    <div class="bg-dark-700 rounded-lg p-3">
                        <div class="text-xs text-dark-400 mb-1">Duration</div>
                        <span x-text="selectedRun?.duration_seconds ? formatDuration(selectedRun.duration_seconds) : '-'"></span>
                    </div>
                    <div x-show="selectedRun?.cmd" class="bg-dark-700 rounded-lg p-3">
                        <div class="text-xs text-dark-400 mb-1">Command</div>
                        <div class="font-mono text-sm text-dark-200 break-all" x-text="selectedRun?.cmd"></div>
                    </div>
                    <div x-show="selectedRun?.error" class="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
                        <div class="text-xs text-red-400 mb-1">Error</div>
                        <div class="text-sm text-red-300" x-text="selectedRun?.error"></div>
                    </div>
                    <div class="flex gap-2 pt-4 border-t border-dark-700">
                        <button x-show="selectedRun?.has_transcript" @click="viewRunSession(selectedRun)" class="flex-1 py-2 bg-orange-500/20 text-orange-400 hover:bg-orange-500/30 rounded-lg transition">üß† View AI Session</button>
                        <button @click="viewRunLogs(selectedRun)" class="flex-1 py-2 bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 rounded-lg transition">üìã View Logs</button>
                        <button @click="selectedRun = null" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Run Logs Modal -->
        <div x-show="showRunLogs" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showRunLogs = false">
            <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-4xl max-h-[80vh] flex flex-col" @click.stop>
                <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-medium">Logs for Run #<span x-text="runLogRun?.id"></span></h2>
                        <p class="text-sm text-dark-400"><span x-text="runLogRun?.job_id"></span> ‚Ä¢ <span x-text="runLogRun?.started_at ? formatDateFull(runLogRun.started_at) : ''"></span></p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-dark-400" x-text="runLogContent.length + ' lines'"></span>
                        <button @click="showRunLogs = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto p-4">
                    <pre class="font-mono text-xs text-dark-200 whitespace-pre-wrap break-all"><template x-for="(line, idx) in runLogContent" :key="idx"><div class="hover:bg-dark-700 px-2 py-0.5" x-text="line"></div></template></pre>
                </div>
                <div class="p-4 border-t border-dark-600 flex justify-end gap-2">
                    <button @click="downloadRunLogs()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm">üì• Download</button>
                    <button @click="showRunLogs = false" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm">Close</button>
                </div>
            </div>
        </div>

        <!-- Session Viewer Modal -->
        <div x-show="showSessionModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showSessionModal = false">
            <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-4xl max-h-[85vh] flex flex-col" @click.stop>
                <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-medium">üß† AI Session - Run #<span x-text="sessionRun?.id"></span></h2>
                        <p class="text-sm text-dark-400">
                            <span x-text="sessionRun?.job_id"></span> ‚Ä¢ 
                            <span x-text="sessionMessages.length"></span> messages
                            <span x-show="sessionSearch" class="text-orange-400">
                                ‚Ä¢ <span x-text="filteredSessionMessages.length"></span> matching
                            </span>
                        </p>
                    </div>
                    <button @click="showSessionModal = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                </div>
                
                <!-- Search bar -->
                <div class="px-4 pt-3">
                    <div class="relative">
                        <input type="text" x-model="sessionSearch" placeholder="Search in session..." 
                            class="w-full bg-dark-700 border border-dark-600 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-accent-500">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-dark-400">üîç</span>
                        <button x-show="sessionSearch" @click="sessionSearch = ''" class="absolute right-3 top-1/2 -translate-y-1/2 text-dark-400 hover:text-dark-200">‚úï</button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-auto p-4 space-y-4">
                    <template x-for="(msg, idx) in filteredSessionMessages" :key="idx">
                        <div class="rounded-lg p-3" 
                            :class="msg.role === 'user' ? 'bg-blue-500/10 border border-blue-500/30' : 
                                    msg.role === 'assistant' ? 'bg-green-500/10 border border-green-500/30' : 
                                    'bg-dark-700'">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-medium px-2 py-0.5 rounded"
                                    :class="msg.role === 'user' ? 'bg-blue-500/20 text-blue-400' : 
                                            msg.role === 'assistant' ? 'bg-green-500/20 text-green-400' : 
                                            'bg-dark-600 text-dark-300'"
                                    x-text="msg.role"></span>
                                <span x-show="msg.model" class="text-xs text-dark-400" x-text="msg.model"></span>
                            </div>
                            
                            <!-- Text content -->
                            <template x-if="typeof msg.content === 'string'">
                                <div class="text-sm text-dark-200 whitespace-pre-wrap" x-text="msg.content"></div>
                            </template>
                            
                            <!-- Array content (thinking, text, tool calls) -->
                            <template x-if="Array.isArray(msg.content)">
                                <div class="space-y-2">
                                    <template x-for="(part, pidx) in msg.content" :key="pidx">
                                        <div>
                                            <!-- Thinking block -->
                                            <template x-if="part.type === 'thinking'">
                                                <details class="bg-dark-800/50 rounded p-2">
                                                    <summary class="cursor-pointer text-xs text-dark-400 hover:text-dark-200">üí≠ Thinking...</summary>
                                                    <div class="mt-2 text-xs text-dark-400 whitespace-pre-wrap" x-text="part.thinking"></div>
                                                </details>
                                            </template>
                                            
                                            <!-- Text block -->
                                            <template x-if="part.type === 'text'">
                                                <div class="text-sm text-dark-200 whitespace-pre-wrap" x-text="part.text"></div>
                                            </template>
                                            
                                            <!-- Tool call -->
                                            <template x-if="part.type === 'toolCall'">
                                                <details class="bg-dark-800/50 rounded p-2 border border-dark-600">
                                                    <summary class="cursor-pointer text-xs text-orange-400 hover:text-orange-300">
                                                        üîß <span x-text="part.name"></span>
                                                    </summary>
                                                    <pre class="mt-2 text-xs text-dark-400 overflow-x-auto" x-text="JSON.stringify(part.arguments, null, 2)"></pre>
                                                </details>
                                            </template>
                                            
                                            <!-- Tool result -->
                                            <template x-if="part.type === 'toolResult'">
                                                <details class="bg-dark-800/50 rounded p-2 border border-dark-600">
                                                    <summary class="cursor-pointer text-xs text-cyan-400 hover:text-cyan-300">
                                                        üì§ Tool Result
                                                    </summary>
                                                    <pre class="mt-2 text-xs text-dark-400 overflow-x-auto max-h-40" x-text="typeof part.content === 'string' ? part.content.slice(0, 2000) : JSON.stringify(part.content, null, 2).slice(0, 2000)"></pre>
                                                </details>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Token usage -->
                            <div x-show="msg.usage" class="mt-2 text-xs text-dark-500">
                                Tokens: <span x-text="msg.usage?.totalTokens || (msg.usage?.input + msg.usage?.output)"></span>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="sessionMessages.length === 0" class="text-center py-8 text-dark-400">
                        No messages in session
                    </div>
                </div>
                
                <div class="p-4 border-t border-dark-600 flex justify-end">
                    <button @click="showSessionModal = false" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm">Close</button>
                </div>
            </div>
        </div>

        <!-- Healing Details Modal -->
        <div x-show="showHealingModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showHealingModal = false">
            <div class="bg-dark-800 rounded-xl max-w-3xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-medium">üîß Self-Healing Details - Run #<span x-text="healingRun?.id"></span></h2>
                        <div class="text-sm text-dark-400">
                            <span x-text="healingRun?.job_id"></span>
                        </div>
                    </div>
                    <button @click="showHealingModal = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                </div>
                
                <div class="p-6 overflow-auto flex-1 space-y-6">
                    <!-- Status -->
                    <div class="flex items-center gap-4">
                        <div class="text-4xl">
                            <span x-show="healingDetails?.healing_status === 'fixed'">‚úÖ</span>
                            <span x-show="healingDetails?.healing_status === 'in_progress'">üîß</span>
                            <span x-show="healingDetails?.healing_status === 'gave_up'">‚ùå</span>
                            <span x-show="healingDetails?.healing_status === 'awaiting_approval'">‚è∏Ô∏è</span>
                        </div>
                        <div>
                            <div class="text-xl font-medium capitalize" x-text="healingDetails?.healing_status?.replace('_', ' ')"></div>
                            <div class="text-sm text-dark-400">
                                Attempts: <span x-text="healingDetails?.healing_attempts"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exit Codes -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-dark-700 rounded-lg p-4">
                            <div class="text-xs text-dark-400 mb-1">Original Exit Code</div>
                            <div class="text-2xl font-mono text-red-400" x-text="healingDetails?.original_exit_code ?? '-'"></div>
                        </div>
                        <div class="bg-dark-700 rounded-lg p-4">
                            <div class="text-xs text-dark-400 mb-1">Final Exit Code</div>
                            <div class="text-2xl font-mono" 
                                :class="healingDetails?.final_exit_code === 0 ? 'text-green-400' : 'text-red-400'"
                                x-text="healingDetails?.final_exit_code ?? '-'"></div>
                        </div>
                    </div>
                    
                    <!-- Analysis -->
                    <template x-if="healingDetails?.healing_result?.analysis">
                        <div class="bg-dark-700 rounded-lg p-4">
                            <div class="text-sm font-medium text-dark-200 mb-3">Analysis</div>
                            <dl class="space-y-2 text-sm">
                                <div class="flex">
                                    <dt class="w-32 text-dark-400">Root Cause:</dt>
                                    <dd class="text-dark-200 flex-1" x-text="healingDetails.healing_result.analysis.root_cause || '-'"></dd>
                                </div>
                                <div class="flex">
                                    <dt class="w-32 text-dark-400">Category:</dt>
                                    <dd class="text-dark-200" x-text="healingDetails.healing_result.analysis.category || '-'"></dd>
                                </div>
                                <div class="flex">
                                    <dt class="w-32 text-dark-400">Confidence:</dt>
                                    <dd class="text-dark-200" x-text="healingDetails.healing_result.analysis.confidence || '-'"></dd>
                                </div>
                            </dl>
                        </div>
                    </template>
                    
                    <!-- Summary -->
                    <template x-if="healingDetails?.healing_result?.summary">
                        <div class="bg-dark-700 rounded-lg p-4">
                            <div class="text-sm font-medium text-dark-200 mb-2">Summary</div>
                            <div class="text-sm text-dark-300 whitespace-pre-wrap" x-text="healingDetails.healing_result.summary"></div>
                        </div>
                    </template>
                    
                    <!-- Actions Taken -->
                    <template x-if="healingDetails?.healing_result?.actions_taken?.length">
                        <div class="bg-dark-700 rounded-lg p-4">
                            <div class="text-sm font-medium text-dark-200 mb-2">Actions Taken</div>
                            <ul class="list-disc list-inside text-sm text-dark-300 space-y-1">
                                <template x-for="action in healingDetails.healing_result.actions_taken">
                                    <li x-text="JSON.stringify(action)"></li>
                                </template>
                            </ul>
                        </div>
                    </template>
                    
                    <!-- Human Intervention Needed -->
                    <template x-if="healingDetails?.healing_result?.human_intervention_needed">
                        <div class="bg-orange-500/20 border border-orange-500/50 rounded-lg p-4">
                            <div class="text-sm font-medium text-orange-400 mb-2">‚ö†Ô∏è Human Intervention Needed</div>
                            <div class="text-sm text-orange-300" x-text="healingDetails.healing_result.human_intervention_reason || 'Manual action required'"></div>
                        </div>
                    </template>
                    
                    <!-- Raw Details (collapsible) -->
                    <details class="bg-dark-700 rounded-lg">
                        <summary class="p-4 cursor-pointer text-sm text-dark-400 hover:text-dark-200">View Raw Healing Result</summary>
                        <pre class="p-4 pt-0 text-xs overflow-auto text-dark-400 font-mono" x-text="JSON.stringify(healingDetails?.healing_result, null, 2)"></pre>
                    </details>
                </div>
                
                <div class="p-4 border-t border-dark-600 flex justify-end">
                    <button @click="showHealingModal = false" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm">Close</button>
                </div>
            </div>
        </div>

        <!-- Dependencies Tab -->
        <div x-show="currentTab === 'dependencies'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl p-6">
                <h3 class="text-lg font-medium mb-4">Job Dependency Graph</h3>
                
                <div class="space-y-6">
                    <template x-for="chain in dependencyChains" :key="chain.root">
                        <div class="bg-dark-700 rounded-lg p-4">
                            <div class="text-sm text-dark-400 mb-3">Chain starting from: <span class="text-dark-200 font-medium" x-text="chain.root"></span></div>
                            <div class="flex flex-wrap items-center gap-3">
                                <template x-for="(node, idx) in chain.nodes" :key="node.id">
                                    <div class="flex items-center gap-2">
                                        <div class="dep-node cursor-pointer hover:border-accent-500 transition" @click="selectJobById(node.id)"
                                            :class="{'border-green-500': getJobStatus(node.id) === 'running', 'border-red-500': getJobStatus(node.id) === 'failed', 'border-cyan-500': getJobStatus(node.id) === 'planned'}">
                                            <div class="font-medium text-sm" x-text="node.id"></div>
                                            <div class="text-xs text-dark-400" x-text="node.type"></div>
                                        </div>
                                        <span x-show="idx < chain.nodes.length - 1" class="text-dark-500 text-xl">‚Üí</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="independentJobs.length > 0" class="bg-dark-700 rounded-lg p-4">
                        <div class="text-sm text-dark-400 mb-3">Independent Jobs (no dependencies)</div>
                        <div class="flex flex-wrap gap-3">
                            <template x-for="job in independentJobs" :key="job.id">
                                <div class="dep-node cursor-pointer hover:border-accent-500 transition" @click="selectJobById(job.id)"
                                    :class="{'border-green-500': job.status === 'running', 'border-red-500': job.status === 'failed', 'border-cyan-500': job.status === 'planned'}">
                                    <div class="font-medium text-sm" x-text="job.id"></div>
                                    <div class="text-xs text-dark-400" x-text="job.type"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <div x-show="dependencyChains.length === 0 && independentJobs.length === 0" class="text-center py-8 text-dark-400">
                    No jobs configured
                </div>
            </div>
        </div>

        <!-- Workflows Tab -->
        <div x-show="currentTab === 'workflows'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <!-- Header -->
                <div class="flex items-center justify-between p-4 border-b border-dark-600">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-semibold">Workflows</h2>
                        <span class="text-sm text-dark-400">Chain, Group, Chord</span>
                    </div>
                    <button @click="openNewWorkflowModal()" 
                        class="px-4 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <span>+ New Workflow</span>
                    </button>
                </div>
                
                <!-- Saved Workflows -->
                <div class="p-4 border-b border-dark-600">
                    <h3 class="text-sm font-medium text-dark-300 mb-3">Saved Workflows</h3>
                    <div x-show="savedWorkflows.length === 0" class="text-center py-6 text-dark-400">
                        No saved workflows yet. Create one to run chains, groups, or chords.
                    </div>
                    <div class="grid gap-3">
                        <template x-for="workflow in savedWorkflows" :key="workflow.id">
                            <div class="bg-dark-700 rounded-lg p-4 flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <span class="text-2xl" x-text="workflow.type === 'chain' ? '‚õìÔ∏è' : workflow.type === 'group' ? 'üì¶' : 'üéµ'"></span>
                                    <div>
                                        <div class="font-medium" x-text="workflow.name"></div>
                                        <div class="text-sm text-dark-400 flex items-center gap-2 mt-1">
                                            <span class="px-2 py-0.5 bg-dark-600 rounded text-xs uppercase" x-text="workflow.type"></span>
                                            <span x-text="workflow.jobs.length + ' jobs'"></span>
                                            <template x-if="workflow.callback">
                                                <span class="text-dark-500">‚Üí <span x-text="workflow.callback"></span></span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button @click="runWorkflow(workflow)" 
                                        class="px-3 py-1.5 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded text-sm transition">
                                        ‚ñ∂ Run
                                    </button>
                                    <button @click="editWorkflow(workflow)" 
                                        class="px-3 py-1.5 bg-dark-600 hover:bg-dark-500 rounded text-sm transition">
                                        ‚úèÔ∏è
                                    </button>
                                    <button @click="deleteWorkflow(workflow)" 
                                        class="px-3 py-1.5 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded text-sm transition">
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Quick Run Section -->
                <div class="p-4">
                    <h3 class="text-sm font-medium text-dark-300 mb-3">Quick Run (Ad-hoc)</h3>
                    <div class="bg-dark-700 rounded-lg p-4">
                        <div class="flex flex-wrap gap-3 items-end">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-xs text-dark-400 mb-1">Type</label>
                                <select x-model="quickWorkflow.type" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                                    <option value="chain">‚õìÔ∏è Chain (Sequential)</option>
                                    <option value="group">üì¶ Group (Parallel)</option>
                                    <option value="chord">üéµ Chord (Parallel + Callback)</option>
                                </select>
                            </div>
                            <div class="flex-[2] min-w-[300px]">
                                <label class="block text-xs text-dark-400 mb-1">Jobs (select multiple)</label>
                                <div class="flex flex-wrap gap-2 bg-dark-800 border border-dark-600 rounded-lg p-2 min-h-[42px]">
                                    <template x-for="(jobId, index) in quickWorkflow.jobs" :key="index">
                                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-dark-600 rounded text-sm">
                                            <span x-text="jobId"></span>
                                            <button @click="quickWorkflow.jobs.splice(index, 1)" class="text-dark-400 hover:text-red-400">√ó</button>
                                        </span>
                                    </template>
                                    <select @change="if($event.target.value && !quickWorkflow.jobs.includes($event.target.value)) { quickWorkflow.jobs.push($event.target.value); } $event.target.value = '';"
                                        class="bg-transparent text-sm focus:outline-none text-dark-400 flex-1 min-w-[120px]">
                                        <option value="">+ Add job...</option>
                                        <template x-for="job in jobs" :key="job.id">
                                            <option :value="job.id" x-text="job.id" :disabled="quickWorkflow.jobs.includes(job.id)"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                            <div x-show="quickWorkflow.type === 'chord'" class="min-w-[150px]">
                                <label class="block text-xs text-dark-400 mb-1">Callback Job</label>
                                <select x-model="quickWorkflow.callback" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                                    <option value="">Select callback...</option>
                                    <template x-for="job in jobs" :key="job.id">
                                        <option :value="job.id" x-text="job.id"></option>
                                    </template>
                                </select>
                            </div>
                            <button @click="runQuickWorkflow()" 
                                :disabled="quickWorkflow.jobs.length < 2 || (quickWorkflow.type === 'chord' && !quickWorkflow.callback)"
                                class="px-4 py-2 bg-accent-500 hover:bg-accent-600 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg text-sm font-medium transition">
                                ‚ñ∂ Run Now
                            </button>
                        </div>
                        <div class="mt-3 text-xs text-dark-400">
                            <template x-if="quickWorkflow.type === 'chain'">
                                <span>‚õìÔ∏è Chain: Jobs run one after another. Stops on first failure.</span>
                            </template>
                            <template x-if="quickWorkflow.type === 'group'">
                                <span>üì¶ Group: Jobs run in parallel. Waits for all to complete.</span>
                            </template>
                            <template x-if="quickWorkflow.type === 'chord'">
                                <span>üéµ Chord: Jobs run in parallel, then callback runs when all complete.</span>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Workflow Runs -->
                <div class="p-4 border-t border-dark-600">
                    <h3 class="text-sm font-medium text-dark-300 mb-3">Recent Runs</h3>
                    <div x-show="workflowRuns.length === 0" class="text-center py-4 text-dark-400 text-sm">
                        No workflow runs yet
                    </div>
                    <div class="space-y-2">
                        <template x-for="run in workflowRuns" :key="run.composite_id">
                            <div class="bg-dark-700 rounded-lg p-3 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span :class="run.status === 'completed' ? 'text-green-400' : run.status === 'failed' ? 'text-red-400' : 'text-yellow-400'"
                                        x-text="run.status === 'completed' ? '‚úì' : run.status === 'failed' ? '‚úó' : '‚è≥'"></span>
                                    <div>
                                        <span class="text-sm" x-text="run.composite_id"></span>
                                        <span class="text-xs text-dark-400 ml-2" x-text="run.type"></span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4 text-sm text-dark-400">
                                    <span x-text="Object.keys(run.results || {}).length + ' jobs'"></span>
                                    <button @click="viewWorkflowRun(run)" class="text-accent-400 hover:text-accent-300">Details</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Workflow Modal -->
        <div x-show="showWorkflowModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showWorkflowModal = false">
            <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto" @click.stop>
                <div class="flex items-center justify-between p-4 border-b border-dark-600">
                    <h2 class="text-lg font-semibold" x-text="editingWorkflow ? 'Edit Workflow' : 'New Workflow'"></h2>
                    <button @click="showWorkflowModal = false" class="text-dark-400 hover:text-dark-200">‚úï</button>
                </div>
                <div class="p-4 space-y-4">
                    <div>
                        <label class="block text-sm text-dark-300 mb-1">Name</label>
                        <input type="text" x-model="workflowForm.name" placeholder="My Workflow"
                            class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-accent-500">
                    </div>
                    <div>
                        <label class="block text-sm text-dark-300 mb-1">Type</label>
                        <select x-model="workflowForm.type" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="chain">‚õìÔ∏è Chain (Sequential: A ‚Üí B ‚Üí C)</option>
                            <option value="group">üì¶ Group (Parallel: A + B + C)</option>
                            <option value="chord">üéµ Chord (Parallel + Callback: (A + B + C) ‚Üí D)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-dark-300 mb-1">Jobs</label>
                        <div class="space-y-2">
                            <template x-for="(jobId, index) in workflowForm.jobs" :key="index">
                                <div class="flex items-center gap-2">
                                    <span class="w-6 text-center text-dark-400 text-sm" x-text="index + 1"></span>
                                    <select x-model="workflowForm.jobs[index]" class="flex-1 bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                                        <option value="">Select job...</option>
                                        <template x-for="job in jobs" :key="job.id">
                                            <option :value="job.id" x-text="job.id"></option>
                                        </template>
                                    </select>
                                    <button @click="workflowForm.jobs.splice(index, 1)" class="p-2 text-dark-400 hover:text-red-400">‚úï</button>
                                </div>
                            </template>
                            <button @click="workflowForm.jobs.push('')" class="w-full py-2 border border-dashed border-dark-600 hover:border-dark-500 rounded-lg text-sm text-dark-400 hover:text-dark-300 transition">
                                + Add Job
                            </button>
                        </div>
                    </div>
                    <div x-show="workflowForm.type === 'chord'">
                        <label class="block text-sm text-dark-300 mb-1">Callback Job</label>
                        <select x-model="workflowForm.callback" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="">Select callback job...</option>
                            <template x-for="job in jobs" :key="job.id">
                                <option :value="job.id" x-text="job.id"></option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-2 p-4 border-t border-dark-600">
                    <button @click="showWorkflowModal = false" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition">Cancel</button>
                    <button @click="saveWorkflow()" 
                        :disabled="!workflowForm.name || workflowForm.jobs.filter(j => j).length < 2"
                        class="px-4 py-2 bg-accent-500 hover:bg-accent-600 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg text-sm font-medium transition">
                        <span x-text="editingWorkflow ? 'Save Changes' : 'Create Workflow'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Workflow Run Details Modal -->
        <div x-show="showWorkflowRunModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showWorkflowRunModal = false">
            <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-lg" @click.stop>
                <div class="flex items-center justify-between p-4 border-b border-dark-600">
                    <h2 class="text-lg font-semibold">Workflow Run Details</h2>
                    <button @click="showWorkflowRunModal = false" class="text-dark-400 hover:text-dark-200">‚úï</button>
                </div>
                <div class="p-4" x-show="selectedWorkflowRun">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-dark-400">ID</span>
                            <span class="font-mono text-sm" x-text="selectedWorkflowRun?.composite_id"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-dark-400">Type</span>
                            <span x-text="selectedWorkflowRun?.type"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-dark-400">Status</span>
                            <span :class="selectedWorkflowRun?.status === 'completed' ? 'text-green-400' : 'text-red-400'" 
                                x-text="selectedWorkflowRun?.status"></span>
                        </div>
                        <div class="border-t border-dark-600 pt-3 mt-3">
                            <div class="text-sm text-dark-400 mb-2">Results</div>
                            <div class="space-y-2">
                                <template x-for="(exitCode, jobId) in (selectedWorkflowRun?.results || {})" :key="jobId">
                                    <div class="flex items-center justify-between bg-dark-700 rounded p-2">
                                        <span x-text="jobId"></span>
                                        <span :class="exitCode === 0 ? 'text-green-400' : 'text-red-400'" 
                                            x-text="exitCode === 0 ? '‚úì Success' : '‚úó Exit ' + exitCode"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-4 border-t border-dark-600">
                    <button @click="showWorkflowRunModal = false" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition">Close</button>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div x-show="currentTab === 'logs'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <div class="flex flex-wrap items-center justify-between gap-3 p-4 border-b border-dark-600">
                    <div class="flex items-center gap-3">
                        <select x-model="selectedLogJob" @change="loadLogs()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="daemon">ü¶û Daemon</option>
                            <template x-for="job in jobs" :key="job.id">
                                <option :value="job.id" x-text="job.id"></option>
                            </template>
                        </select>
                        <select x-model="logType" @change="loadLogs()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="stdout">stdout</option>
                            <option value="stderr">stderr</option>
                        </select>
                        <input type="number" x-model="logLines" @change="loadLogs()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm w-20 focus:outline-none" placeholder="Lines">
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="text" x-model="logFilter" placeholder="Filter logs..." 
                            class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-accent-500 w-48">
                        <label class="flex items-center gap-2 text-sm text-dark-300">
                            <input type="checkbox" x-model="showTimestamps" class="rounded bg-dark-700 border-dark-600">
                            Timestamps
                        </label>
                        <label class="flex items-center gap-2 text-sm text-dark-300">
                            <input type="checkbox" x-model="autoRefreshLogs" class="rounded bg-dark-700 border-dark-600">
                            Auto
                        </label>
                        <button @click="loadLogs()" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition">üîÑ</button>
                        <button @click="downloadLogs()" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition" title="Download">üì•</button>
                    </div>
                </div>
                <div class="h-[500px] overflow-auto scrollbar-thin p-4 bg-dark-900" id="log-container">
                    <template x-for="(line, i) in filteredLogs" :key="i">
                        <div class="log-line py-0.5 hover:bg-dark-800 flex">
                            <span x-show="showTimestamps && hasTimestamp(line)" class="log-timestamp shrink-0" x-text="extractTimestamp(line)"></span>
                            <span x-show="showTimestamps && !hasTimestamp(line)" class="log-timestamp shrink-0 invisible">00:00:00</span>
                            <span :class="getLogLineClass(line)" x-text="line"></span>
                        </div>
                    </template>
                    <div x-show="filteredLogs.length === 0 && logContent.length > 0" class="text-dark-500 text-center py-8">No logs match filter</div>
                    <div x-show="logContent.length === 0" class="text-dark-500 text-center py-8">No logs available</div>
                </div>
                <div class="p-2 border-t border-dark-600 bg-dark-800 text-xs text-dark-400 flex justify-between items-center">
                    <span x-text="`Showing ${filteredLogs.length} of ${logContent.length} lines`"></span>
                    <div class="flex items-center gap-3">
                        <span x-show="logSource === 'sqlite'" class="text-yellow-400" title="Historical logs from database">üíæ SQLite</span>
                        <span x-show="logSource === 'file'" class="text-green-400" title="Live logs from file">üìÑ File</span>
                        <span x-show="logSource === 'none'" class="text-dark-500">No logs</span>
                        <span x-show="logFilter" class="text-accent-400">Filtered</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- DLQ Tab -->
        <div x-show="currentTab === 'dlq'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-lg font-medium">Dead Letter Queue</div>
                        <span class="px-2 py-1 bg-dark-700 rounded text-sm text-dark-400" x-text="dlqEntries.length + ' entries'"></span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="reinjectAllDlq()" x-show="dlqEntries.length > 0" class="px-3 py-2 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded-lg text-sm transition">Reinject All</button>
                        <button @click="purgeDlq()" x-show="dlqEntries.length > 0" class="px-3 py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg text-sm transition">Purge Old</button>
                    </div>
                </div>
            </div>
            <div class="space-y-3">
                <template x-for="entry in dlqEntries" :key="entry.id">
                    <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="font-medium text-dark-100" x-text="entry.job_id"></div>
                                <div class="text-xs text-dark-400" x-text="formatDateFull(entry.failed_at)"></div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="reinjectDlq(entry.id)" class="px-3 py-1.5 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded text-sm transition">Reinject</button>
                                <button @click="deleteDlq(entry.id)" class="px-3 py-1.5 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded text-sm transition">Delete</button>
                            </div>
                        </div>
                        <div class="bg-dark-900 rounded p-3 font-mono text-xs text-red-400" x-text="entry.error || 'No error message'"></div>
                        <div class="mt-2 text-xs text-dark-500">Attempts: <span x-text="entry.attempts"></span> | Exit code: <span x-text="entry.exit_code"></span></div>
                    </div>
                </template>
                <div x-show="dlqEntries.length === 0" class="text-center py-12 text-dark-400">
                    <div class="text-4xl mb-3">‚ú®</div>
                    <p class="text-dark-300 font-medium">Dead Letter Queue is empty</p>
                    <p class="text-sm mt-1">All jobs are running smoothly</p>
                </div>
            </div>
        </div>

        <!-- Config Tab -->
        <div x-show="currentTab === 'config'" x-cloak>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                    <h3 class="font-medium mb-4">Daemon Info</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Status</span>
                            <span class="text-green-400" x-text="health.status"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Version</span>
                            <span x-text="health.version"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Uptime</span>
                            <span x-text="formatUptime(health.uptime_seconds)"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Jobs Running</span>
                            <span x-text="health.jobs_running"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Total Jobs</span>
                            <span x-text="health.jobs_total"></span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-dark-400">API Endpoint</span>
                            <span class="text-dark-300 font-mono text-sm">localhost:9876</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-dark-700 space-y-2">
                        <button @click="reloadConfig()" class="w-full py-2 bg-accent-500/20 text-accent-400 hover:bg-accent-500/30 rounded-lg text-sm transition">üîÑ Reload Config</button>
                        <button @click="restartDaemon()" class="w-full py-2 bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 rounded-lg text-sm transition">üîÑ Restart Daemon</button>
                    </div>
                </div>
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                    <h3 class="font-medium mb-4">Job Types</h3>
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full shrink-0">continuous</span>
                            <p class="text-sm text-dark-400">Long-running jobs that should always be running. Auto-restart on crash.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded-full shrink-0">scheduled</span>
                            <p class="text-sm text-dark-400">Jobs triggered by cron schedule. Run, complete, wait for next schedule.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs rounded-full shrink-0">manual</span>
                            <p class="text-sm text-dark-400">Jobs triggered manually via API or CLI. No auto-scheduling.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-orange-500/20 text-orange-400 text-xs rounded-full shrink-0">openclaw</span>
                            <p class="text-sm text-dark-400">Jobs linked to OpenClaw. Depend on AI/cron integration, synced with OpenClaw daemon.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-pink-500/20 text-pink-400 text-xs rounded-full shrink-0">oneshot</span>
                            <p class="text-sm text-dark-400">Jobs that run once at a specific datetime. Auto-disabled after execution.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                    <h3 class="font-medium mb-4">Monitoring</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Prometheus Metrics</span>
                            <a href="/metrics" target="_blank" class="text-accent-400 hover:text-accent-300 text-sm">üìä /metrics</a>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Health Check</span>
                            <a href="/health" target="_blank" class="text-accent-400 hover:text-accent-300 text-sm">‚ù§Ô∏è /health</a>
                        </div>
                    </div>
                </div>
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                    <h3 class="font-medium mb-4">üîê API Authentication</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-dark-700">
                            <span class="text-dark-400">Status</span>
                            <span x-show="authConfig.enabled" class="text-green-400">‚óè Enabled</span>
                            <span x-show="!authConfig.enabled" class="text-yellow-400">‚óã Disabled</span>
                        </div>
                        <div x-show="authConfig.enabled" class="py-2 border-b border-dark-700">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-dark-400">Token</span>
                                <button @click="authConfig.showToken = !authConfig.showToken" class="text-xs text-accent-400 hover:text-accent-300">
                                    <span x-show="!authConfig.showToken">üëÅ Show</span>
                                    <span x-show="authConfig.showToken">üôà Hide</span>
                                </button>
                            </div>
                            <div class="font-mono text-sm bg-dark-900 p-2 rounded break-all">
                                <span x-show="!authConfig.showToken" x-text="authConfig.tokenMasked"></span>
                                <span x-show="authConfig.showToken" x-text="authConfig.token"></span>
                            </div>
                            <button @click="copyToken()" class="mt-2 text-xs text-accent-400 hover:text-accent-300">üìã Copy to clipboard</button>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Web UI</span>
                            <span class="text-green-400 text-sm">‚úì Always allowed</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-dark-400">External API</span>
                            <span x-show="authConfig.enabled" class="text-yellow-400 text-sm">üîí Requires token</span>
                            <span x-show="!authConfig.enabled" class="text-dark-400 text-sm">Open</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-dark-700 space-y-2">
                        <button x-show="!authConfig.enabled" @click="enableAuth()" class="w-full py-2 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded-lg text-sm transition">üîê Enable Authentication</button>
                        <button x-show="authConfig.enabled" @click="regenerateToken()" class="w-full py-2 bg-accent-500/20 text-accent-400 hover:bg-accent-500/30 rounded-lg text-sm transition">üîÑ Regenerate Token</button>
                        <button x-show="authConfig.enabled" @click="disableAuth()" class="w-full py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg text-sm transition">üîì Disable Authentication</button>
                    </div>
                </div>
            </div>
            
            <!-- Full YAML Editor -->
            <div class="mt-6 bg-dark-800 border border-dark-600 rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-medium">üìÑ jobs.yaml Editor</h3>
                    <div class="flex gap-2">
                        <button @click="loadFullYaml()" class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm transition">üîÑ Reload</button>
                        <button @click="saveFullYaml()" class="px-3 py-1 bg-accent-500 hover:bg-accent-600 text-white rounded text-sm transition">üíæ Save & Apply</button>
                    </div>
                </div>
                <div class="text-xs text-dark-500 mb-2" x-text="fullYamlPath || 'Loading...'"></div>
                <textarea x-model="fullYamlContent" 
                    class="w-full h-96 bg-dark-900 border border-dark-600 rounded-lg p-3 focus:outline-none focus:border-accent-500 font-mono text-sm resize-y"
                    placeholder="Loading jobs.yaml..."></textarea>
                <div class="mt-2 text-xs text-dark-500">‚ö†Ô∏è Edit with care. Invalid YAML will be rejected. A backup is created before saving.</div>
            </div>
            </div>
        </div>
    </main>

    <!-- Job Detail Modal -->
    <div x-show="selectedJob" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="selectedJob = null">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-2xl max-h-[80vh] overflow-hidden" @click.stop>
            <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-medium" x-text="selectedJob?.id"></h2>
                    <p class="text-sm text-dark-400" x-text="selectedJob?.name"></p>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="openEditModal(selectedJob)" class="p-2 hover:bg-dark-700 rounded-lg text-dark-400 hover:text-dark-200" title="Edit">‚úèÔ∏è</button>
                    <button @click="selectedJob = null" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                </div>
            </div>
            <div class="p-4 overflow-auto max-h-[60vh] scrollbar-thin">
                <template x-if="selectedJob">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Status</div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" :class="selectedJob.status === 'running' ? 'bg-green-500' : selectedJob.status === 'failed' ? 'bg-red-500' : selectedJob.status === 'planned' ? 'bg-cyan-500' : selectedJob.status === 'paused' ? 'bg-yellow-500' : selectedJob.status === 'queued' ? 'bg-indigo-500' : 'bg-dark-500'"></span>
                                    <span x-text="selectedJob.status"></span>
                                    <span x-show="selectedJob.status === 'queued' && selectedJob.queue_status" class="text-indigo-300 text-xs" x-text="'(#' + (selectedJob.queue_status?.position + 1) + ' in ' + selectedJob.queue + ')'"></span>
                                </div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Type</div>
                                <span class="text-xs px-2 py-1 rounded-full" :class="getTypeClass(selectedJob.type)" x-text="selectedJob.type"></span>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">PID</div>
                                <div x-text="selectedJob.pid || '-'"></div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Restarts</div>
                                <div x-text="selectedJob.restart_count || 0"></div>
                            </div>
                        </div>

                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-2">Tags</div>
                            <div class="flex flex-wrap gap-2 items-center">
                                <template x-for="tag in (selectedJob.tags || [])" :key="tag">
                                    <span class="tag-badge text-dark-300">
                                        <span x-text="tag"></span>
                                        <span class="tag-remove text-dark-500 hover:text-red-400" @click="removeTag(selectedJob.id, tag); selectedJob.tags = selectedJob.tags.filter(t => t !== tag)">√ó</span>
                                    </span>
                                </template>
                                <button class="tag-add-btn text-dark-400 hover:text-dark-200" @click="openTagInput(selectedJob.id)">+ Add tag</button>
                            </div>
                        </div>

                        <div x-show="getWorkflowsForJob(selectedJob.id).length > 0" class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3">
                            <div class="text-xs text-purple-400 mb-2">‚õìÔ∏è Part of Workflows</div>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="wf in getWorkflowsForJob(selectedJob.id)" :key="wf.id">
                                    <span class="text-xs px-2 py-1 bg-purple-500/20 text-purple-300 rounded cursor-pointer hover:bg-purple-500/30"
                                        :title="wf.type + ': ' + wf.jobs.join(' ‚Üí ')"
                                        @click="currentTab = 'workflows'"
                                        x-text="wf.name + ' (' + wf.type + ')'">
                                    </span>
                                </template>
                            </div>
                        </div>

                        <div x-show="selectedJob.depends_on?.length > 0 || selectedJob.dependents?.length > 0" class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-2">Dependencies</div>
                            <div class="space-y-2">
                                <div x-show="selectedJob.depends_on?.length > 0">
                                    <span class="text-xs text-blue-400">Depends on:</span>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                        <template x-for="dep in selectedJob.depends_on" :key="dep.job">
                                            <span class="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 rounded cursor-pointer hover:bg-blue-500/30" @click="selectJobById(dep.job)" x-text="dep.job + ' (' + dep.condition + ')'"></span>
                                        </template>
                                    </div>
                                </div>
                                <div x-show="selectedJob.dependents?.length > 0">
                                    <span class="text-xs text-green-400">Dependents:</span>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                        <template x-for="dep in selectedJob.dependents" :key="dep.job">
                                            <span class="text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded cursor-pointer hover:bg-green-500/30" @click="selectJobById(dep.job)" x-text="dep.job"></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Created</div>
                                <div x-text="selectedJob.created_at ? formatDateFull(selectedJob.created_at) : '-'"></div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Modified</div>
                                <div x-text="selectedJob.updated_at ? formatDateFull(selectedJob.updated_at) : '-'"></div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Started At</div>
                                <div x-text="selectedJob.started_at ? formatDateFull(selectedJob.started_at) : '-'"></div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Next Run</div>
                                <div x-text="selectedJob.next_run ? formatDateFull(selectedJob.next_run) : '-'"></div>
                            </div>
                        </div>

                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Command</div>
                            <div class="font-mono text-sm text-dark-200 break-all" x-text="selectedJob.cmd || '-'"></div>
                        </div>

                        <div x-show="selectedJob.cwd" class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Working Directory</div>
                            <div class="font-mono text-sm text-dark-200 break-all" x-text="selectedJob.cwd"></div>
                        </div>

                        <div x-show="selectedJob.schedule" class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Schedule</div>
                            <div class="font-mono text-sm text-dark-200" x-text="selectedJob.schedule"></div>
                        </div>

                        <div x-show="selectedJob.run_at" class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Run At (One-shot)</div>
                            <div class="font-mono text-sm text-dark-200" x-text="formatDateFull(selectedJob.run_at)"></div>
                        </div>

                        <div class="flex flex-wrap gap-2 pt-4 border-t border-dark-700">
                            <button @click="startJob(selectedJob.id)" x-show="selectedJob.status !== 'running' && selectedJob.status !== 'queued'"
                                class="flex-1 min-w-[80px] py-2 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded-lg transition">‚ñ∂Ô∏è Start</button>
                            <button @click="forceStartJob(selectedJob.id)" x-show="selectedJob.status === 'queued'"
                                class="flex-1 min-w-[80px] py-2 bg-orange-500/20 text-orange-400 hover:bg-orange-500/30 rounded-lg transition" title="Bypass queue and start immediately">‚ö° Force Start</button>
                            <button @click="stopJob(selectedJob.id)" x-show="selectedJob.status === 'running'"
                                class="flex-1 min-w-[80px] py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg transition">‚èπÔ∏è Stop</button>
                            <button @click="forceRunJob(selectedJob.id)" x-show="(selectedJob.schedule || selectedJob.run_at) && selectedJob.status !== 'running'"
                                class="flex-1 min-w-[80px] py-2 bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 rounded-lg transition" title="Force immediate execution">‚ö° Run Now</button>
                            <button @click="restartJob(selectedJob.id)"
                                class="flex-1 min-w-[80px] py-2 bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 rounded-lg transition">üîÑ Restart</button>
                            <button @click="viewLogs(selectedJob.id); selectedJob = null"
                                class="flex-1 min-w-[80px] py-2 bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 rounded-lg transition">üìú Logs</button>
                            <button @click="deleteJob(selectedJob.id)"
                                class="flex-1 min-w-[80px] py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg transition">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div x-show="showEditModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEditModal = false">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-2xl max-h-[85vh] overflow-hidden" @click.stop>
            <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                <h2 class="text-lg font-medium">Edit Job: <span x-text="editJob.id"></span></h2>
                <div class="flex items-center gap-2">
                    <div class="flex bg-dark-700 rounded-lg p-1">
                        <button type="button" @click="editMode = 'form'" 
                            :class="editMode === 'form' ? 'bg-dark-600 text-white' : 'text-dark-400 hover:text-white'"
                            class="px-3 py-1 rounded text-sm transition">üìù Form</button>
                        <button type="button" @click="editMode = 'yaml'; syncEditFormToYaml()" 
                            :class="editMode === 'yaml' ? 'bg-dark-600 text-white' : 'text-dark-400 hover:text-white'"
                            class="px-3 py-1 rounded text-sm transition">üìÑ YAML</button>
                    </div>
                    <button @click="showEditModal = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                </div>
            </div>
            
            <!-- Form View -->
            <div x-show="editMode === 'form'" class="overflow-auto max-h-[65vh]">
                <form @submit.prevent="saveJob()" class="p-4 space-y-4">
                    <div>
                        <label class="block text-sm text-dark-400 mb-1">Name</label>
                        <input type="text" x-model="editJob.name" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncEditFormToYaml()">
                    </div>
                    <div>
                        <label class="block text-sm text-dark-400 mb-1">Description</label>
                        <input type="text" x-model="editJob.description" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncEditFormToYaml()">
                    </div>
                    <div>
                        <label class="block text-sm text-dark-400 mb-1">Command</label>
                        <input type="text" x-model="editJob.cmd" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncEditFormToYaml()">
                    </div>
                    <div>
                        <label class="block text-sm text-dark-400 mb-1">Working Directory</label>
                        <input type="text" x-model="editJob.cwd" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncEditFormToYaml()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-dark-400 mb-1">Type</label>
                            <select x-model="editJob.type" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none" @change="syncEditFormToYaml()">
                                <option value="manual">Manual</option>
                                <option value="continuous">Continuous</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="oneshot">One-shot</option>
                                <option value="openclaw">OpenClaw</option>
                            </select>
                        </div>
                        <div x-show="editJob.type === 'scheduled' || editJob.type === 'openclaw'" class="col-span-2">
                            <label class="block text-sm text-dark-400 mb-1">Schedule</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <select x-model="editJob.cronPreset" @change="updateCronFromPreset()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none text-sm">
                                    <option value="custom">Custom cron</option>
                                    <option value="every_min">Every X minutes</option>
                                    <option value="every_hour">Every X hours</option>
                                    <option value="daily">Daily at time</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                                <!-- Every X minutes -->
                                <input x-show="editJob.cronPreset === 'every_min'" type="number" x-model="editJob.cronMinutes" min="1" max="59" 
                                    class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none text-sm" placeholder="Minutes" @input="updateCronFromPreset()">
                                <!-- Every X hours -->
                                <input x-show="editJob.cronPreset === 'every_hour'" type="number" x-model="editJob.cronHours" min="1" max="23" 
                                    class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none text-sm" placeholder="Hours" @input="updateCronFromPreset()">
                                <!-- Daily/Weekly/Monthly time -->
                                <input x-show="['daily', 'weekly', 'monthly'].includes(editJob.cronPreset)" type="time" x-model="editJob.cronTime" 
                                    class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none text-sm" @input="updateCronFromPreset()">
                            </div>
                            <!-- Weekly day selector -->
                            <div x-show="editJob.cronPreset === 'weekly'" class="flex gap-1 mb-2">
                                <template x-for="(day, idx) in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']" :key="idx">
                                    <button type="button" @click="toggleCronDay(idx)" 
                                        :class="editJob.cronDays?.includes(idx) ? 'bg-accent-500 text-white' : 'bg-dark-700 text-dark-400'"
                                        class="px-2 py-1 rounded text-xs hover:bg-dark-600 transition" x-text="day"></button>
                                </template>
                            </div>
                            <!-- Monthly day selector -->
                            <div x-show="editJob.cronPreset === 'monthly'" class="mb-2">
                                <select x-model="editJob.cronDayOfMonth" @change="updateCronFromPreset()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none text-sm">
                                    <template x-for="d in 31" :key="d">
                                        <option :value="d" x-text="'Day ' + d"></option>
                                    </template>
                                </select>
                            </div>
                            <!-- Cron expression (always visible) -->
                            <div class="flex items-center gap-2">
                                <input type="text" x-model="editJob.schedule" class="flex-1 bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500 font-mono text-sm" placeholder="0 * * * *" @input="editJob.cronPreset = 'custom'; syncEditFormToYaml()">
                                <span class="text-xs text-dark-400" x-text="cronToHuman(editJob.schedule)"></span>
                            </div>
                        </div>
                        <div x-show="editJob.type === 'oneshot'">
                            <label class="block text-sm text-dark-400 mb-1">Run At</label>
                            <input type="datetime-local" x-model="editJob.run_at" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncEditFormToYaml()">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-dark-400 mb-1">Tags (comma-separated)</label>
                        <input type="text" x-model="editJob.tagsStr" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncEditFormToYaml()">
                    </div>
                    <div>
                        <label class="block text-sm text-dark-400 mb-1">Execution Queue <span class="text-dark-500">(jobs in same queue run sequentially)</span></label>
                        <div class="flex gap-2">
                            <input type="text" x-model="editJob.queue" list="queueList" class="flex-1 bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="e.g. openclaw" @input="syncEditFormToYaml()">
                            <datalist id="queueList">
                                <template x-for="q in allQueues" :key="q">
                                    <option :value="q"></option>
                                </template>
                            </datalist>
                            <button type="button" @click="editJob.queue = ''; syncEditFormToYaml()" class="px-3 py-2 bg-dark-600 hover:bg-dark-500 rounded-lg text-dark-400 text-sm" title="Clear queue">‚úï</button>
                        </div>
                    </div>
                    
                    <!-- Self-Healing Settings -->
                    <details class="bg-dark-700 rounded-lg">
                        <summary class="p-3 cursor-pointer text-sm text-dark-300 hover:text-white flex items-center gap-2">
                            üîß Self-Healing Settings
                            <span x-show="editJob.self_healing?.enabled" class="text-xs px-2 py-0.5 bg-green-500/20 text-green-400 rounded">Enabled</span>
                        </summary>
                        <div class="p-4 pt-0 space-y-4">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="edit-healing-enabled" x-model="editJob.self_healing.enabled" class="rounded" @change="syncEditFormToYaml()">
                                <label for="edit-healing-enabled" class="text-sm">Enable Self-Healing</label>
                            </div>
                            
                            <div x-show="editJob.self_healing?.enabled" class="space-y-4">
                                <!-- Preset -->
                                <div>
                                    <label class="block text-sm text-dark-400 mb-1">Preset</label>
                                    <select x-model="editJob.self_healing.preset" @change="applyHealingPreset()" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-3 py-2 text-sm">
                                        <option value="conservative">Conservative (restart only)</option>
                                        <option value="moderate">Moderate (restart + edit script)</option>
                                        <option value="aggressive">Aggressive (all actions)</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                
                                <!-- Max Attempts -->
                                <div>
                                    <label class="block text-sm text-dark-400 mb-1">Max Attempts</label>
                                    <input type="number" x-model.number="editJob.self_healing.remediation.max_attempts" min="1" max="10" class="w-full bg-dark-800 border border-dark-600 rounded-lg px-3 py-2 text-sm" @input="editJob.self_healing.preset = 'custom'; syncEditFormToYaml()">
                                </div>
                                
                                <!-- Allowed Actions -->
                                <div>
                                    <label class="block text-sm text-dark-400 mb-2">Allowed Actions</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" :checked="editJob.self_healing?.remediation?.allowed_actions?.includes('restart_job')" 
                                                @change="toggleHealingAction('restart_job')" class="rounded">
                                            Restart Job
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" :checked="editJob.self_healing?.remediation?.allowed_actions?.includes('edit_script')"
                                                @change="toggleHealingAction('edit_script')" class="rounded">
                                            Edit Script
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" :checked="editJob.self_healing?.remediation?.allowed_actions?.includes('edit_config')"
                                                @change="toggleHealingAction('edit_config')" class="rounded">
                                            Edit Config
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" :checked="editJob.self_healing?.remediation?.allowed_actions?.includes('run_command')"
                                                @change="toggleHealingAction('run_command')" class="rounded">
                                            Run Command
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" :checked="editJob.self_healing?.remediation?.allowed_actions?.includes('edit_openclaw_cron')"
                                                @change="toggleHealingAction('edit_openclaw_cron')" class="rounded">
                                            Edit OpenClaw Cron
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" :checked="editJob.self_healing?.remediation?.allowed_actions?.includes('restart_service')"
                                                @change="toggleHealingAction('restart_service')" class="rounded">
                                            Restart Service
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Notifications -->
                                <div>
                                    <label class="block text-sm text-dark-400 mb-2">Notifications</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" x-model="editJob.self_healing.notify.on_fix_attempt" class="rounded" @change="syncEditFormToYaml()">
                                            Notify on Fix Attempt
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" x-model="editJob.self_healing.notify.on_success" class="rounded" @change="syncEditFormToYaml()">
                                            Notify on Success
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" x-model="editJob.self_healing.notify.on_give_up" class="rounded" @change="syncEditFormToYaml()">
                                            Notify on Give Up
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <div class="flex gap-2 pt-4">
                        <button type="button" @click="showEditModal = false" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition">Cancel</button>
                        <button type="submit" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg transition">Save Changes</button>
                    </div>
                </form>
            </div>
            
            <!-- YAML View -->
            <div x-show="editMode === 'yaml'" class="p-4 flex flex-col h-[65vh]">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm text-dark-400">Edit YAML directly</label>
                    <button type="button" @click="syncEditYamlToForm()" class="text-xs text-accent-400 hover:text-accent-300">‚Ü©Ô∏è Sync to Form</button>
                </div>
                <textarea x-model="editJobYaml" 
                    class="flex-1 w-full bg-dark-900 border border-dark-600 rounded-lg p-3 font-mono text-sm focus:outline-none focus:border-accent-500 resize-none"
                    placeholder="# YAML configuration"></textarea>
                <div class="flex gap-2 pt-4">
                    <button type="button" @click="showEditModal = false" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition">Cancel</button>
                    <button type="button" @click="saveJobFromYaml()" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg transition">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Job Modal -->
    <div x-show="showCreateModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showCreateModal = false">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden" @click.stop>
            <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                <h2 class="text-lg font-medium">Create New Job</h2>
                <div class="flex items-center gap-2">
                    <div class="flex bg-dark-700 rounded-lg p-1">
                        <button type="button" @click="createMode = 'form'" 
                            :class="createMode === 'form' ? 'bg-dark-600 text-white' : 'text-dark-400 hover:text-white'"
                            class="px-3 py-1 rounded text-sm transition">üìù Form</button>
                        <button type="button" @click="createMode = 'yaml'; syncFormToYaml()" 
                            :class="createMode === 'yaml' ? 'bg-dark-600 text-white' : 'text-dark-400 hover:text-white'"
                            class="px-3 py-1 rounded text-sm transition">üìÑ YAML</button>
                    </div>
                    <button @click="showCreateModal = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                </div>
            </div>
            
            <div class="flex h-[70vh]">
                <!-- Form View -->
                <div x-show="createMode === 'form'" class="flex-1 overflow-auto p-4">
                    <form @submit.prevent="createJob()" class="space-y-4">
                        <div>
                            <label class="block text-sm text-dark-400 mb-1">Job ID *</label>
                            <input type="text" x-model="newJob.id" required class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncFormToYaml()">
                        </div>
                        <div>
                            <label class="block text-sm text-dark-400 mb-1">Name</label>
                            <input type="text" x-model="newJob.name" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncFormToYaml()">
                        </div>
                        <div>
                            <label class="block text-sm text-dark-400 mb-1">Command *</label>
                            <input type="text" x-model="newJob.cmd" required class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="python script.py" @input="syncFormToYaml()">
                        </div>
                        <div>
                            <label class="block text-sm text-dark-400 mb-1">Working Directory</label>
                            <input type="text" x-model="newJob.cwd" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="/path/to/dir" @input="syncFormToYaml()">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-dark-400 mb-1">Type</label>
                                <select x-model="newJob.type" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none" @change="syncFormToYaml()">
                                    <option value="manual">Manual</option>
                                    <option value="continuous">Continuous</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="oneshot">One-shot</option>
                                    <option value="openclaw">OpenClaw</option>
                                </select>
                            </div>
                            <div x-show="newJob.type === 'scheduled' || newJob.type === 'openclaw'">
                                <label class="block text-sm text-dark-400 mb-1">Schedule (cron)</label>
                                <input type="text" x-model="newJob.schedule" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="0 * * * *" @input="syncFormToYaml()">
                            </div>
                            <div x-show="newJob.type === 'oneshot'">
                                <label class="block text-sm text-dark-400 mb-1">Run At</label>
                                <input type="datetime-local" x-model="newJob.run_at" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" @input="syncFormToYaml()">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-dark-400 mb-1">Tags (comma-separated)</label>
                            <input type="text" x-model="newJob.tags" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="tag1, tag2" @input="syncFormToYaml()">
                        </div>
                        <div>
                            <label class="block text-sm text-dark-400 mb-1">Execution Queue <span class="text-dark-500">(jobs in same queue run sequentially)</span></label>
                            <input type="text" x-model="newJob.queue" list="newJobQueueList" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="e.g. openclaw" @input="syncFormToYaml()">
                            <datalist id="newJobQueueList">
                                <template x-for="q in allQueues" :key="q">
                                    <option :value="q"></option>
                                </template>
                            </datalist>
                        </div>
                        <div>
                            <label class="block text-sm text-dark-400 mb-1">Environment Variables</label>
                            <textarea x-model="newJob.env" rows="3" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500 font-mono text-sm" placeholder="KEY=value&#10;SECRET_TOKEN=abc123" @input="syncFormToYaml()"></textarea>
                        </div>
                        <div class="flex gap-2 pt-4">
                            <button type="button" @click="showCreateModal = false" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition">Cancel</button>
                            <button type="submit" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg transition">Create Job</button>
                        </div>
                    </form>
                </div>
                
                <!-- YAML View -->
                <div x-show="createMode === 'yaml'" class="flex-1 flex flex-col p-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm text-dark-400">Edit YAML directly</label>
                        <button type="button" @click="syncYamlToForm()" class="text-xs text-accent-400 hover:text-accent-300">‚Ü©Ô∏è Sync to Form</button>
                    </div>
                    <textarea x-model="newJobYaml" 
                        class="flex-1 w-full bg-dark-900 border border-dark-600 rounded-lg p-3 focus:outline-none focus:border-accent-500 font-mono text-sm resize-none"
                        placeholder="job-id:
  name: My Job
  cmd: python script.py
  cwd: /path/to/dir
  type: manual
  enabled: true
  tags:
    - tag1
    - tag2
  env:
    KEY: value"></textarea>
                    <div class="flex gap-2 pt-4">
                        <button type="button" @click="showCreateModal = false" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition">Cancel</button>
                        <button type="button" @click="createJobFromYaml()" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg transition">Create from YAML</button>
                    </div>
                </div>
                
                <!-- Live Preview (always visible) -->
                <div class="w-80 border-l border-dark-600 bg-dark-900 p-4 overflow-auto">
                    <div class="text-sm text-dark-400 mb-2">üìÑ YAML Preview</div>
                    <pre class="font-mono text-xs text-dark-300 whitespace-pre-wrap" x-text="newJobYaml || '# Fill the form to see preview'"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Input Modal -->
    <div x-show="showTagInput" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showTagInput = false">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-xs p-4" @click.stop>
            <div class="mb-3 text-sm text-dark-400">Add tag to: <span class="text-dark-200" x-text="tagInputJobId"></span></div>
            <form @submit.prevent="addTag()">
                <input type="text" x-model="newTagValue" x-ref="tagInput" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500 mb-3" placeholder="Tag name" autofocus>
                <div class="flex gap-2">
                    <button type="button" @click="showTagInput = false" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg text-sm transition">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Column Settings Modal -->
    <div x-show="showColumnSettings" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showColumnSettings = false">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-md p-4" @click.stop>
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium">Column Settings</h3>
                <button @click="showColumnSettings = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
            </div>
            <p class="text-sm text-dark-400 mb-4">Select columns to show and drag to reorder:</p>
            <div class="space-y-2 mb-4">
                <template x-for="col in allColumns" :key="col.id">
                    <div class="flex items-center gap-3 p-2 bg-dark-700 rounded-lg">
                        <span class="drag-handle text-dark-500">‚†ø</span>
                        <label class="flex items-center gap-2 flex-1 cursor-pointer">
                            <input type="checkbox" :checked="isColumnVisible(col.id)" @change="toggleColumn(col.id)" class="rounded bg-dark-600 border-dark-500">
                            <span x-text="col.label"></span>
                        </label>
                    </div>
                </template>
            </div>
            <div class="flex gap-2">
                <button @click="resetColumns()" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition">Reset to Default</button>
                <button @click="showColumnSettings = false" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg text-sm transition">Done</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 right-0 bg-dark-800 border-t border-dark-600 py-2 px-4 text-xs text-dark-400 flex justify-between items-center">
        <div class="flex gap-4">
            <span><kbd>r</kbd> Refresh</span>
            <span><kbd>1-5</kbd> Tabs</span>
            <span><kbd>/</kbd> Search</span>
            <span><kbd>Esc</kbd> Close</span>
        </div>
        <div class="flex items-center gap-3">
            <span>ü¶û ProcClaw</span>
            <span x-text="'v' + version"></span>
        </div>
    </footer>

    <!-- Toast Notifications -->
    <div class="fixed bottom-12 right-4 space-y-2 z-50">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in"
                :class="toast.type === 'success' ? 'bg-green-500/90' : toast.type === 'error' ? 'bg-red-500/90' : 'bg-dark-700'"
                x-show="toast.visible">
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>

    <script>
        function app() {
            // Default columns configuration
            const defaultColumns = [
                { id: 'id', label: 'Job', visible: true, sortKey: 'id' },
                { id: 'type', label: 'Type', visible: true, sortKey: 'type' },
                { id: 'status', label: 'Status', visible: true, sortKey: 'status' },
                { id: 'queue', label: 'Queue', visible: true, sortKey: 'queue' },
                { id: 'last_run', label: 'Last Run', visible: true, sortKey: 'started_at' },
                { id: 'next_run', label: 'Next Run', visible: true, sortKey: 'next_run' },
                { id: 'tags', label: 'Tags', visible: true, sortable: false },
                { id: 'workflows', label: 'Workflows', visible: true, sortable: false },
                { id: 'deps', label: 'Deps', visible: true, sortable: false },
                { id: 'schedule', label: 'Schedule', visible: false, sortKey: 'schedule' },
                { id: 'restarts', label: 'Restarts', visible: false, sortKey: 'restart_count' },
                { id: 'created', label: 'Created', visible: false, sortKey: 'created_at' },
                { id: 'modified', label: 'Modified', visible: false, sortKey: 'updated_at' },
            ];

            // Load saved columns from localStorage
            const savedColumns = localStorage.getItem('procclaw_columns');
            const columns = savedColumns ? JSON.parse(savedColumns) : defaultColumns;

            return {
                // State
                currentTab: 'jobs',
                viewMode: 'table',
                loading: false,
                version: '0.1.0',
                lastUpdate: null,
                health: { status: 'unknown', version: '', uptime_seconds: 0, jobs_running: 0, jobs_total: 0 },
                jobs: [],
                stats: { total: 0, running: 0, failed: 0 },
                dlqStats: { pending: 0, total: 0 },
                dlqEntries: [],
                runs: [],
                runsFilter: { job_id: '', status: 'completed', trigger: '', hasSession: '' },
                runsPage: 1,
                runsPerPage: 10,
                selectedRuns: [],
                selectedRun: null,
                showRunLogs: false,
                runLogContent: [],
                showSessionModal: false,
                sessionRun: null,
                sessionMessages: [],
                sessionSearch: '',
                showHealingModal: false,
                healingRun: null,
                healingDetails: null,
                healingQueue: null,
                runLogRun: null,
                logContent: [],
                logSource: 'file',
                logLoadedAt: null,
                selectedJob: null,
                showCreateModal: false,
                showEditModal: false,
                showTagInput: false,
                showColumnSettings: false,
                showTimestamps: true,
                tagInputJobId: '',
                newTagValue: '',
                toasts: [],
                
                // Columns
                allColumns: columns,
                
                // Filters & Sort
                filters: { search: '', type: '', status: '', tag: '', queue: '' },
                sortBy: 'next_run',
                sortDir: 'asc',
                selectedLogJob: 'daemon',
                logType: 'stdout',
                logLines: 100,
                logFilter: '',
                autoRefreshLogs: false,
                
                // Auth config
                authConfig: { enabled: false, token: '', tokenMasked: '', showToken: false },
                
                // Forms
                newJob: { id: '', name: '', cmd: '', cwd: '', type: 'manual', schedule: '', run_at: '', tags: '', env: '', queue: '' },
                newJobYaml: '',
                createMode: 'form',
                fullYamlContent: '',
                fullYamlPath: '',
                editJob: { id: '', name: '', description: '', cmd: '', cwd: '', type: '', schedule: '', run_at: '', tagsStr: '', queue: '', cronPreset: 'custom', cronMinutes: 5, cronHours: 1, cronTime: '09:00', cronDays: [1], cronDayOfMonth: 1 },
                editJobYaml: '',
                editMode: 'form',
                
                // Workflows
                savedWorkflows: [],
                workflowRuns: [],
                showWorkflowModal: false,
                showWorkflowRunModal: false,
                editingWorkflow: null,
                selectedWorkflowRun: null,
                workflowForm: { name: '', type: 'chain', jobs: ['', ''], callback: '' },
                quickWorkflow: { type: 'chain', jobs: [], callback: '' },
                
                // Computed
                get visibleColumns() {
                    return this.allColumns.filter(c => c.visible);
                },

                get filteredJobs() {
                    let result = this.jobs.filter(job => {
                        if (this.filters.search && !job.id.toLowerCase().includes(this.filters.search.toLowerCase()) && 
                            !job.name?.toLowerCase().includes(this.filters.search.toLowerCase())) return false;
                        if (this.filters.type && job.type !== this.filters.type) return false;
                        if (this.filters.status && job.status !== this.filters.status) return false;
                        if (this.filters.tag && !(job.tags || []).includes(this.filters.tag)) return false;
                        // Queue filter
                        if (this.filters.queue) {
                            if (this.filters.queue === '__none__') {
                                if (job.queue) return false;
                            } else {
                                if (job.queue !== this.filters.queue) return false;
                            }
                        }
                        return true;
                    });
                    
                    // Sort
                    if (this.sortBy) {
                        const dateFields = ['started_at', 'next_run', 'created_at', 'updated_at'];
                        result = result.sort((a, b) => {
                            let aVal = a[this.sortBy];
                            let bVal = b[this.sortBy];
                            
                            // Handle dates
                            if (dateFields.includes(this.sortBy)) {
                                aVal = aVal ? new Date(aVal).getTime() : (this.sortDir === 'asc' ? Infinity : 0);
                                bVal = bVal ? new Date(bVal).getTime() : (this.sortDir === 'asc' ? Infinity : 0);
                            } else {
                                // Handle nulls for non-dates
                                if (aVal == null) aVal = '';
                                if (bVal == null) bVal = '';
                            }
                            
                            // Compare
                            if (aVal < bVal) return this.sortDir === 'asc' ? -1 : 1;
                            if (aVal > bVal) return this.sortDir === 'asc' ? 1 : -1;
                            return 0;
                        });
                    }
                    
                    return result;
                },
                
                get allTags() {
                    const tags = new Set();
                    this.jobs.forEach(job => (job.tags || []).forEach(tag => tags.add(tag)));
                    return Array.from(tags).sort();
                },

                get allQueues() {
                    const queues = new Set();
                    this.jobs.forEach(job => { if (job.queue) queues.add(job.queue); });
                    return Array.from(queues).sort();
                },

                get filteredLogs() {
                    if (!this.logFilter) return this.logContent;
                    const filter = this.logFilter.toLowerCase();
                    return this.logContent.filter(line => line.toLowerCase().includes(filter));
                },

                get dependencyChains() {
                    const chains = [];
                    const visited = new Set();
                    const roots = this.jobs.filter(j => 
                        (!j.depends_on || j.depends_on.length === 0) && 
                        (j.dependents && j.dependents.length > 0)
                    );
                    for (const root of roots) {
                        if (visited.has(root.id)) continue;
                        const chain = this.buildChain(root.id, visited);
                        if (chain.length > 1) {
                            chains.push({ root: root.id, nodes: chain });
                        }
                    }
                    return chains;
                },

                get independentJobs() {
                    return this.jobs.filter(j => 
                        (!j.depends_on || j.depends_on.length === 0) && 
                        (!j.dependents || j.dependents.length === 0)
                    );
                },

                // Init
                async init() {
                    await this.refresh();
                    setInterval(() => this.refresh(), 10000);
                    setInterval(() => {
                        if (this.autoRefreshLogs && this.currentTab === 'logs') this.loadLogs();
                    }, 5000);
                    
                    document.addEventListener('keydown', (e) => {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
                        if (e.key === 'r' && !e.metaKey && !e.ctrlKey) { this.refresh(); e.preventDefault(); }
                        if (e.key === '1') { this.currentTab = 'jobs'; e.preventDefault(); }
                        if (e.key === '2') { this.currentTab = 'dependencies'; e.preventDefault(); }
                        if (e.key === '3') { this.currentTab = 'logs'; e.preventDefault(); }
                        if (e.key === '4') { this.currentTab = 'dlq'; e.preventDefault(); }
                        if (e.key === '5') { this.currentTab = 'config'; e.preventDefault(); }
                        if (e.key === 'Escape') { this.selectedJob = null; this.showCreateModal = false; this.showEditModal = false; this.showTagInput = false; this.showColumnSettings = false; }
                        if (e.key === '/' && this.currentTab === 'jobs') { 
                            document.querySelector('input[placeholder="Search jobs..."]')?.focus(); 
                            e.preventDefault(); 
                        }
                    });
                },

                // Column management
                isColumnVisible(id) {
                    const col = this.allColumns.find(c => c.id === id);
                    return col ? col.visible : false;
                },

                toggleColumn(id) {
                    const col = this.allColumns.find(c => c.id === id);
                    if (col) {
                        col.visible = !col.visible;
                        this.saveColumns();
                    }
                },

                saveColumns() {
                    localStorage.setItem('procclaw_columns', JSON.stringify(this.allColumns));
                },

                resetColumns() {
                    this.allColumns = JSON.parse(JSON.stringify(defaultColumns));
                    this.saveColumns();
                },

                getTypeClass(type) {
                    switch (type) {
                        case 'continuous': return 'bg-green-500/20 text-green-400';
                        case 'scheduled': return 'bg-blue-500/20 text-blue-400';
                        case 'oneshot': return 'bg-pink-500/20 text-pink-400';
                        case 'manual': return 'bg-purple-500/20 text-purple-400';
                        case 'openclaw': return 'bg-orange-500/20 text-orange-400';
                        default: return 'bg-dark-600 text-dark-300';
                    }
                },

                buildChain(jobId, visited) {
                    const chain = [];
                    let current = this.jobs.find(j => j.id === jobId);
                    while (current && !visited.has(current.id)) {
                        visited.add(current.id);
                        chain.push({ id: current.id, type: current.type, name: current.name });
                        if (current.dependents && current.dependents.length > 0) {
                            current = this.jobs.find(j => j.id === current.dependents[0].job);
                        } else {
                            break;
                        }
                    }
                    return chain;
                },

                getJobStatus(jobId) {
                    const job = this.jobs.find(j => j.id === jobId);
                    return job?.status || 'unknown';
                },

                getWorkflowsForJob(jobId) {
                    // Return saved workflows that include this job
                    return this.savedWorkflows.filter(wf => wf.jobs.includes(jobId));
                },

                selectJobById(jobId) {
                    const job = this.jobs.find(j => j.id === jobId);
                    if (job) this.selectedJob = job;
                },

                // Log timestamps - only show real timestamps from log content
                hasTimestamp(line) {
                    // Match patterns like [2026-02-09T10:16:16] or [10:16:16]
                    return /^\[[\d\-T:\.]+\]/.test(line) || /^\[\d{4}-\d{2}-\d{2}/.test(line);
                },
                
                extractTimestamp(line) {
                    // Extract timestamp from line like [2026-02-09T10:16:16.123456] or [10:16:16]
                    const match = line.match(/^\[([\d\-T:\.]+)\]/);
                    if (match) {
                        const ts = match[1];
                        // If it's a full ISO timestamp, extract just the time part
                        if (ts.includes('T')) {
                            const timePart = ts.split('T')[1];
                            return timePart.substring(0, 12); // HH:MM:SS.mmm
                        }
                        return ts;
                    }
                    return '';
                },
                
                getLogTimestamp(index) {
                    // Fallback for old behavior if needed
                    return '';
                },

                getLogLineClass(line) {
                    if (line.includes('ERROR') || line.includes('FAIL') || line.includes('Traceback')) return 'text-red-400';
                    if (line.includes('WARN') || line.includes('WARNING')) return 'text-yellow-400';
                    if (line.includes('‚úÖ') || line.includes('SUCCESS')) return 'text-green-400';
                    if (line.includes('üöÄ') || line.includes('Starting')) return 'text-blue-400';
                    return 'text-dark-300';
                },

                // API
                async api(endpoint, method = 'GET', body = null) {
                    const opts = { 
                        method, 
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-Requested-From': 'web-ui'
                        } 
                    };
                    if (body) opts.body = JSON.stringify(body);
                    const res = await fetch(`/api/v1${endpoint}`, opts);
                    const data = await res.json();
                    // Normalize error responses (FastAPI uses 'detail', we use 'message')
                    if (!res.ok && data.detail && !data.message) {
                        data.message = data.detail;
                        data.success = false;
                    }
                    return data;
                },

                async refresh() {
                    this.loading = true;
                    try {
                        const [healthRes, jobsRes, dlqRes] = await Promise.all([
                            fetch('/health').then(r => r.json()),
                            this.api('/jobs'),
                            this.api('/dlq/stats').catch(() => ({ pending: 0, total: 0 }))
                        ]);
                        
                        this.health = healthRes;
                        this.version = healthRes.version;
                        this.jobs = jobsRes.jobs || [];
                        this.dlqStats = dlqRes;
                        
                        this.stats = {
                            total: this.jobs.length,
                            running: this.jobs.filter(j => j.status === 'running').length,
                            failed: this.jobs.filter(j => j.status === 'failed').length,
                        };
                        
                        if (this.currentTab === 'dlq') await this.loadDlq();
                        if (this.currentTab === 'config') await this.loadAuthConfig();
                        this.lastUpdate = new Date();
                    } catch (e) {
                        console.error('Refresh failed:', e);
                        this.health.status = 'offline';
                    }
                    this.loading = false;
                },

                // Sorting
                toggleSort(colId) {
                    const col = this.allColumns.find(c => c.id === colId);
                    if (!col || col.sortable === false) return;
                    const sortKey = col.sortKey || colId;
                    
                    if (this.sortBy === sortKey) {
                        this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortBy = sortKey;
                        this.sortDir = 'asc';
                    }
                },
                
                getSortKey(colId) {
                    const col = this.allColumns.find(c => c.id === colId);
                    return col?.sortKey || colId;
                },
                
                isSortedBy(colId) {
                    const col = this.allColumns.find(c => c.id === colId);
                    const sortKey = col?.sortKey || colId;
                    return this.sortBy === sortKey;
                },

                // Jobs
                async startJob(id) {
                    const res = await this.api(`/jobs/${id}/start`, 'POST');
                    this.toast(res.success ? `Started ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async stopJob(id) {
                    const res = await this.api(`/jobs/${id}/stop`, 'POST');
                    this.toast(res.success ? `Stopped ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async restartJob(id) {
                    const res = await this.api(`/jobs/${id}/restart`, 'POST');
                    this.toast(res.success ? `Restarted ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async pauseJob(id) {
                    const res = await this.api(`/jobs/${id}/pause`, 'POST');
                    this.toast(res.success ? `‚è∏ Paused ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async resumeJob(id) {
                    const res = await this.api(`/jobs/${id}/resume`, 'POST');
                    this.toast(res.success ? `‚ñ∂Ô∏è Resumed ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async forceStartJob(id) {
                    const res = await this.api(`/jobs/${id}/force-start`, 'POST');
                    this.toast(res.success ? `‚ö° Force-started ${id} (queue bypassed)` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async forceRunJob(id) {
                    const res = await this.api(`/jobs/${id}/start`, 'POST');
                    this.toast(res.success ? `‚ö° Force started ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                selectJob(job) {
                    this.selectedJob = job;
                },

                openEditModal(job) {
                    // Format run_at for datetime-local input (YYYY-MM-DDTHH:mm)
                    let runAtFormatted = '';
                    if (job.run_at) {
                        const d = new Date(job.run_at);
                        runAtFormatted = d.toISOString().slice(0, 16);
                    }
                    this.editJob = {
                        id: job.id,
                        name: job.name || '',
                        description: job.description || '',
                        cmd: job.cmd || '',
                        cwd: job.cwd || '',
                        type: job.type || 'manual',
                        schedule: job.schedule || '',
                        run_at: runAtFormatted,
                        tagsStr: (job.tags || []).join(', '),
                        queue: job.queue || '',
                        cronPreset: 'custom',
                        cronMinutes: 5,
                        cronHours: 1,
                        cronTime: '09:00',
                        cronDays: [1],
                        cronDayOfMonth: 1,
                        self_healing: {
                            enabled: job.self_healing?.enabled || false,
                            preset: 'conservative',
                            analysis: {
                                include_logs: job.self_healing?.analysis?.include_logs ?? true,
                                log_lines: job.self_healing?.analysis?.log_lines ?? 200,
                                include_stderr: job.self_healing?.analysis?.include_stderr ?? true,
                                include_history: job.self_healing?.analysis?.include_history ?? 5,
                                include_config: job.self_healing?.analysis?.include_config ?? true
                            },
                            remediation: {
                                enabled: job.self_healing?.remediation?.enabled ?? true,
                                max_attempts: job.self_healing?.remediation?.max_attempts ?? 3,
                                allowed_actions: job.self_healing?.remediation?.allowed_actions || ['restart_job'],
                                forbidden_paths: job.self_healing?.remediation?.forbidden_paths || [],
                                require_approval: job.self_healing?.remediation?.require_approval ?? false
                            },
                            notify: {
                                on_analysis: job.self_healing?.notify?.on_analysis ?? false,
                                on_fix_attempt: job.self_healing?.notify?.on_fix_attempt ?? true,
                                on_success: job.self_healing?.notify?.on_success ?? true,
                                on_give_up: job.self_healing?.notify?.on_give_up ?? true,
                                session: job.self_healing?.notify?.session || 'main'
                            }
                        }
                    };
                    this.editMode = 'form';
                    this.syncEditFormToYaml();
                    this.showEditModal = true;
                },

                updateCronFromPreset() {
                    const { cronPreset, cronMinutes, cronHours, cronTime, cronDays, cronDayOfMonth } = this.editJob;
                    let cron = '';
                    
                    switch (cronPreset) {
                        case 'every_min':
                            cron = `*/${cronMinutes || 5} * * * *`;
                            break;
                        case 'every_hour':
                            cron = `0 */${cronHours || 1} * * *`;
                            break;
                        case 'daily': {
                            const [h, m] = (cronTime || '09:00').split(':');
                            cron = `${parseInt(m)} ${parseInt(h)} * * *`;
                            break;
                        }
                        case 'weekly': {
                            const [h, m] = (cronTime || '09:00').split(':');
                            const days = cronDays?.length ? cronDays.sort().join(',') : '1';
                            cron = `${parseInt(m)} ${parseInt(h)} * * ${days}`;
                            break;
                        }
                        case 'monthly': {
                            const [h, m] = (cronTime || '09:00').split(':');
                            cron = `${parseInt(m)} ${parseInt(h)} ${cronDayOfMonth || 1} * *`;
                            break;
                        }
                        default:
                            return; // custom - don't override
                    }
                    
                    this.editJob.schedule = cron;
                    this.syncEditFormToYaml();
                },

                toggleCronDay(day) {
                    if (!this.editJob.cronDays) this.editJob.cronDays = [];
                    const idx = this.editJob.cronDays.indexOf(day);
                    if (idx >= 0) {
                        this.editJob.cronDays.splice(idx, 1);
                    } else {
                        this.editJob.cronDays.push(day);
                    }
                    this.updateCronFromPreset();
                },

                applyHealingPreset() {
                    const preset = this.editJob.self_healing.preset;
                    switch (preset) {
                        case 'conservative':
                            this.editJob.self_healing.remediation.allowed_actions = ['restart_job'];
                            this.editJob.self_healing.remediation.max_attempts = 2;
                            break;
                        case 'moderate':
                            this.editJob.self_healing.remediation.allowed_actions = ['restart_job', 'edit_script', 'edit_config'];
                            this.editJob.self_healing.remediation.max_attempts = 3;
                            break;
                        case 'aggressive':
                            this.editJob.self_healing.remediation.allowed_actions = ['restart_job', 'edit_script', 'edit_config', 'run_command', 'edit_openclaw_cron', 'restart_service'];
                            this.editJob.self_healing.remediation.max_attempts = 5;
                            break;
                    }
                    this.syncEditFormToYaml();
                },

                toggleHealingAction(action) {
                    if (!this.editJob.self_healing.remediation.allowed_actions) {
                        this.editJob.self_healing.remediation.allowed_actions = [];
                    }
                    const actions = this.editJob.self_healing.remediation.allowed_actions;
                    const idx = actions.indexOf(action);
                    if (idx >= 0) {
                        actions.splice(idx, 1);
                    } else {
                        actions.push(action);
                    }
                    this.editJob.self_healing.preset = 'custom';
                    this.syncEditFormToYaml();
                },

                async saveJob() {
                    const updates = {
                        name: this.editJob.name,
                        description: this.editJob.description,
                        cmd: this.editJob.cmd,
                        cwd: this.editJob.cwd || null,
                        type: this.editJob.type,
                        schedule: (this.editJob.type === 'scheduled' || this.editJob.type === 'openclaw') ? (this.editJob.schedule || null) : null,
                        run_at: this.editJob.type === 'oneshot' ? (this.editJob.run_at || null) : null,
                        tags: this.editJob.tagsStr.split(',').map(t => t.trim()).filter(t => t),
                        queue: this.editJob.queue || null,
                        self_healing: this.editJob.self_healing.enabled ? {
                            enabled: true,
                            analysis: this.editJob.self_healing.analysis,
                            remediation: this.editJob.self_healing.remediation,
                            notify: this.editJob.self_healing.notify
                        } : { enabled: false }
                    };
                    
                    const res = await this.api(`/jobs/${this.editJob.id}`, 'PATCH', updates);
                    this.toast(res.success ? `Updated ${this.editJob.id}` : `Failed: ${res.error}`, res.success ? 'success' : 'error');
                    this.showEditModal = false;
                    await this.refresh();
                },

                async createJob() {
                    if (!this.newJob.id || !this.newJob.cmd) {
                        this.toast('Job ID and Command are required', 'error');
                        return;
                    }
                    
                    const jobData = {
                        id: this.newJob.id,
                        name: this.newJob.name || this.newJob.id,
                        cmd: this.newJob.cmd,
                        cwd: this.newJob.cwd || null,
                        type: this.newJob.type,
                        schedule: (this.newJob.type === 'scheduled' || this.newJob.type === 'openclaw') ? this.newJob.schedule : null,
                        run_at: this.newJob.type === 'oneshot' ? this.newJob.run_at : null,
                        tags: this.newJob.tags,
                        env: this.newJob.env || null,
                        queue: this.newJob.queue || null,
                        enabled: true,
                    };
                    
                    try {
                        const res = await this.api('/jobs', 'POST', jobData);
                        if (res.success) {
                            this.toast(`Job '${this.newJob.id}' created!`, 'success');
                            this.showCreateModal = false;
                            this.newJob = { id: '', name: '', cmd: '', cwd: '', type: 'manual', schedule: '', run_at: '', tags: '', env: '', queue: '' };
                            this.newJobYaml = '';
                            this.createMode = 'form';
                            await this.refresh();
                        } else {
                            this.toast(res.detail || res.message || 'Failed to create job', 'error');
                        }
                    } catch (e) {
                        this.toast(`Error: ${e.message}`, 'error');
                    }
                },

                // YAML sync helpers
                syncFormToYaml() {
                    const job = this.newJob;
                    let yaml = '';
                    if (job.id) {
                        yaml += `${job.id}:\n`;
                        if (job.name) yaml += `  name: "${job.name}"\n`;
                        if (job.cmd) yaml += `  cmd: ${job.cmd.includes(' ') ? '"' + job.cmd + '"' : job.cmd}\n`;
                        if (job.cwd) yaml += `  cwd: ${job.cwd}\n`;
                        yaml += `  type: ${job.type}\n`;
                        yaml += `  enabled: true\n`;
                        if ((job.type === 'scheduled' || job.type === 'openclaw') && job.schedule) yaml += `  schedule: "${job.schedule}"\n`;
                        if (job.type === 'oneshot' && job.run_at) yaml += `  run_at: "${job.run_at}"\n`;
                        if (job.tags) {
                            yaml += `  tags:\n`;
                            job.tags.split(',').forEach(t => {
                                if (t.trim()) yaml += `    - ${t.trim()}\n`;
                            });
                        }
                        if (job.env) {
                            yaml += `  env:\n`;
                            job.env.split('\n').forEach(line => {
                                const [k, ...v] = line.split('=');
                                if (k && v.length) yaml += `    ${k.trim()}: ${v.join('=').trim()}\n`;
                            });
                        }
                    }
                    this.newJobYaml = yaml || '# Enter job details in the form';
                },
                
                syncYamlToForm() {
                    // Simple YAML parsing for single job
                    const lines = this.newJobYaml.split('\n');
                    const job = { id: '', name: '', cmd: '', cwd: '', type: 'manual', schedule: '', run_at: '', tags: '', env: '' };
                    let inTags = false, inEnv = false;
                    let tags = [], envLines = [];
                    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (!trimmed || trimmed.startsWith('#')) continue;
                        
                        // Top-level job ID
                        if (!line.startsWith(' ') && trimmed.endsWith(':')) {
                            job.id = trimmed.slice(0, -1);
                            inTags = inEnv = false;
                            continue;
                        }
                        
                        // Array items
                        if (trimmed.startsWith('- ')) {
                            if (inTags) tags.push(trimmed.slice(2));
                            continue;
                        }
                        
                        // Key-value pairs
                        const match = trimmed.match(/^(\w+):\s*(.*)$/);
                        if (match) {
                            const [, key, val] = match;
                            const cleanVal = val.replace(/^["']|["']$/g, '');
                            inTags = key === 'tags';
                            inEnv = key === 'env';
                            if (key === 'name') job.name = cleanVal;
                            else if (key === 'cmd') job.cmd = cleanVal;
                            else if (key === 'cwd') job.cwd = cleanVal;
                            else if (key === 'type') job.type = cleanVal;
                            else if (key === 'schedule') job.schedule = cleanVal;
                            else if (key === 'run_at') job.run_at = cleanVal;
                            else if (inEnv && key !== 'env') envLines.push(`${key}=${cleanVal}`);
                        }
                    }
                    
                    job.tags = tags.join(', ');
                    job.env = envLines.join('\n');
                    this.newJob = job;
                    this.toast('Form synced from YAML', 'success');
                },
                
                async createJobFromYaml() {
                    this.syncYamlToForm();
                    await this.createJob();
                },
                
                // Edit YAML sync functions
                syncEditFormToYaml() {
                    const job = this.editJob;
                    let yaml = `${job.id}:\n`;
                    if (job.name) yaml += `  name: "${job.name}"\n`;
                    if (job.description) yaml += `  description: "${job.description}"\n`;
                    if (job.cmd) yaml += `  cmd: ${job.cmd.includes(' ') ? '"' + job.cmd + '"' : job.cmd}\n`;
                    if (job.cwd) yaml += `  cwd: ${job.cwd}\n`;
                    yaml += `  type: ${job.type}\n`;
                    if ((job.type === 'scheduled' || job.type === 'openclaw') && job.schedule) yaml += `  schedule: "${job.schedule}"\n`;
                    if (job.type === 'oneshot' && job.run_at) yaml += `  run_at: "${job.run_at}"\n`;
                    if (job.tagsStr) {
                        yaml += `  tags:\n`;
                        job.tagsStr.split(',').forEach(t => {
                            if (t.trim()) yaml += `    - ${t.trim()}\n`;
                        });
                    }
                    this.editJobYaml = yaml;
                },
                
                syncEditYamlToForm() {
                    const lines = this.editJobYaml.split('\n');
                    const job = { ...this.editJob };
                    let inTags = false;
                    let tags = [];
                    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (!trimmed || trimmed.startsWith('#')) continue;
                        
                        if (trimmed.startsWith('- ')) {
                            if (inTags) tags.push(trimmed.slice(2));
                            continue;
                        }
                        
                        const match = trimmed.match(/^(\w+):\s*(.*)$/);
                        if (match) {
                            const [, key, val] = match;
                            const cleanVal = val.replace(/^["']|["']$/g, '');
                            inTags = key === 'tags';
                            if (key === 'name') job.name = cleanVal;
                            else if (key === 'description') job.description = cleanVal;
                            else if (key === 'cmd') job.cmd = cleanVal;
                            else if (key === 'cwd') job.cwd = cleanVal;
                            else if (key === 'type') job.type = cleanVal;
                            else if (key === 'schedule') job.schedule = cleanVal;
                            else if (key === 'run_at') job.run_at = cleanVal;
                        }
                    }
                    
                    job.tagsStr = tags.join(', ');
                    this.editJob = job;
                    this.toast('Form synced from YAML', 'success');
                },
                
                async saveJobFromYaml() {
                    this.syncEditYamlToForm();
                    await this.saveJob();
                },

                async deleteJob(id) {
                    if (!confirm(`Delete job "${id}"?\n\nThis will remove it from jobs.yaml permanently.`)) return;
                    const res = await this.api(`/jobs/${id}`, 'DELETE');
                    this.toast(res.success ? `Deleted ${id}` : `Failed: ${res.error}`, res.success ? 'success' : 'error');
                    this.selectedJob = null;
                    await this.refresh();
                },

                async toggleJob(id, currentEnabled) {
                    const action = currentEnabled ? 'disable' : 'enable';
                    const res = await this.api(`/jobs/${id}/${action}`, 'POST');
                    this.toast(res.success ? `Job ${action}d` : `Failed: ${res.error}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                // Tags
                openTagInput(jobId) {
                    this.tagInputJobId = jobId;
                    this.newTagValue = '';
                    this.showTagInput = true;
                    this.$nextTick(() => this.$refs.tagInput?.focus());
                },

                async addTag() {
                    if (!this.newTagValue.trim()) return;
                    const res = await this.api(`/jobs/${this.tagInputJobId}/tags/${encodeURIComponent(this.newTagValue.trim())}`, 'POST');
                    this.toast(res.success ? `Tag added` : `Failed: ${res.error}`, res.success ? 'success' : 'error');
                    this.showTagInput = false;
                    await this.refresh();
                },

                async removeTag(jobId, tag) {
                    const res = await this.api(`/jobs/${jobId}/tags/${encodeURIComponent(tag)}`, 'DELETE');
                    if (res.success) await this.refresh();
                },

                // Logs
                async loadLogs() {
                    try {
                        const endpoint = this.selectedLogJob === 'daemon' 
                            ? `/daemon/logs?lines=${this.logLines}&type=${this.logType}`
                            : `/jobs/${this.selectedLogJob}/logs?lines=${this.logLines}&type=${this.logType}`;
                        const res = await this.api(endpoint);
                        // Reverse to show newest first
                        this.logContent = (res.lines || []).reverse();
                        this.logSource = res.source || 'file';
                        this.logLoadedAt = new Date();
                    } catch (e) {
                        this.logContent = ['Failed to load logs'];
                        this.logSource = 'error';
                    }
                },

                viewLogs(jobId) {
                    this.selectedLogJob = jobId;
                    this.currentTab = 'logs';
                    this.loadLogs();
                },

                downloadLogs() {
                    const content = this.filteredLogs.join('\n');
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedLogJob}-${this.logType}-${new Date().toISOString().slice(0,10)}.log`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.toast('Logs downloaded', 'success');
                },

                // Runs
                async loadRuns() {
                    try {
                        let endpoint = '/runs?limit=500';
                        if (this.runsFilter.job_id) endpoint += `&job_id=${this.runsFilter.job_id}`;
                        // Handle "completed" as success + failed (exclude running)
                        if (this.runsFilter.status && this.runsFilter.status !== 'completed') {
                            endpoint += `&status=${this.runsFilter.status}`;
                        }
                        if (this.runsFilter.trigger) endpoint += `&trigger=${this.runsFilter.trigger}`;
                        const res = await this.api(endpoint);
                        let runs = res.runs || [];
                        // Filter out running if "completed" is selected
                        if (this.runsFilter.status === 'completed') {
                            runs = runs.filter(r => r.status !== 'running');
                        }
                        this.runs = runs;
                        this.runsPage = 1; // Reset to first page on filter change
                        this.selectedRuns = []; // Clear selection on filter change
                        
                        // Also load healing queue
                        this.loadHealingQueue();
                    } catch (e) {
                        console.error('Failed to load runs:', e);
                        this.runs = [];
                    }
                },

                get filteredRuns() {
                    let filtered = this.runs;
                    if (this.runsFilter.hasSession === 'yes') {
                        filtered = filtered.filter(r => r.has_transcript);
                    } else if (this.runsFilter.hasSession === 'no') {
                        filtered = filtered.filter(r => !r.has_transcript);
                    }
                    return filtered;
                },

                get filteredSessionMessages() {
                    if (!this.sessionSearch.trim()) return this.sessionMessages;
                    const q = this.sessionSearch.toLowerCase();
                    return this.sessionMessages.filter(msg => {
                        // Search in string content
                        if (typeof msg.content === 'string') {
                            return msg.content.toLowerCase().includes(q);
                        }
                        // Search in array content
                        if (Array.isArray(msg.content)) {
                            return msg.content.some(part => {
                                if (part.thinking) return part.thinking.toLowerCase().includes(q);
                                if (part.text) return part.text.toLowerCase().includes(q);
                                if (part.name) return part.name.toLowerCase().includes(q);
                                if (part.arguments) return JSON.stringify(part.arguments).toLowerCase().includes(q);
                                if (part.content) {
                                    const c = typeof part.content === 'string' ? part.content : JSON.stringify(part.content);
                                    return c.toLowerCase().includes(q);
                                }
                                return false;
                            });
                        }
                        return false;
                    });
                },

                get paginatedRuns() {
                    const start = (this.runsPage - 1) * this.runsPerPage;
                    return this.filteredRuns.slice(start, start + this.runsPerPage);
                },

                get totalRunsPages() {
                    return Math.ceil(this.filteredRuns.length / this.runsPerPage);
                },

                selectRun(run) {
                    this.selectedRun = run;
                },

                async viewRunLogs(run) {
                    // Try to load logs from SQLite first
                    try {
                        const res = await this.api(`/runs/${run.id}/logs?limit=5000`);
                        if (res.lines && res.lines.length > 0) {
                            this.runLogContent = res.lines;
                            this.showRunLogs = true;
                            this.runLogRun = run;
                            return;
                        }
                    } catch (e) {
                        console.log('No SQLite logs, falling back to file logs');
                    }
                    
                    // Fallback to file-based logs
                    this.selectedLogJob = run.job_id;
                    this.currentTab = 'logs';
                    this.loadLogs();
                    this.selectedRun = null;
                },

                async viewRunSession(run) {
                    if (!run.has_transcript) {
                        alert('No AI session transcript available for this run');
                        return;
                    }
                    
                    try {
                        const res = await this.api(`/runs/${run.id}/session`);
                        this.sessionRun = run;
                        // Transform JSONL format: filter to type="message" and flatten nested structure
                        this.sessionMessages = (res.messages || [])
                            .filter(m => m.type === 'message' && m.message)
                            .map(m => ({
                                role: m.message.role,
                                content: m.message.content,
                                model: m.message.model,
                                usage: m.message.usage
                            }));
                        this.sessionSearch = '';
                        this.showSessionModal = true;
                        this.selectedRun = null;
                    } catch (e) {
                        console.error('Error loading session:', e);
                        alert('Error loading session transcript: ' + e.message);
                    }
                },

                async viewRunHealing(run) {
                    if (!run.healing) {
                        alert('No healing info available for this run');
                        return;
                    }
                    
                    try {
                        const res = await this.api(`/runs/${run.id}/healing`);
                        this.healingRun = run;
                        this.healingDetails = res;
                        this.showHealingModal = true;
                        this.selectedRun = null;
                    } catch (e) {
                        console.error('Error loading healing details:', e);
                        alert('Error loading healing details: ' + e.message);
                    }
                },

                async cancelHealing(run) {
                    if (!confirm(`Cancel healing for job '${run.job_id}'?`)) return;
                    
                    try {
                        const res = await this.api(`/jobs/${run.job_id}/healing/cancel`, 'POST');
                        this.toast(res.message, 'success');
                        await this.loadRuns();
                    } catch (e) {
                        console.error('Error cancelling healing:', e);
                        this.toast('Error cancelling healing: ' + e.message, 'error');
                    }
                },

                async deleteRun(run) {
                    if (!confirm(`Delete run #${run.id} for job '${run.job_id}'?\n\nThis will also delete all logs for this run.`)) return;
                    
                    try {
                        const res = await this.api(`/runs/${run.id}`, 'DELETE');
                        this.toast(res.message, 'success');
                        this.selectedRuns = this.selectedRuns.filter(id => id !== run.id);
                        await this.loadRuns();
                    } catch (e) {
                        console.error('Error deleting run:', e);
                        this.toast('Error deleting run: ' + e.message, 'error');
                    }
                },

                toggleRunSelection(runId) {
                    if (this.selectedRuns.includes(runId)) {
                        this.selectedRuns = this.selectedRuns.filter(id => id !== runId);
                    } else {
                        this.selectedRuns.push(runId);
                    }
                },

                toggleSelectAllRuns(event) {
                    if (event.target.checked) {
                        this.selectedRuns = this.paginatedRuns.map(r => r.id);
                    } else {
                        this.selectedRuns = [];
                    }
                },

                async bulkDeleteRuns() {
                    const count = this.selectedRuns.length;
                    if (!confirm(`Delete ${count} run(s)?\n\nThis will also delete all logs for these runs.`)) return;
                    
                    try {
                        const res = await this.api('/runs/bulk-delete', 'POST', { run_ids: this.selectedRuns });
                        this.toast(`Deleted ${res.deleted_count} runs`, 'success');
                        this.selectedRuns = [];
                        await this.loadRuns();
                    } catch (e) {
                        console.error('Error bulk deleting runs:', e);
                        this.toast('Error deleting runs: ' + e.message, 'error');
                    }
                },

                async loadHealingQueue() {
                    try {
                        this.healingQueue = await this.api('/healing/queue');
                    } catch (e) {
                        console.error('Error loading healing queue:', e);
                    }
                },

                formatDuration(seconds) {
                    if (!seconds) return '-';
                    if (seconds < 1) return `${Math.round(seconds * 1000)}ms`;
                    if (seconds < 60) return `${seconds.toFixed(1)}s`;
                    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`;
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    return `${h}h ${m}m`;
                },

                downloadRunLogs() {
                    if (!this.runLogRun || !this.runLogContent.length) return;
                    const content = this.runLogContent.join('\n');
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.runLogRun.job_id}-run-${this.runLogRun.id}.log`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.toast('Logs downloaded', 'success');
                },

                // DLQ
                async loadDlq() {
                    try {
                        const res = await this.api('/dlq');
                        this.dlqEntries = res.entries || [];
                    } catch (e) {
                        this.dlqEntries = [];
                    }
                },

                async reinjectDlq(id) {
                    const res = await this.api(`/dlq/${id}/reinject`, 'POST');
                    this.toast(res.success ? 'Reinjected' : 'Failed', res.success ? 'success' : 'error');
                    await this.loadDlq();
                },

                async deleteDlq(id) {
                    await this.api(`/dlq/${id}`, 'DELETE');
                    await this.loadDlq();
                },

                async reinjectAllDlq() {
                    for (const entry of this.dlqEntries) {
                        await this.api(`/dlq/${entry.id}/reinject`, 'POST');
                    }
                    this.toast('Reinjected all', 'success');
                    await this.loadDlq();
                },

                async purgeDlq() {
                    await this.api('/dlq?older_than_days=7', 'DELETE');
                    this.toast('Purged old entries', 'success');
                    await this.loadDlq();
                },

                // Config
                async reloadConfig() {
                    const res = await this.api('/reload', 'POST');
                    this.toast(res.success ? 'Config reloaded' : 'Failed', res.success ? 'success' : 'error');
                    await this.refresh();
                },
                
                async loadFullYaml() {
                    try {
                        const res = await this.api('/config/jobs');
                        this.fullYamlContent = res.content || '';
                        this.fullYamlPath = res.path || '';
                    } catch (e) {
                        this.toast('Failed to load YAML', 'error');
                    }
                },
                
                async saveFullYaml() {
                    if (!confirm('Save changes to jobs.yaml? A backup will be created.')) return;
                    try {
                        const res = await this.api('/config/jobs', 'PUT', { content: this.fullYamlContent });
                        if (res.success) {
                            this.toast('YAML saved and config reloaded!', 'success');
                            await this.refresh();
                        } else {
                            this.toast(res.detail || 'Failed to save', 'error');
                        }
                    } catch (e) {
                        this.toast(`Error: ${e.message}`, 'error');
                    }
                },

                async restartDaemon() {
                    if (!confirm('Restart the daemon? All running jobs will be stopped and restarted.')) return;
                    this.toast('Restarting daemon...', 'info');
                    try {
                        await fetch('/api/v1/daemon/restart', { method: 'POST' });
                        await new Promise(r => setTimeout(r, 3000));
                        await this.refresh();
                        this.toast('Daemon restarted', 'success');
                    } catch (e) {
                        this.toast('Daemon restart initiated - refresh in a few seconds', 'info');
                    }
                },

                // Auth
                async loadAuthConfig() {
                    try {
                        const res = await this.api('/config/auth');
                        this.authConfig.enabled = res.enabled;
                        this.authConfig.token = res.token;
                        this.authConfig.tokenMasked = res.tokenMasked;
                    } catch (e) {
                        console.error('Failed to load auth config:', e);
                    }
                },

                async enableAuth() {
                    if (!confirm('Enable API authentication? External API calls will require a token.')) return;
                    try {
                        const res = await this.api('/config/auth/enable', 'POST');
                        if (res.success) {
                            this.authConfig.enabled = true;
                            this.authConfig.token = res.token;
                            this.authConfig.tokenMasked = res.tokenMasked;
                            this.toast('Auth enabled! Token: ' + res.tokenMasked, 'success');
                            if (res.restartRequired) {
                                this.toast('Restart daemon to apply changes', 'info');
                            }
                        }
                    } catch (e) {
                        this.toast('Failed to enable auth', 'error');
                    }
                },

                async disableAuth() {
                    if (!confirm('Disable API authentication? External API calls will be open.')) return;
                    try {
                        const res = await this.api('/config/auth/disable', 'POST');
                        if (res.success) {
                            this.authConfig.enabled = false;
                            this.authConfig.token = '';
                            this.authConfig.tokenMasked = '';
                            this.toast('Auth disabled', 'success');
                            if (res.restartRequired) {
                                this.toast('Restart daemon to apply changes', 'info');
                            }
                        }
                    } catch (e) {
                        this.toast('Failed to disable auth', 'error');
                    }
                },

                async regenerateToken() {
                    if (!confirm('Generate a new API token? The old token will stop working after daemon restart.')) return;
                    try {
                        const res = await this.api('/config/auth/enable', 'POST');
                        if (res.success) {
                            this.authConfig.token = res.token;
                            this.authConfig.tokenMasked = res.tokenMasked;
                            this.toast('New token generated!', 'success');
                            if (res.restartRequired) {
                                this.toast('Restart daemon to apply changes', 'info');
                            }
                        }
                    } catch (e) {
                        this.toast('Failed to regenerate token', 'error');
                    }
                },

                copyToken() {
                    if (this.authConfig.token) {
                        navigator.clipboard.writeText(this.authConfig.token);
                        this.toast('Token copied to clipboard', 'success');
                    }
                },

                // Workflows
                async loadWorkflows() {
                    // Load saved workflows from localStorage
                    const saved = localStorage.getItem('procclaw_workflows');
                    this.savedWorkflows = saved ? JSON.parse(saved) : [];
                    
                    // Load recent workflow runs from API
                    try {
                        const res = await fetch('/api/v1/composite');
                        if (res.ok) {
                            const data = await res.json();
                            this.workflowRuns = data.runs || [];
                        }
                    } catch (e) {
                        console.error('Failed to load workflow runs:', e);
                    }
                },
                
                openNewWorkflowModal() {
                    this.editingWorkflow = null;
                    this.workflowForm = { name: '', type: 'chain', jobs: ['', ''], callback: '' };
                    this.showWorkflowModal = true;
                },
                
                editWorkflow(workflow) {
                    this.editingWorkflow = workflow;
                    this.workflowForm = { 
                        name: workflow.name, 
                        type: workflow.type, 
                        jobs: [...workflow.jobs],
                        callback: workflow.callback || ''
                    };
                    this.showWorkflowModal = true;
                },
                
                saveWorkflow() {
                    const validJobs = this.workflowForm.jobs.filter(j => j);
                    if (validJobs.length < 2) {
                        this.toast('Need at least 2 jobs', 'error');
                        return;
                    }
                    
                    const workflow = {
                        id: this.editingWorkflow?.id || 'wf-' + Date.now(),
                        name: this.workflowForm.name,
                        type: this.workflowForm.type,
                        jobs: validJobs,
                        callback: this.workflowForm.type === 'chord' ? this.workflowForm.callback : null
                    };
                    
                    if (this.editingWorkflow) {
                        const idx = this.savedWorkflows.findIndex(w => w.id === workflow.id);
                        if (idx >= 0) this.savedWorkflows[idx] = workflow;
                    } else {
                        this.savedWorkflows.push(workflow);
                    }
                    
                    localStorage.setItem('procclaw_workflows', JSON.stringify(this.savedWorkflows));
                    this.showWorkflowModal = false;
                    this.toast(this.editingWorkflow ? 'Workflow updated' : 'Workflow created', 'success');
                },
                
                async deleteWorkflow(workflow) {
                    if (!confirm(`Delete workflow "${workflow.name}"?`)) return;
                    this.savedWorkflows = this.savedWorkflows.filter(w => w.id !== workflow.id);
                    localStorage.setItem('procclaw_workflows', JSON.stringify(this.savedWorkflows));
                    this.toast('Workflow deleted', 'success');
                },
                
                async runWorkflow(workflow) {
                    try {
                        const endpoint = `/api/v1/composite/${workflow.type}`;
                        const body = { job_ids: workflow.jobs };
                        if (workflow.type === 'chord' && workflow.callback) {
                            body.callback = workflow.callback;
                        }
                        
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || 'Failed to run workflow');
                        }
                        
                        const result = await res.json();
                        this.toast(`Workflow ${result.success ? 'completed' : 'finished with errors'}`, result.success ? 'success' : 'warning');
                        await this.loadWorkflows();
                    } catch (e) {
                        this.toast('Workflow failed: ' + e.message, 'error');
                    }
                },
                
                async runQuickWorkflow() {
                    if (this.quickWorkflow.jobs.length < 2) {
                        this.toast('Select at least 2 jobs', 'error');
                        return;
                    }
                    
                    try {
                        const endpoint = `/api/v1/composite/${this.quickWorkflow.type}`;
                        const body = { job_ids: this.quickWorkflow.jobs };
                        if (this.quickWorkflow.type === 'chord' && this.quickWorkflow.callback) {
                            body.callback = this.quickWorkflow.callback;
                        }
                        
                        this.toast(`Running ${this.quickWorkflow.type}...`, 'info');
                        
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || 'Failed to run workflow');
                        }
                        
                        const result = await res.json();
                        this.toast(`${this.quickWorkflow.type} ${result.success ? 'completed!' : 'finished with errors'}`, result.success ? 'success' : 'warning');
                        
                        // Clear quick workflow
                        this.quickWorkflow.jobs = [];
                        this.quickWorkflow.callback = '';
                        
                        await this.loadWorkflows();
                    } catch (e) {
                        this.toast('Failed: ' + e.message, 'error');
                    }
                },
                
                viewWorkflowRun(run) {
                    this.selectedWorkflowRun = run;
                    this.showWorkflowRunModal = true;
                },

                // Helpers
                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                },

                formatDateFull(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    return d.toLocaleString('pt-BR', { 
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                },

                formatNextRun(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    const now = new Date();
                    const diff = d - now;
                    if (diff < 0) return 'overdue';
                    if (diff < 3600000) return `in ${Math.round(diff / 60000)}m`;
                    if (diff < 86400000) return `in ${Math.round(diff / 3600000)}h`;
                    return d.toLocaleDateString('pt-BR');
                },

                formatUptime(seconds) {
                    if (!seconds) return '-';
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    if (h > 24) return `${Math.floor(h / 24)}d ${h % 24}h`;
                    if (h > 0) return `${h}h ${m}m`;
                    return `${m}m`;
                },

                cronToHuman(cron) {
                    if (!cron) return '';
                    const parts = cron.trim().split(/\s+/);
                    if (parts.length < 5) return cron;
                    
                    const [min, hour, dom, mon, dow] = parts;
                    
                    // Helper for time formatting
                    const formatTime = (h, m) => {
                        const hh = h.padStart(2, '0');
                        const mm = m.padStart(2, '0');
                        return `${hh}:${mm}`;
                    };
                    
                    // Days of week names
                    const dowNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const monNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    
                    let result = '';
                    
                    // Every minute
                    if (min === '*' && hour === '*') {
                        return 'Every minute';
                    }
                    
                    // Time part
                    if (hour !== '*' && min !== '*') {
                        // Handle hour ranges like */12
                        if (hour.startsWith('*/')) {
                            const interval = hour.slice(2);
                            result = `Every ${interval}h at :${min.padStart(2, '0')}`;
                        } else if (hour.includes(',')) {
                            const hours = hour.split(',').map(h => formatTime(h, min)).join(', ');
                            result = `At ${hours}`;
                        } else {
                            result = `At ${formatTime(hour, min)}`;
                        }
                    } else if (hour !== '*') {
                        result = `At ${hour}:00`;
                    } else if (min !== '*') {
                        if (min.startsWith('*/')) {
                            result = `Every ${min.slice(2)} min`;
                        } else {
                            result = `At :${min.padStart(2, '0')} every hour`;
                        }
                    }
                    
                    // Day of week
                    if (dow !== '*') {
                        if (dow.includes(',')) {
                            const days = dow.split(',').map(d => dowNames[parseInt(d)] || d).join(', ');
                            result += ` on ${days}`;
                        } else if (dow.includes('-')) {
                            const [start, end] = dow.split('-');
                            result += ` ${dowNames[parseInt(start)]}-${dowNames[parseInt(end)]}`;
                        } else {
                            result += ` on ${dowNames[parseInt(dow)] || dow}`;
                        }
                    }
                    
                    // Day of month
                    if (dom !== '*') {
                        if (dom.includes(',')) {
                            result += ` on day ${dom}`;
                        } else {
                            result += ` on day ${dom}`;
                        }
                    }
                    
                    // Month
                    if (mon !== '*') {
                        result += ` in ${monNames[parseInt(mon)] || mon}`;
                    }
                    
                    // Default daily
                    if (dow === '*' && dom === '*' && mon === '*' && result && !result.includes('Every')) {
                        result += ' daily';
                    }
                    
                    return result || cron;
                },

                toast(message, type = 'info') {
                    const id = Date.now();
                    this.toasts.push({ id, message, type, visible: true });
                    setTimeout(() => {
                        const idx = this.toasts.findIndex(t => t.id === id);
                        if (idx > -1) this.toasts.splice(idx, 1);
                    }, 3000);
                }
            };
        }
    </script>
</body>
</html>
