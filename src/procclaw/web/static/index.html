<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcClaw</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2310b981'/%3E%3Cstop offset='100%25' stop-color='%2306b6d4'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='%231a1a2e'/%3E%3Cpath d='M30 65 Q25 45 35 35 Q45 25 50 40 L50 60 Q50 70 40 70 Q30 70 30 65' fill='url(%23g)'/%3E%3Cpath d='M70 65 Q75 45 65 35 Q55 25 50 40 L50 60 Q50 70 60 70 Q70 70 70 65' fill='url(%23g)'/%3E%3Ccircle cx='50' cy='32' r='8' fill='url(%23g)'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['IBM Plex Sans', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            900: '#0d1117',
                            800: '#161b22',
                            700: '#21262d',
                            600: '#30363d',
                            500: '#484f58',
                            400: '#6e7681',
                            300: '#8b949e',
                            200: '#c9d1d9',
                            100: '#f0f6fc',
                        },
                        accent: {
                            500: '#f97316',
                            400: '#fb923c',
                            600: '#ea580c',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #21262d; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #484f58; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #6e7681; }
        @media (prefers-reduced-motion: no-preference) {
            @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
            .animate-pulse-slow { animation: pulse-slow 2s infinite; }
            @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
            .animate-slide-in { animation: slide-in 0.2s ease-out; }
        }
        .log-line { font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.5; }
        .log-timestamp { color: #6e7681; margin-right: 8px; user-select: none; }
        kbd { background: #30363d; padding: 2px 6px; border-radius: 4px; font-size: 11px; border: 1px solid #484f58; }
        button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible {
            outline: 2px solid #f97316;
            outline-offset: 2px;
        }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .tag-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #30363d; border-radius: 9999px; font-size: 12px; }
        .tag-badge:hover .tag-remove { opacity: 1; }
        .tag-remove { opacity: 0; cursor: pointer; transition: opacity 0.15s; }
        .tag-add-btn { cursor: pointer; padding: 2px 6px; border-radius: 9999px; background: #21262d; border: 1px dashed #484f58; font-size: 11px; }
        .tag-add-btn:hover { border-color: #6e7681; background: #30363d; }
        .dep-node { padding: 8px 12px; border-radius: 8px; border: 1px solid #30363d; background: #21262d; }
        .column-toggle { cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .column-toggle.active { background: #30363d; color: #f0f6fc; }
        .column-toggle:not(.active) { background: transparent; color: #6e7681; }
        /* Drag handle for column reorder */
        .drag-handle { cursor: grab; opacity: 0.5; }
        .drag-handle:hover { opacity: 1; }
    </style>
</head>
<body class="bg-dark-900 text-dark-200 min-h-dvh font-sans" x-data="app()" x-init="init()">
    
    <!-- Header -->
    <header class="bg-dark-800 border-b border-dark-600 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ü¶û</span>
                <h1 class="text-xl font-semibold text-dark-100">ProcClaw</h1>
                <span class="text-xs text-dark-400 bg-dark-700 px-2 py-0.5 rounded" x-text="version"></span>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-green-400 tabular-nums" x-text="stats.running"></span>
                        <span class="text-dark-400">running</span>
                    </div>
                    <div class="flex items-center gap-2" x-show="stats.failed > 0">
                        <span class="text-red-400 tabular-nums" x-text="stats.failed"></span>
                        <span class="text-dark-400">failed</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-dark-300 tabular-nums" x-text="stats.total"></span>
                        <span class="text-dark-400">total</span>
                    </div>
                </div>
                <div class="h-4 w-px bg-dark-600 hidden md:block"></div>
                <div class="flex items-center gap-2" x-show="health.status === 'healthy'">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse-slow"></span>
                    <span class="text-sm text-dark-300">Healthy</span>
                </div>
                <div class="flex items-center gap-2" x-show="health.status !== 'healthy'">
                    <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                    <span class="text-sm text-red-400">Offline</span>
                </div>
                <button @click="refresh()" class="p-2 hover:bg-dark-700 rounded-lg transition" aria-label="Refresh">
                    <svg class="w-5 h-5" :class="loading && 'animate-spin'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-dark-800 border-b border-dark-600">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex gap-1">
                <button @click="currentTab = 'jobs'" 
                    :class="currentTab === 'jobs' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    ‚öôÔ∏è Jobs
                </button>
                <button @click="currentTab = 'runs'; loadRuns()" 
                    :class="currentTab === 'runs' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üìä Runs
                </button>
                <button @click="currentTab = 'dependencies'" 
                    :class="currentTab === 'dependencies' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üîó Dependencies
                </button>
                <button @click="currentTab = 'logs'" 
                    :class="currentTab === 'logs' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üìú Logs
                </button>
                <button @click="currentTab = 'dlq'" 
                    :class="currentTab === 'dlq' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üíÄ DLQ
                    <span x-show="dlqStats.pending > 0" class="ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full" x-text="dlqStats.pending"></span>
                </button>
                <button @click="currentTab = 'config'" 
                    :class="currentTab === 'config' ? 'bg-dark-700 text-accent-400 border-b-2 border-accent-500' : 'text-dark-300 hover:text-dark-100 hover:bg-dark-700'"
                    class="px-4 py-3 text-sm font-medium transition rounded-t-lg">
                    üîß Config
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 pb-16">
        
        <!-- Jobs Tab -->
        <div x-show="currentTab === 'jobs'" x-cloak>
            <!-- Filters -->
            <div class="bg-dark-800 border border-dark-600 rounded-xl p-4 mb-4">
                <div class="flex flex-wrap gap-3 items-center">
                    <input type="text" x-model="filters.search" placeholder="Search jobs..." 
                        class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-accent-500 w-64">
                    <select x-model="filters.type" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Types</option>
                        <option value="continuous">Continuous</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="oneshot">One-shot</option>
                        <option value="manual">Manual</option>
                        <option value="openclaw">OpenClaw</option>
                    </select>
                    <select x-model="filters.status" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Status</option>
                        <option value="running">Running</option>
                        <option value="planned">Planned</option>
                        <option value="stopped">Stopped</option>
                        <option value="failed">Failed</option>
                    </select>
                    <select x-model="filters.tag" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Tags</option>
                        <template x-for="tag in allTags" :key="tag">
                            <option :value="tag" x-text="tag"></option>
                        </template>
                    </select>
                    <div class="ml-auto flex gap-2">
                        <button @click="showColumnSettings = true" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition" title="Column settings">
                            ‚öôÔ∏è Columns
                        </button>
                        <button @click="viewMode = viewMode === 'table' ? 'cards' : 'table'" 
                            class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition"
                            :title="viewMode === 'table' ? 'Card view' : 'Table view'">
                            <span x-show="viewMode === 'table'">üìá</span>
                            <span x-show="viewMode === 'cards'">üìä</span>
                        </button>
                        <button @click="showCreateModal = true" class="bg-accent-500 hover:bg-accent-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                            + New Job
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table View -->
            <div x-show="viewMode === 'table'" class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-dark-700">
                            <tr>
                                <template x-for="col in visibleColumns" :key="col.id">
                                    <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3 select-none"
                                        :class="col.sortable !== false && 'cursor-pointer hover:text-dark-200'"
                                        @click="col.sortable !== false && toggleSort(col.id)">
                                        <span class="flex items-center gap-1">
                                            <span x-text="col.label"></span>
                                            <span x-show="isSortedBy(col.id)" class="text-accent-400" x-text="sortDir === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                        </span>
                                    </th>
                                </template>
                                <th class="text-right text-xs font-medium text-dark-400 uppercase px-4 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-dark-700">
                            <template x-for="job in filteredJobs" :key="job.id">
                                <tr class="hover:bg-dark-700/50 transition">
                                    <!-- Dynamic columns -->
                                    <template x-for="col in visibleColumns" :key="col.id">
                                        <td class="px-4 py-3">
                                            <!-- Job ID -->
                                            <template x-if="col.id === 'id'">
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <button @click="selectJob(job)" class="font-medium text-dark-100 hover:text-accent-400 transition text-left" x-text="job.id"></button>
                                                        <button @click="openEditModal(job)" class="opacity-0 hover:opacity-100 focus:opacity-100 text-dark-400 hover:text-dark-200 transition text-xs" title="Edit">‚úèÔ∏è</button>
                                                    </div>
                                                    <div class="text-xs text-dark-400" x-text="job.name"></div>
                                                </div>
                                            </template>
                                            <!-- Type -->
                                            <template x-if="col.id === 'type'">
                                                <span class="text-xs px-2 py-1 rounded-full"
                                                    :class="getTypeClass(job.type)"
                                                    x-text="job.type">
                                                </span>
                                            </template>
                                            <!-- Status -->
                                            <template x-if="col.id === 'status'">
                                                <div class="flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full"
                                                        :class="job.status === 'running' ? 'bg-green-500' : job.status === 'failed' ? 'bg-red-500' : job.status === 'planned' ? 'bg-cyan-500' : 'bg-dark-500'">
                                                    </span>
                                                    <span class="text-sm" :class="!job.enabled && 'text-dark-500'" x-text="job.enabled ? job.status : 'disabled'"></span>
                                                </div>
                                            </template>
                                            <!-- Last Run -->
                                            <template x-if="col.id === 'last_run'">
                                                <span class="text-sm text-dark-400" x-text="job.started_at ? formatDate(job.started_at) : '-'"></span>
                                            </template>
                                            <!-- Next Run -->
                                            <template x-if="col.id === 'next_run'">
                                                <span class="text-sm text-dark-400" x-text="job.next_run ? formatNextRun(job.next_run) : '-'"></span>
                                            </template>
                                            <!-- Tags -->
                                            <template x-if="col.id === 'tags'">
                                                <div class="flex flex-wrap gap-1 items-center" @click.stop>
                                                    <template x-for="tag in (job.tags || [])" :key="tag">
                                                        <span class="tag-badge text-dark-300">
                                                            <span x-text="tag"></span>
                                                            <span class="tag-remove text-dark-500 hover:text-red-400" @click="removeTag(job.id, tag)">√ó</span>
                                                        </span>
                                                    </template>
                                                    <button class="tag-add-btn text-dark-400 hover:text-dark-200" @click="openTagInput(job.id)" title="Add tag">+</button>
                                                </div>
                                            </template>
                                            <!-- Dependencies -->
                                            <template x-if="col.id === 'deps'">
                                                <div class="flex items-center gap-1 text-sm">
                                                    <span x-show="job.depends_on?.length > 0" class="text-blue-400" :title="'Depends on: ' + job.depends_on?.map(d => d.job).join(', ')">
                                                        ‚¨ÖÔ∏è <span x-text="job.depends_on?.length"></span>
                                                    </span>
                                                    <span x-show="job.dependents?.length > 0" class="text-green-400" :title="'Dependents: ' + job.dependents?.map(d => d.job).join(', ')">
                                                        ‚û°Ô∏è <span x-text="job.dependents?.length"></span>
                                                    </span>
                                                    <span x-show="!job.depends_on?.length && !job.dependents?.length" class="text-dark-500">-</span>
                                                </div>
                                            </template>
                                            <!-- Created -->
                                            <template x-if="col.id === 'created'">
                                                <span class="text-sm text-dark-400" x-text="job.created_at ? formatDate(job.created_at) : '-'"></span>
                                            </template>
                                            <!-- Modified -->
                                            <template x-if="col.id === 'modified'">
                                                <span class="text-sm text-dark-400" x-text="job.updated_at ? formatDate(job.updated_at) : '-'"></span>
                                            </template>
                                            <!-- Schedule -->
                                            <template x-if="col.id === 'schedule'">
                                                <span class="text-xs font-mono text-dark-400" x-text="job.schedule || '-'"></span>
                                            </template>
                                            <!-- Restarts -->
                                            <template x-if="col.id === 'restarts'">
                                                <span class="text-sm text-dark-400 tabular-nums" x-text="job.restart_count || 0"></span>
                                            </template>
                                        </td>
                                    </template>
                                    <!-- Actions -->
                                    <td class="px-4 py-3 text-right" @click.stop>
                                        <div class="flex justify-end gap-0.5">
                                            <button @click="startJob(job.id)" x-show="job.status !== 'running'" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-green-400 text-sm" title="Start">‚ñ∂</button>
                                            <button @click="stopJob(job.id)" x-show="job.status === 'running'" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Stop">‚óº</button>
                                            <button @click="forceRunJob(job.id)" x-show="job.schedule && job.status !== 'running'" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-purple-400 text-sm" title="Run Now">‚ö°</button>
                                            <button @click="viewLogs(job.id)" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-blue-400 text-sm" title="Logs">üìã</button>
                                            <button @click="deleteJob(job.id)" 
                                                class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Delete">‚úï</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="filteredJobs.length === 0" class="text-center py-8 text-dark-400">
                    No jobs match your filters
                </div>
            </div>

            <!-- Cards View -->
            <div x-show="viewMode === 'cards'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="job in filteredJobs" :key="job.id">
                    <div class="bg-dark-800 border border-dark-600 rounded-xl p-4 hover:border-dark-500 transition cursor-pointer" @click="selectJob(job)">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="font-medium text-dark-100" x-text="job.id"></div>
                                <div class="text-xs text-dark-400" x-text="job.name"></div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full" :class="job.status === 'running' ? 'bg-green-500 animate-pulse-slow' : job.status === 'failed' ? 'bg-red-500' : job.status === 'planned' ? 'bg-cyan-500' : 'bg-dark-500'"></span>
                                <span class="text-xs px-2 py-1 rounded-full" :class="getTypeClass(job.type)" x-text="job.type"></span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 mb-3" @click.stop>
                            <template x-for="tag in (job.tags || [])" :key="tag">
                                <span class="tag-badge text-dark-300">
                                    <span x-text="tag"></span>
                                    <span class="tag-remove text-dark-500 hover:text-red-400" @click="removeTag(job.id, tag)">√ó</span>
                                </span>
                            </template>
                            <button class="tag-add-btn text-dark-400 hover:text-dark-200" @click="openTagInput(job.id)" title="Add tag">+</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs text-dark-400 mb-3">
                            <div>Last: <span class="text-dark-300" x-text="job.started_at ? formatDate(job.started_at) : '-'"></span></div>
                            <div>Next: <span class="text-dark-300" x-text="job.next_run ? formatNextRun(job.next_run) : '-'"></span></div>
                        </div>
                        <div class="flex justify-between items-center" @click.stop>
                            <div class="flex items-center gap-1 text-xs">
                                <span x-show="job.depends_on?.length > 0" class="text-blue-400">‚¨ÖÔ∏è <span x-text="job.depends_on?.length"></span></span>
                                <span x-show="job.dependents?.length > 0" class="text-green-400">‚û°Ô∏è <span x-text="job.dependents?.length"></span></span>
                            </div>
                            <div class="flex gap-0.5">
                                <button @click="startJob(job.id)" x-show="job.status !== 'running'" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-green-400 text-sm" title="Start">‚ñ∂</button>
                                <button @click="stopJob(job.id)" x-show="job.status === 'running'" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Stop">‚óº</button>
                                <button @click="forceRunJob(job.id)" x-show="job.schedule && job.status !== 'running'" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-purple-400 text-sm" title="Run Now">‚ö°</button>
                                <button @click="viewLogs(job.id)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-blue-400 text-sm" title="Logs">üìã</button>
                                <button @click="deleteJob(job.id)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-red-400 text-sm" title="Delete">‚úï</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Runs Tab -->
        <div x-show="currentTab === 'runs'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <!-- Filters -->
                <div class="p-4 border-b border-dark-600 flex flex-wrap gap-4 items-center">
                    <select x-model="runsFilter.job_id" @change="loadRuns()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Jobs</option>
                        <template x-for="job in jobs" :key="job.id">
                            <option :value="job.id" x-text="job.id"></option>
                        </template>
                    </select>
                    <select x-model="runsFilter.status" @change="loadRuns()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Status</option>
                        <option value="completed">Completed (Success + Failed)</option>
                        <option value="success">Success only</option>
                        <option value="failed">Failed only</option>
                        <option value="running">Running only</option>
                    </select>
                    <select x-model="runsFilter.trigger" @change="loadRuns()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                        <option value="">All Triggers</option>
                        <option value="manual">Manual</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="oneshot">One-shot</option>
                        <option value="restart">Restart</option>
                        <option value="dependency">Dependency</option>
                        <option value="api">API</option>
                    </select>
                    <button @click="loadRuns()" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm">üîÑ Refresh</button>
                    <span class="text-sm text-dark-400 ml-auto">
                        Showing <span class="text-dark-200" x-text="((runsPage-1)*runsPerPage+1) + '-' + Math.min(runsPage*runsPerPage, runs.length)"></span> 
                        of <span class="text-dark-200" x-text="runs.length"></span>
                    </span>
                </div>
                
                <!-- Table -->
                <table class="w-full">
                    <thead class="bg-dark-700">
                        <tr>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Job</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Status</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Trigger</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Started</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Duration</th>
                            <th class="text-left text-xs font-medium text-dark-400 uppercase px-4 py-3">Exit Code</th>
                            <th class="text-right text-xs font-medium text-dark-400 uppercase px-4 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-dark-700">
                        <template x-for="run in paginatedRuns" :key="run.id">
                            <tr class="hover:bg-dark-750 transition cursor-pointer" @click="selectRun(run)">
                                <td class="px-4 py-3">
                                    <div class="font-medium text-dark-100" x-text="run.job_id"></div>
                                    <div class="text-xs text-dark-400" x-text="run.job_name || ''"></div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full"
                                            :class="run.status === 'success' ? 'bg-green-500' : run.status === 'failed' ? 'bg-red-500' : 'bg-yellow-500 animate-pulse'">
                                        </span>
                                        <span class="text-sm" x-text="run.status"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="text-xs px-2 py-1 rounded-full bg-dark-600 text-dark-300" x-text="run.trigger"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="text-sm text-dark-300" x-text="formatDateFull(run.started_at)"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="text-sm text-dark-400" x-text="run.duration_seconds ? formatDuration(run.duration_seconds) : '-'"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="font-mono text-sm" :class="run.exit_code === 0 ? 'text-green-400' : run.exit_code ? 'text-red-400' : 'text-dark-400'" x-text="run.exit_code ?? '-'"></span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <button @click.stop="viewRunLogs(run)" class="w-7 h-7 flex items-center justify-center hover:bg-dark-600 rounded text-dark-400 hover:text-blue-400 text-sm" title="View Logs">üìã</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                
                <!-- Pagination -->
                <div x-show="totalRunsPages > 1" class="p-4 border-t border-dark-600 flex items-center justify-center gap-2">
                    <button @click="runsPage = 1" :disabled="runsPage === 1" 
                        class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">‚èÆÔ∏è</button>
                    <button @click="runsPage--" :disabled="runsPage === 1" 
                        class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">‚óÄÔ∏è</button>
                    <span class="px-4 text-sm">
                        Page <span class="text-dark-200" x-text="runsPage"></span> of <span class="text-dark-200" x-text="totalRunsPages"></span>
                    </span>
                    <button @click="runsPage++" :disabled="runsPage === totalRunsPages" 
                        class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">‚ñ∂Ô∏è</button>
                    <button @click="runsPage = totalRunsPages" :disabled="runsPage === totalRunsPages" 
                        class="px-3 py-1 bg-dark-700 hover:bg-dark-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">‚è≠Ô∏è</button>
                </div>
                
                <div x-show="runs.length === 0" class="text-center py-8 text-dark-400">
                    No runs found
                </div>
            </div>
        </div>

        <!-- Run Detail Modal -->
        <div x-show="selectedRun" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="selectedRun = null">
            <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-2xl" @click.stop>
                <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-medium" x-text="'Run #' + selectedRun?.id"></h2>
                        <p class="text-sm text-dark-400" x-text="selectedRun?.job_id"></p>
                    </div>
                    <button @click="selectedRun = null" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                </div>
                <div class="p-4 space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Status</div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full" :class="selectedRun?.status === 'success' ? 'bg-green-500' : selectedRun?.status === 'failed' ? 'bg-red-500' : 'bg-yellow-500'"></span>
                                <span x-text="selectedRun?.status"></span>
                            </div>
                        </div>
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Trigger</div>
                            <span x-text="selectedRun?.trigger"></span>
                        </div>
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Exit Code</div>
                            <span class="font-mono" :class="selectedRun?.exit_code === 0 ? 'text-green-400' : 'text-red-400'" x-text="selectedRun?.exit_code ?? '-'"></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Started</div>
                            <span x-text="selectedRun?.started_at ? formatDateFull(selectedRun.started_at) : '-'"></span>
                        </div>
                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Finished</div>
                            <span x-text="selectedRun?.finished_at ? formatDateFull(selectedRun.finished_at) : '-'"></span>
                        </div>
                    </div>
                    <div class="bg-dark-700 rounded-lg p-3">
                        <div class="text-xs text-dark-400 mb-1">Duration</div>
                        <span x-text="selectedRun?.duration_seconds ? formatDuration(selectedRun.duration_seconds) : '-'"></span>
                    </div>
                    <div x-show="selectedRun?.cmd" class="bg-dark-700 rounded-lg p-3">
                        <div class="text-xs text-dark-400 mb-1">Command</div>
                        <div class="font-mono text-sm text-dark-200 break-all" x-text="selectedRun?.cmd"></div>
                    </div>
                    <div x-show="selectedRun?.error" class="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
                        <div class="text-xs text-red-400 mb-1">Error</div>
                        <div class="text-sm text-red-300" x-text="selectedRun?.error"></div>
                    </div>
                    <div class="flex gap-2 pt-4 border-t border-dark-700">
                        <button @click="viewRunLogs(selectedRun)" class="flex-1 py-2 bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 rounded-lg transition">üìã View Logs</button>
                        <button @click="selectedRun = null" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Run Logs Modal -->
        <div x-show="showRunLogs" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showRunLogs = false">
            <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-4xl max-h-[80vh] flex flex-col" @click.stop>
                <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-medium">Logs for Run #<span x-text="runLogRun?.id"></span></h2>
                        <p class="text-sm text-dark-400"><span x-text="runLogRun?.job_id"></span> ‚Ä¢ <span x-text="runLogRun?.started_at ? formatDateFull(runLogRun.started_at) : ''"></span></p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-dark-400" x-text="runLogContent.length + ' lines'"></span>
                        <button @click="showRunLogs = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto p-4">
                    <pre class="font-mono text-xs text-dark-200 whitespace-pre-wrap break-all"><template x-for="(line, idx) in runLogContent" :key="idx"><div class="hover:bg-dark-700 px-2 py-0.5" x-text="line"></div></template></pre>
                </div>
                <div class="p-4 border-t border-dark-600 flex justify-end gap-2">
                    <button @click="downloadRunLogs()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm">üì• Download</button>
                    <button @click="showRunLogs = false" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm">Close</button>
                </div>
            </div>
        </div>

        <!-- Dependencies Tab -->
        <div x-show="currentTab === 'dependencies'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl p-6">
                <h3 class="text-lg font-medium mb-4">Job Dependency Graph</h3>
                
                <div class="space-y-6">
                    <template x-for="chain in dependencyChains" :key="chain.root">
                        <div class="bg-dark-700 rounded-lg p-4">
                            <div class="text-sm text-dark-400 mb-3">Chain starting from: <span class="text-dark-200 font-medium" x-text="chain.root"></span></div>
                            <div class="flex flex-wrap items-center gap-3">
                                <template x-for="(node, idx) in chain.nodes" :key="node.id">
                                    <div class="flex items-center gap-2">
                                        <div class="dep-node cursor-pointer hover:border-accent-500 transition" @click="selectJobById(node.id)"
                                            :class="{'border-green-500': getJobStatus(node.id) === 'running', 'border-red-500': getJobStatus(node.id) === 'failed', 'border-cyan-500': getJobStatus(node.id) === 'planned'}">
                                            <div class="font-medium text-sm" x-text="node.id"></div>
                                            <div class="text-xs text-dark-400" x-text="node.type"></div>
                                        </div>
                                        <span x-show="idx < chain.nodes.length - 1" class="text-dark-500 text-xl">‚Üí</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="independentJobs.length > 0" class="bg-dark-700 rounded-lg p-4">
                        <div class="text-sm text-dark-400 mb-3">Independent Jobs (no dependencies)</div>
                        <div class="flex flex-wrap gap-3">
                            <template x-for="job in independentJobs" :key="job.id">
                                <div class="dep-node cursor-pointer hover:border-accent-500 transition" @click="selectJobById(job.id)"
                                    :class="{'border-green-500': job.status === 'running', 'border-red-500': job.status === 'failed', 'border-cyan-500': job.status === 'planned'}">
                                    <div class="font-medium text-sm" x-text="job.id"></div>
                                    <div class="text-xs text-dark-400" x-text="job.type"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <div x-show="dependencyChains.length === 0 && independentJobs.length === 0" class="text-center py-8 text-dark-400">
                    No jobs configured
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div x-show="currentTab === 'logs'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl overflow-hidden">
                <div class="flex flex-wrap items-center justify-between gap-3 p-4 border-b border-dark-600">
                    <div class="flex items-center gap-3">
                        <select x-model="selectedLogJob" @change="loadLogs()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="daemon">ü¶û Daemon</option>
                            <template x-for="job in jobs" :key="job.id">
                                <option :value="job.id" x-text="job.id"></option>
                            </template>
                        </select>
                        <select x-model="logType" @change="loadLogs()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="stdout">stdout</option>
                            <option value="stderr">stderr</option>
                        </select>
                        <input type="number" x-model="logLines" @change="loadLogs()" class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm w-20 focus:outline-none" placeholder="Lines">
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="text" x-model="logFilter" placeholder="Filter logs..." 
                            class="bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-accent-500 w-48">
                        <label class="flex items-center gap-2 text-sm text-dark-300">
                            <input type="checkbox" x-model="showTimestamps" class="rounded bg-dark-700 border-dark-600">
                            Timestamps
                        </label>
                        <label class="flex items-center gap-2 text-sm text-dark-300">
                            <input type="checkbox" x-model="autoRefreshLogs" class="rounded bg-dark-700 border-dark-600">
                            Auto
                        </label>
                        <button @click="loadLogs()" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition">üîÑ</button>
                        <button @click="downloadLogs()" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition" title="Download">üì•</button>
                    </div>
                </div>
                <div class="h-[500px] overflow-auto scrollbar-thin p-4 bg-dark-900" id="log-container">
                    <template x-for="(line, i) in filteredLogs" :key="i">
                        <div class="log-line py-0.5 hover:bg-dark-800 flex">
                            <span x-show="showTimestamps && hasTimestamp(line)" class="log-timestamp shrink-0" x-text="extractTimestamp(line)"></span>
                            <span x-show="showTimestamps && !hasTimestamp(line)" class="log-timestamp shrink-0 invisible">00:00:00</span>
                            <span :class="getLogLineClass(line)" x-text="line"></span>
                        </div>
                    </template>
                    <div x-show="filteredLogs.length === 0 && logContent.length > 0" class="text-dark-500 text-center py-8">No logs match filter</div>
                    <div x-show="logContent.length === 0" class="text-dark-500 text-center py-8">No logs available</div>
                </div>
                <div class="p-2 border-t border-dark-600 bg-dark-800 text-xs text-dark-400 flex justify-between">
                    <span x-text="`Showing ${filteredLogs.length} of ${logContent.length} lines`"></span>
                    <span x-show="logFilter" class="text-accent-400">Filtered</span>
                </div>
            </div>
        </div>

        <!-- DLQ Tab -->
        <div x-show="currentTab === 'dlq'" x-cloak>
            <div class="bg-dark-800 border border-dark-600 rounded-xl p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-lg font-medium">Dead Letter Queue</div>
                        <span class="px-2 py-1 bg-dark-700 rounded text-sm text-dark-400" x-text="dlqEntries.length + ' entries'"></span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="reinjectAllDlq()" x-show="dlqEntries.length > 0" class="px-3 py-2 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded-lg text-sm transition">Reinject All</button>
                        <button @click="purgeDlq()" x-show="dlqEntries.length > 0" class="px-3 py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg text-sm transition">Purge Old</button>
                    </div>
                </div>
            </div>
            <div class="space-y-3">
                <template x-for="entry in dlqEntries" :key="entry.id">
                    <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="font-medium text-dark-100" x-text="entry.job_id"></div>
                                <div class="text-xs text-dark-400" x-text="formatDateFull(entry.failed_at)"></div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="reinjectDlq(entry.id)" class="px-3 py-1.5 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded text-sm transition">Reinject</button>
                                <button @click="deleteDlq(entry.id)" class="px-3 py-1.5 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded text-sm transition">Delete</button>
                            </div>
                        </div>
                        <div class="bg-dark-900 rounded p-3 font-mono text-xs text-red-400" x-text="entry.error || 'No error message'"></div>
                        <div class="mt-2 text-xs text-dark-500">Attempts: <span x-text="entry.attempts"></span> | Exit code: <span x-text="entry.exit_code"></span></div>
                    </div>
                </template>
                <div x-show="dlqEntries.length === 0" class="text-center py-12 text-dark-400">
                    <div class="text-4xl mb-3">‚ú®</div>
                    <p class="text-dark-300 font-medium">Dead Letter Queue is empty</p>
                    <p class="text-sm mt-1">All jobs are running smoothly</p>
                </div>
            </div>
        </div>

        <!-- Config Tab -->
        <div x-show="currentTab === 'config'" x-cloak>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                    <h3 class="font-medium mb-4">Daemon Info</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Status</span>
                            <span class="text-green-400" x-text="health.status"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Version</span>
                            <span x-text="health.version"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Uptime</span>
                            <span x-text="formatUptime(health.uptime_seconds)"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Jobs Running</span>
                            <span x-text="health.jobs_running"></span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Total Jobs</span>
                            <span x-text="health.jobs_total"></span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-dark-400">API Endpoint</span>
                            <span class="text-dark-300 font-mono text-sm">localhost:9876</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-dark-700 space-y-2">
                        <button @click="reloadConfig()" class="w-full py-2 bg-accent-500/20 text-accent-400 hover:bg-accent-500/30 rounded-lg text-sm transition">üîÑ Reload Config</button>
                        <button @click="restartDaemon()" class="w-full py-2 bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 rounded-lg text-sm transition">üîÑ Restart Daemon</button>
                    </div>
                </div>
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                    <h3 class="font-medium mb-4">Job Types</h3>
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full shrink-0">continuous</span>
                            <p class="text-sm text-dark-400">Long-running jobs that should always be running. Auto-restart on crash.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded-full shrink-0">scheduled</span>
                            <p class="text-sm text-dark-400">Jobs triggered by cron schedule. Run, complete, wait for next schedule.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs rounded-full shrink-0">manual</span>
                            <p class="text-sm text-dark-400">Jobs triggered manually via API or CLI. No auto-scheduling.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-orange-500/20 text-orange-400 text-xs rounded-full shrink-0">openclaw</span>
                            <p class="text-sm text-dark-400">Jobs linked to OpenClaw. Depend on AI/cron integration, synced with OpenClaw daemon.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="px-2 py-1 bg-cyan-500/20 text-cyan-400 text-xs rounded-full shrink-0">oneshot</span>
                            <p class="text-sm text-dark-400">Jobs that run once at a specific datetime. Auto-disabled after execution.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-dark-800 border border-dark-600 rounded-xl p-4">
                    <h3 class="font-medium mb-4">Monitoring</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Prometheus Metrics</span>
                            <a href="/metrics" target="_blank" class="text-accent-400 hover:text-accent-300 text-sm">üìä /metrics</a>
                        </div>
                        <div class="flex justify-between py-2 border-b border-dark-700">
                            <span class="text-dark-400">Health Check</span>
                            <a href="/health" target="_blank" class="text-accent-400 hover:text-accent-300 text-sm">‚ù§Ô∏è /health</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Job Detail Modal -->
    <div x-show="selectedJob" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="selectedJob = null">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-2xl max-h-[80vh] overflow-hidden" @click.stop>
            <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-medium" x-text="selectedJob?.id"></h2>
                    <p class="text-sm text-dark-400" x-text="selectedJob?.name"></p>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="openEditModal(selectedJob)" class="p-2 hover:bg-dark-700 rounded-lg text-dark-400 hover:text-dark-200" title="Edit">‚úèÔ∏è</button>
                    <button @click="selectedJob = null" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
                </div>
            </div>
            <div class="p-4 overflow-auto max-h-[60vh] scrollbar-thin">
                <template x-if="selectedJob">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Status</div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" :class="selectedJob.status === 'running' ? 'bg-green-500' : selectedJob.status === 'failed' ? 'bg-red-500' : selectedJob.status === 'planned' ? 'bg-cyan-500' : 'bg-dark-500'"></span>
                                    <span x-text="selectedJob.status"></span>
                                </div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Type</div>
                                <span class="text-xs px-2 py-1 rounded-full" :class="getTypeClass(selectedJob.type)" x-text="selectedJob.type"></span>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">PID</div>
                                <div x-text="selectedJob.pid || '-'"></div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Restarts</div>
                                <div x-text="selectedJob.restart_count || 0"></div>
                            </div>
                        </div>

                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-2">Tags</div>
                            <div class="flex flex-wrap gap-2 items-center">
                                <template x-for="tag in (selectedJob.tags || [])" :key="tag">
                                    <span class="tag-badge text-dark-300">
                                        <span x-text="tag"></span>
                                        <span class="tag-remove text-dark-500 hover:text-red-400" @click="removeTag(selectedJob.id, tag); selectedJob.tags = selectedJob.tags.filter(t => t !== tag)">√ó</span>
                                    </span>
                                </template>
                                <button class="tag-add-btn text-dark-400 hover:text-dark-200" @click="openTagInput(selectedJob.id)">+ Add tag</button>
                            </div>
                        </div>

                        <div x-show="selectedJob.depends_on?.length > 0 || selectedJob.dependents?.length > 0" class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-2">Dependencies</div>
                            <div class="space-y-2">
                                <div x-show="selectedJob.depends_on?.length > 0">
                                    <span class="text-xs text-blue-400">Depends on:</span>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                        <template x-for="dep in selectedJob.depends_on" :key="dep.job">
                                            <span class="text-xs px-2 py-1 bg-blue-500/20 text-blue-400 rounded cursor-pointer hover:bg-blue-500/30" @click="selectJobById(dep.job)" x-text="dep.job + ' (' + dep.condition + ')'"></span>
                                        </template>
                                    </div>
                                </div>
                                <div x-show="selectedJob.dependents?.length > 0">
                                    <span class="text-xs text-green-400">Dependents:</span>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                        <template x-for="dep in selectedJob.dependents" :key="dep.job">
                                            <span class="text-xs px-2 py-1 bg-green-500/20 text-green-400 rounded cursor-pointer hover:bg-green-500/30" @click="selectJobById(dep.job)" x-text="dep.job"></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Created</div>
                                <div x-text="selectedJob.created_at ? formatDateFull(selectedJob.created_at) : '-'"></div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Modified</div>
                                <div x-text="selectedJob.updated_at ? formatDateFull(selectedJob.updated_at) : '-'"></div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Started At</div>
                                <div x-text="selectedJob.started_at ? formatDateFull(selectedJob.started_at) : '-'"></div>
                            </div>
                            <div class="bg-dark-700 rounded-lg p-3">
                                <div class="text-xs text-dark-400 mb-1">Next Run</div>
                                <div x-text="selectedJob.next_run ? formatDateFull(selectedJob.next_run) : '-'"></div>
                            </div>
                        </div>

                        <div class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Command</div>
                            <div class="font-mono text-sm text-dark-200 break-all" x-text="selectedJob.cmd || '-'"></div>
                        </div>

                        <div x-show="selectedJob.cwd" class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Working Directory</div>
                            <div class="font-mono text-sm text-dark-200 break-all" x-text="selectedJob.cwd"></div>
                        </div>

                        <div x-show="selectedJob.schedule" class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Schedule</div>
                            <div class="font-mono text-sm text-dark-200" x-text="selectedJob.schedule"></div>
                        </div>

                        <div x-show="selectedJob.run_at" class="bg-dark-700 rounded-lg p-3">
                            <div class="text-xs text-dark-400 mb-1">Run At (One-shot)</div>
                            <div class="font-mono text-sm text-dark-200" x-text="formatDateFull(selectedJob.run_at)"></div>
                        </div>

                        <div class="flex flex-wrap gap-2 pt-4 border-t border-dark-700">
                            <button @click="startJob(selectedJob.id)" x-show="selectedJob.status !== 'running'"
                                class="flex-1 min-w-[80px] py-2 bg-green-500/20 text-green-400 hover:bg-green-500/30 rounded-lg transition">‚ñ∂Ô∏è Start</button>
                            <button @click="stopJob(selectedJob.id)" x-show="selectedJob.status === 'running'"
                                class="flex-1 min-w-[80px] py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg transition">‚èπÔ∏è Stop</button>
                            <button @click="forceRunJob(selectedJob.id)" x-show="(selectedJob.schedule || selectedJob.run_at) && selectedJob.status !== 'running'"
                                class="flex-1 min-w-[80px] py-2 bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 rounded-lg transition" title="Force immediate execution">‚ö° Run Now</button>
                            <button @click="restartJob(selectedJob.id)"
                                class="flex-1 min-w-[80px] py-2 bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 rounded-lg transition">üîÑ Restart</button>
                            <button @click="viewLogs(selectedJob.id); selectedJob = null"
                                class="flex-1 min-w-[80px] py-2 bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 rounded-lg transition">üìú Logs</button>
                            <button @click="deleteJob(selectedJob.id)"
                                class="flex-1 min-w-[80px] py-2 bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg transition">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div x-show="showEditModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showEditModal = false">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-lg" @click.stop>
            <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                <h2 class="text-lg font-medium">Edit Job: <span x-text="editJob.id"></span></h2>
                <button @click="showEditModal = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
            </div>
            <form @submit.prevent="saveJob()" class="p-4 space-y-4">
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Name</label>
                    <input type="text" x-model="editJob.name" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Description</label>
                    <input type="text" x-model="editJob.description" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Command</label>
                    <input type="text" x-model="editJob.cmd" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Working Directory</label>
                    <input type="text" x-model="editJob.cwd" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-dark-400 mb-1">Type</label>
                        <select x-model="editJob.type" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none">
                            <option value="manual">Manual</option>
                            <option value="continuous">Continuous</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="oneshot">One-shot</option>
                            <option value="openclaw">OpenClaw</option>
                        </select>
                    </div>
                    <div x-show="editJob.type === 'scheduled'">
                        <label class="block text-sm text-dark-400 mb-1">Schedule (cron)</label>
                        <input type="text" x-model="editJob.schedule" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="0 * * * *">
                    </div>
                    <div x-show="editJob.type === 'oneshot'">
                        <label class="block text-sm text-dark-400 mb-1">Run At</label>
                        <input type="datetime-local" x-model="editJob.run_at" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Tags (comma-separated)</label>
                    <input type="text" x-model="editJob.tagsStr" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="button" @click="showEditModal = false" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Job Modal -->
    <div x-show="showCreateModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showCreateModal = false">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-lg" @click.stop>
            <div class="p-4 border-b border-dark-600 flex items-center justify-between">
                <h2 class="text-lg font-medium">Create New Job</h2>
                <button @click="showCreateModal = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
            </div>
            <form @submit.prevent="createJob()" class="p-4 space-y-4">
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Job ID *</label>
                    <input type="text" x-model="newJob.id" required class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Name</label>
                    <input type="text" x-model="newJob.name" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Command *</label>
                    <input type="text" x-model="newJob.cmd" required class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="python script.py">
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Working Directory</label>
                    <input type="text" x-model="newJob.cwd" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="/path/to/dir">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-dark-400 mb-1">Type</label>
                        <select x-model="newJob.type" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none">
                            <option value="manual">Manual</option>
                            <option value="continuous">Continuous</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="oneshot">One-shot</option>
                            <option value="openclaw">OpenClaw</option>
                        </select>
                    </div>
                    <div x-show="newJob.type === 'scheduled'">
                        <label class="block text-sm text-dark-400 mb-1">Schedule (cron)</label>
                        <input type="text" x-model="newJob.schedule" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="0 * * * *">
                    </div>
                    <div x-show="newJob.type === 'oneshot'">
                        <label class="block text-sm text-dark-400 mb-1">Run At</label>
                        <input type="datetime-local" x-model="newJob.run_at" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Tags (comma-separated)</label>
                    <input type="text" x-model="newJob.tags" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500" placeholder="tag1, tag2">
                </div>
                <div>
                    <label class="block text-sm text-dark-400 mb-1">Environment Variables</label>
                    <textarea x-model="newJob.env" rows="3" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500 font-mono text-sm" placeholder="KEY=value&#10;SECRET_TOKEN=abc123&#10;API_KEY=xyz"></textarea>
                    <p class="text-xs text-dark-500 mt-1">One per line: KEY=value. For secrets, reference from ~/.procclaw/secrets.env</p>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="button" @click="showCreateModal = false" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg transition">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg transition">Create Job</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tag Input Modal -->
    <div x-show="showTagInput" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showTagInput = false">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-xs p-4" @click.stop>
            <div class="mb-3 text-sm text-dark-400">Add tag to: <span class="text-dark-200" x-text="tagInputJobId"></span></div>
            <form @submit.prevent="addTag()">
                <input type="text" x-model="newTagValue" x-ref="tagInput" class="w-full bg-dark-700 border border-dark-600 rounded-lg px-3 py-2 focus:outline-none focus:border-accent-500 mb-3" placeholder="Tag name" autofocus>
                <div class="flex gap-2">
                    <button type="button" @click="showTagInput = false" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg text-sm transition">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Column Settings Modal -->
    <div x-show="showColumnSettings" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showColumnSettings = false">
        <div class="bg-dark-800 border border-dark-600 rounded-xl w-full max-w-md p-4" @click.stop>
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium">Column Settings</h3>
                <button @click="showColumnSettings = false" class="p-2 hover:bg-dark-700 rounded-lg">‚úï</button>
            </div>
            <p class="text-sm text-dark-400 mb-4">Select columns to show and drag to reorder:</p>
            <div class="space-y-2 mb-4">
                <template x-for="col in allColumns" :key="col.id">
                    <div class="flex items-center gap-3 p-2 bg-dark-700 rounded-lg">
                        <span class="drag-handle text-dark-500">‚†ø</span>
                        <label class="flex items-center gap-2 flex-1 cursor-pointer">
                            <input type="checkbox" :checked="isColumnVisible(col.id)" @change="toggleColumn(col.id)" class="rounded bg-dark-600 border-dark-500">
                            <span x-text="col.label"></span>
                        </label>
                    </div>
                </template>
            </div>
            <div class="flex gap-2">
                <button @click="resetColumns()" class="flex-1 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg text-sm transition">Reset to Default</button>
                <button @click="showColumnSettings = false" class="flex-1 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg text-sm transition">Done</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 right-0 bg-dark-800 border-t border-dark-600 py-2 px-4 text-xs text-dark-400 flex justify-between items-center">
        <div class="flex gap-4">
            <span><kbd>r</kbd> Refresh</span>
            <span><kbd>1-5</kbd> Tabs</span>
            <span><kbd>/</kbd> Search</span>
            <span><kbd>Esc</kbd> Close</span>
        </div>
        <div class="flex items-center gap-3">
            <span>ü¶û ProcClaw</span>
            <span x-text="'v' + version"></span>
        </div>
    </footer>

    <!-- Toast Notifications -->
    <div class="fixed bottom-12 right-4 space-y-2 z-50">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in"
                :class="toast.type === 'success' ? 'bg-green-500/90' : toast.type === 'error' ? 'bg-red-500/90' : 'bg-dark-700'"
                x-show="toast.visible">
                <span x-text="toast.message"></span>
            </div>
        </template>
    </div>

    <script>
        function app() {
            // Default columns configuration
            const defaultColumns = [
                { id: 'id', label: 'Job', visible: true, sortKey: 'id' },
                { id: 'type', label: 'Type', visible: true, sortKey: 'type' },
                { id: 'status', label: 'Status', visible: true, sortKey: 'status' },
                { id: 'last_run', label: 'Last Run', visible: true, sortKey: 'started_at' },
                { id: 'next_run', label: 'Next Run', visible: true, sortKey: 'next_run' },
                { id: 'tags', label: 'Tags', visible: true, sortable: false },
                { id: 'deps', label: 'Deps', visible: true, sortable: false },
                { id: 'schedule', label: 'Schedule', visible: false, sortKey: 'schedule' },
                { id: 'restarts', label: 'Restarts', visible: false, sortKey: 'restart_count' },
                { id: 'created', label: 'Created', visible: false, sortKey: 'created_at' },
                { id: 'modified', label: 'Modified', visible: false, sortKey: 'updated_at' },
            ];

            // Load saved columns from localStorage
            const savedColumns = localStorage.getItem('procclaw_columns');
            const columns = savedColumns ? JSON.parse(savedColumns) : defaultColumns;

            return {
                // State
                currentTab: 'jobs',
                viewMode: 'table',
                loading: false,
                version: '0.1.0',
                lastUpdate: null,
                health: { status: 'unknown', version: '', uptime_seconds: 0, jobs_running: 0, jobs_total: 0 },
                jobs: [],
                stats: { total: 0, running: 0, failed: 0 },
                dlqStats: { pending: 0, total: 0 },
                dlqEntries: [],
                runs: [],
                runsFilter: { job_id: '', status: 'completed', trigger: '' },
                runsPage: 1,
                runsPerPage: 10,
                selectedRun: null,
                showRunLogs: false,
                runLogContent: [],
                runLogRun: null,
                logContent: [],
                logLoadedAt: null,
                selectedJob: null,
                showCreateModal: false,
                showEditModal: false,
                showTagInput: false,
                showColumnSettings: false,
                showTimestamps: true,
                tagInputJobId: '',
                newTagValue: '',
                toasts: [],
                
                // Columns
                allColumns: columns,
                
                // Filters & Sort
                filters: { search: '', type: '', status: '', tag: '' },
                sortBy: 'id',
                sortDir: 'asc',
                selectedLogJob: 'daemon',
                logType: 'stdout',
                logLines: 100,
                logFilter: '',
                autoRefreshLogs: false,
                
                // Forms
                newJob: { id: '', name: '', cmd: '', cwd: '', type: 'manual', schedule: '', run_at: '', tags: '', env: '' },
                editJob: { id: '', name: '', description: '', cmd: '', cwd: '', type: '', schedule: '', run_at: '', tagsStr: '' },
                
                // Computed
                get visibleColumns() {
                    return this.allColumns.filter(c => c.visible);
                },

                get filteredJobs() {
                    let result = this.jobs.filter(job => {
                        if (this.filters.search && !job.id.toLowerCase().includes(this.filters.search.toLowerCase()) && 
                            !job.name?.toLowerCase().includes(this.filters.search.toLowerCase())) return false;
                        if (this.filters.type && job.type !== this.filters.type) return false;
                        if (this.filters.status && job.status !== this.filters.status) return false;
                        if (this.filters.tag && !(job.tags || []).includes(this.filters.tag)) return false;
                        return true;
                    });
                    
                    // Sort
                    if (this.sortBy) {
                        const dateFields = ['started_at', 'next_run', 'created_at', 'updated_at'];
                        result = result.sort((a, b) => {
                            let aVal = a[this.sortBy];
                            let bVal = b[this.sortBy];
                            
                            // Handle dates
                            if (dateFields.includes(this.sortBy)) {
                                aVal = aVal ? new Date(aVal).getTime() : (this.sortDir === 'asc' ? Infinity : 0);
                                bVal = bVal ? new Date(bVal).getTime() : (this.sortDir === 'asc' ? Infinity : 0);
                            } else {
                                // Handle nulls for non-dates
                                if (aVal == null) aVal = '';
                                if (bVal == null) bVal = '';
                            }
                            
                            // Compare
                            if (aVal < bVal) return this.sortDir === 'asc' ? -1 : 1;
                            if (aVal > bVal) return this.sortDir === 'asc' ? 1 : -1;
                            return 0;
                        });
                    }
                    
                    return result;
                },
                
                get allTags() {
                    const tags = new Set();
                    this.jobs.forEach(job => (job.tags || []).forEach(tag => tags.add(tag)));
                    return Array.from(tags).sort();
                },

                get filteredLogs() {
                    if (!this.logFilter) return this.logContent;
                    const filter = this.logFilter.toLowerCase();
                    return this.logContent.filter(line => line.toLowerCase().includes(filter));
                },

                get dependencyChains() {
                    const chains = [];
                    const visited = new Set();
                    const roots = this.jobs.filter(j => 
                        (!j.depends_on || j.depends_on.length === 0) && 
                        (j.dependents && j.dependents.length > 0)
                    );
                    for (const root of roots) {
                        if (visited.has(root.id)) continue;
                        const chain = this.buildChain(root.id, visited);
                        if (chain.length > 1) {
                            chains.push({ root: root.id, nodes: chain });
                        }
                    }
                    return chains;
                },

                get independentJobs() {
                    return this.jobs.filter(j => 
                        (!j.depends_on || j.depends_on.length === 0) && 
                        (!j.dependents || j.dependents.length === 0)
                    );
                },

                // Init
                async init() {
                    await this.refresh();
                    setInterval(() => this.refresh(), 10000);
                    setInterval(() => {
                        if (this.autoRefreshLogs && this.currentTab === 'logs') this.loadLogs();
                    }, 5000);
                    
                    document.addEventListener('keydown', (e) => {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
                        if (e.key === 'r' && !e.metaKey && !e.ctrlKey) { this.refresh(); e.preventDefault(); }
                        if (e.key === '1') { this.currentTab = 'jobs'; e.preventDefault(); }
                        if (e.key === '2') { this.currentTab = 'dependencies'; e.preventDefault(); }
                        if (e.key === '3') { this.currentTab = 'logs'; e.preventDefault(); }
                        if (e.key === '4') { this.currentTab = 'dlq'; e.preventDefault(); }
                        if (e.key === '5') { this.currentTab = 'config'; e.preventDefault(); }
                        if (e.key === 'Escape') { this.selectedJob = null; this.showCreateModal = false; this.showEditModal = false; this.showTagInput = false; this.showColumnSettings = false; }
                        if (e.key === '/' && this.currentTab === 'jobs') { 
                            document.querySelector('input[placeholder="Search jobs..."]')?.focus(); 
                            e.preventDefault(); 
                        }
                    });
                },

                // Column management
                isColumnVisible(id) {
                    const col = this.allColumns.find(c => c.id === id);
                    return col ? col.visible : false;
                },

                toggleColumn(id) {
                    const col = this.allColumns.find(c => c.id === id);
                    if (col) {
                        col.visible = !col.visible;
                        this.saveColumns();
                    }
                },

                saveColumns() {
                    localStorage.setItem('procclaw_columns', JSON.stringify(this.allColumns));
                },

                resetColumns() {
                    this.allColumns = JSON.parse(JSON.stringify(defaultColumns));
                    this.saveColumns();
                },

                getTypeClass(type) {
                    switch (type) {
                        case 'continuous': return 'bg-green-500/20 text-green-400';
                        case 'scheduled': return 'bg-blue-500/20 text-blue-400';
                        case 'oneshot': return 'bg-pink-500/20 text-pink-400';
                        case 'manual': return 'bg-purple-500/20 text-purple-400';
                        case 'openclaw': return 'bg-orange-500/20 text-orange-400';
                        default: return 'bg-dark-600 text-dark-300';
                    }
                },

                buildChain(jobId, visited) {
                    const chain = [];
                    let current = this.jobs.find(j => j.id === jobId);
                    while (current && !visited.has(current.id)) {
                        visited.add(current.id);
                        chain.push({ id: current.id, type: current.type, name: current.name });
                        if (current.dependents && current.dependents.length > 0) {
                            current = this.jobs.find(j => j.id === current.dependents[0].job);
                        } else {
                            break;
                        }
                    }
                    return chain;
                },

                getJobStatus(jobId) {
                    const job = this.jobs.find(j => j.id === jobId);
                    return job?.status || 'unknown';
                },

                selectJobById(jobId) {
                    const job = this.jobs.find(j => j.id === jobId);
                    if (job) this.selectedJob = job;
                },

                // Log timestamps - only show real timestamps from log content
                hasTimestamp(line) {
                    // Match patterns like [2026-02-09T10:16:16] or [10:16:16]
                    return /^\[[\d\-T:\.]+\]/.test(line) || /^\[\d{4}-\d{2}-\d{2}/.test(line);
                },
                
                extractTimestamp(line) {
                    // Extract timestamp from line like [2026-02-09T10:16:16.123456] or [10:16:16]
                    const match = line.match(/^\[([\d\-T:\.]+)\]/);
                    if (match) {
                        const ts = match[1];
                        // If it's a full ISO timestamp, extract just the time part
                        if (ts.includes('T')) {
                            const timePart = ts.split('T')[1];
                            return timePart.substring(0, 12); // HH:MM:SS.mmm
                        }
                        return ts;
                    }
                    return '';
                },
                
                getLogTimestamp(index) {
                    // Fallback for old behavior if needed
                    return '';
                },

                getLogLineClass(line) {
                    if (line.includes('ERROR') || line.includes('FAIL') || line.includes('Traceback')) return 'text-red-400';
                    if (line.includes('WARN') || line.includes('WARNING')) return 'text-yellow-400';
                    if (line.includes('‚úÖ') || line.includes('SUCCESS')) return 'text-green-400';
                    if (line.includes('üöÄ') || line.includes('Starting')) return 'text-blue-400';
                    return 'text-dark-300';
                },

                // API
                async api(endpoint, method = 'GET', body = null) {
                    const opts = { method, headers: { 'Content-Type': 'application/json' } };
                    if (body) opts.body = JSON.stringify(body);
                    const res = await fetch(`/api/v1${endpoint}`, opts);
                    return res.json();
                },

                async refresh() {
                    this.loading = true;
                    try {
                        const [healthRes, jobsRes, dlqRes] = await Promise.all([
                            fetch('/health').then(r => r.json()),
                            this.api('/jobs'),
                            this.api('/dlq/stats').catch(() => ({ pending: 0, total: 0 }))
                        ]);
                        
                        this.health = healthRes;
                        this.version = healthRes.version;
                        this.jobs = jobsRes.jobs || [];
                        this.dlqStats = dlqRes;
                        
                        this.stats = {
                            total: this.jobs.length,
                            running: this.jobs.filter(j => j.status === 'running').length,
                            failed: this.jobs.filter(j => j.status === 'failed').length,
                        };
                        
                        if (this.currentTab === 'dlq') await this.loadDlq();
                        this.lastUpdate = new Date();
                    } catch (e) {
                        console.error('Refresh failed:', e);
                        this.health.status = 'offline';
                    }
                    this.loading = false;
                },

                // Sorting
                toggleSort(colId) {
                    const col = this.allColumns.find(c => c.id === colId);
                    if (!col || col.sortable === false) return;
                    const sortKey = col.sortKey || colId;
                    
                    if (this.sortBy === sortKey) {
                        this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortBy = sortKey;
                        this.sortDir = 'asc';
                    }
                },
                
                getSortKey(colId) {
                    const col = this.allColumns.find(c => c.id === colId);
                    return col?.sortKey || colId;
                },
                
                isSortedBy(colId) {
                    const col = this.allColumns.find(c => c.id === colId);
                    const sortKey = col?.sortKey || colId;
                    return this.sortBy === sortKey;
                },

                // Jobs
                async startJob(id) {
                    const res = await this.api(`/jobs/${id}/start`, 'POST');
                    this.toast(res.success ? `Started ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async stopJob(id) {
                    const res = await this.api(`/jobs/${id}/stop`, 'POST');
                    this.toast(res.success ? `Stopped ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async restartJob(id) {
                    const res = await this.api(`/jobs/${id}/restart`, 'POST');
                    this.toast(res.success ? `Restarted ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async forceRunJob(id) {
                    const res = await this.api(`/jobs/${id}/start`, 'POST');
                    this.toast(res.success ? `‚ö° Force started ${id}` : `Failed: ${res.message}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                selectJob(job) {
                    this.selectedJob = job;
                },

                openEditModal(job) {
                    // Format run_at for datetime-local input (YYYY-MM-DDTHH:mm)
                    let runAtFormatted = '';
                    if (job.run_at) {
                        const d = new Date(job.run_at);
                        runAtFormatted = d.toISOString().slice(0, 16);
                    }
                    this.editJob = {
                        id: job.id,
                        name: job.name || '',
                        description: job.description || '',
                        cmd: job.cmd || '',
                        cwd: job.cwd || '',
                        type: job.type || 'manual',
                        schedule: job.schedule || '',
                        run_at: runAtFormatted,
                        tagsStr: (job.tags || []).join(', ')
                    };
                    this.showEditModal = true;
                },

                async saveJob() {
                    const updates = {
                        name: this.editJob.name,
                        description: this.editJob.description,
                        cmd: this.editJob.cmd,
                        cwd: this.editJob.cwd || null,
                        type: this.editJob.type,
                        schedule: this.editJob.type === 'scheduled' ? (this.editJob.schedule || null) : null,
                        run_at: this.editJob.type === 'oneshot' ? (this.editJob.run_at || null) : null,
                        tags: this.editJob.tagsStr.split(',').map(t => t.trim()).filter(t => t)
                    };
                    
                    const res = await this.api(`/jobs/${this.editJob.id}`, 'PATCH', updates);
                    this.toast(res.success ? `Updated ${this.editJob.id}` : `Failed: ${res.error}`, res.success ? 'success' : 'error');
                    this.showEditModal = false;
                    await this.refresh();
                },

                async createJob() {
                    if (!this.newJob.id || !this.newJob.cmd) {
                        this.toast('Job ID and Command are required', 'error');
                        return;
                    }
                    
                    const jobData = {
                        id: this.newJob.id,
                        name: this.newJob.name || this.newJob.id,
                        cmd: this.newJob.cmd,
                        cwd: this.newJob.cwd || null,
                        type: this.newJob.type,
                        schedule: this.newJob.type === 'scheduled' ? this.newJob.schedule : null,
                        run_at: this.newJob.type === 'oneshot' ? this.newJob.run_at : null,
                        tags: this.newJob.tags,
                        env: this.newJob.env || null,
                        enabled: true,
                    };
                    
                    try {
                        const res = await this.api('/jobs', 'POST', jobData);
                        if (res.success) {
                            this.toast(`Job '${this.newJob.id}' created!`, 'success');
                            this.showCreateModal = false;
                            this.newJob = { id: '', name: '', cmd: '', cwd: '', type: 'manual', schedule: '', run_at: '', tags: '', env: '' };
                            await this.refresh();
                        } else {
                            this.toast(res.detail || res.message || 'Failed to create job', 'error');
                        }
                    } catch (e) {
                        this.toast(`Error: ${e.message}`, 'error');
                    }
                },

                async deleteJob(id) {
                    if (!confirm(`Delete job "${id}"?\n\nThis will remove it from jobs.yaml permanently.`)) return;
                    const res = await this.api(`/jobs/${id}`, 'DELETE');
                    this.toast(res.success ? `Deleted ${id}` : `Failed: ${res.error}`, res.success ? 'success' : 'error');
                    this.selectedJob = null;
                    await this.refresh();
                },

                async toggleJob(id, currentEnabled) {
                    const action = currentEnabled ? 'disable' : 'enable';
                    const res = await this.api(`/jobs/${id}/${action}`, 'POST');
                    this.toast(res.success ? `Job ${action}d` : `Failed: ${res.error}`, res.success ? 'success' : 'error');
                    await this.refresh();
                },

                // Tags
                openTagInput(jobId) {
                    this.tagInputJobId = jobId;
                    this.newTagValue = '';
                    this.showTagInput = true;
                    this.$nextTick(() => this.$refs.tagInput?.focus());
                },

                async addTag() {
                    if (!this.newTagValue.trim()) return;
                    const res = await this.api(`/jobs/${this.tagInputJobId}/tags/${encodeURIComponent(this.newTagValue.trim())}`, 'POST');
                    this.toast(res.success ? `Tag added` : `Failed: ${res.error}`, res.success ? 'success' : 'error');
                    this.showTagInput = false;
                    await this.refresh();
                },

                async removeTag(jobId, tag) {
                    const res = await this.api(`/jobs/${jobId}/tags/${encodeURIComponent(tag)}`, 'DELETE');
                    if (res.success) await this.refresh();
                },

                // Logs
                async loadLogs() {
                    try {
                        const endpoint = this.selectedLogJob === 'daemon' 
                            ? `/daemon/logs?lines=${this.logLines}&type=${this.logType}`
                            : `/jobs/${this.selectedLogJob}/logs?lines=${this.logLines}&type=${this.logType}`;
                        const res = await this.api(endpoint);
                        // Reverse to show newest first
                        this.logContent = (res.lines || []).reverse();
                        this.logLoadedAt = new Date();
                    } catch (e) {
                        this.logContent = ['Failed to load logs'];
                    }
                },

                viewLogs(jobId) {
                    this.selectedLogJob = jobId;
                    this.currentTab = 'logs';
                    this.loadLogs();
                },

                downloadLogs() {
                    const content = this.filteredLogs.join('\n');
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedLogJob}-${this.logType}-${new Date().toISOString().slice(0,10)}.log`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.toast('Logs downloaded', 'success');
                },

                // Runs
                async loadRuns() {
                    try {
                        let endpoint = '/runs?limit=500';
                        if (this.runsFilter.job_id) endpoint += `&job_id=${this.runsFilter.job_id}`;
                        // Handle "completed" as success + failed (exclude running)
                        if (this.runsFilter.status && this.runsFilter.status !== 'completed') {
                            endpoint += `&status=${this.runsFilter.status}`;
                        }
                        if (this.runsFilter.trigger) endpoint += `&trigger=${this.runsFilter.trigger}`;
                        const res = await this.api(endpoint);
                        let runs = res.runs || [];
                        // Filter out running if "completed" is selected
                        if (this.runsFilter.status === 'completed') {
                            runs = runs.filter(r => r.status !== 'running');
                        }
                        this.runs = runs;
                        this.runsPage = 1; // Reset to first page on filter change
                    } catch (e) {
                        console.error('Failed to load runs:', e);
                        this.runs = [];
                    }
                },

                get paginatedRuns() {
                    const start = (this.runsPage - 1) * this.runsPerPage;
                    return this.runs.slice(start, start + this.runsPerPage);
                },

                get totalRunsPages() {
                    return Math.ceil(this.runs.length / this.runsPerPage);
                },

                selectRun(run) {
                    this.selectedRun = run;
                },

                async viewRunLogs(run) {
                    // Try to load logs from SQLite first
                    try {
                        const res = await this.api(`/runs/${run.id}/logs?limit=5000`);
                        if (res.lines && res.lines.length > 0) {
                            this.runLogContent = res.lines;
                            this.showRunLogs = true;
                            this.runLogRun = run;
                            return;
                        }
                    } catch (e) {
                        console.log('No SQLite logs, falling back to file logs');
                    }
                    
                    // Fallback to file-based logs
                    this.selectedLogJob = run.job_id;
                    this.currentTab = 'logs';
                    this.loadLogs();
                    this.selectedRun = null;
                },

                formatDuration(seconds) {
                    if (!seconds) return '-';
                    if (seconds < 1) return `${Math.round(seconds * 1000)}ms`;
                    if (seconds < 60) return `${seconds.toFixed(1)}s`;
                    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`;
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    return `${h}h ${m}m`;
                },

                downloadRunLogs() {
                    if (!this.runLogRun || !this.runLogContent.length) return;
                    const content = this.runLogContent.join('\n');
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.runLogRun.job_id}-run-${this.runLogRun.id}.log`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.toast('Logs downloaded', 'success');
                },

                // DLQ
                async loadDlq() {
                    try {
                        const res = await this.api('/dlq');
                        this.dlqEntries = res.entries || [];
                    } catch (e) {
                        this.dlqEntries = [];
                    }
                },

                async reinjectDlq(id) {
                    const res = await this.api(`/dlq/${id}/reinject`, 'POST');
                    this.toast(res.success ? 'Reinjected' : 'Failed', res.success ? 'success' : 'error');
                    await this.loadDlq();
                },

                async deleteDlq(id) {
                    await this.api(`/dlq/${id}`, 'DELETE');
                    await this.loadDlq();
                },

                async reinjectAllDlq() {
                    for (const entry of this.dlqEntries) {
                        await this.api(`/dlq/${entry.id}/reinject`, 'POST');
                    }
                    this.toast('Reinjected all', 'success');
                    await this.loadDlq();
                },

                async purgeDlq() {
                    await this.api('/dlq?older_than_days=7', 'DELETE');
                    this.toast('Purged old entries', 'success');
                    await this.loadDlq();
                },

                // Config
                async reloadConfig() {
                    const res = await this.api('/reload', 'POST');
                    this.toast(res.success ? 'Config reloaded' : 'Failed', res.success ? 'success' : 'error');
                    await this.refresh();
                },

                async restartDaemon() {
                    if (!confirm('Restart the daemon? All running jobs will be stopped and restarted.')) return;
                    this.toast('Restarting daemon...', 'info');
                    try {
                        await fetch('/api/v1/daemon/restart', { method: 'POST' });
                        await new Promise(r => setTimeout(r, 3000));
                        await this.refresh();
                        this.toast('Daemon restarted', 'success');
                    } catch (e) {
                        this.toast('Daemon restart initiated - refresh in a few seconds', 'info');
                    }
                },

                // Helpers
                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                },

                formatDateFull(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    return d.toLocaleString('pt-BR', { 
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                },

                formatNextRun(dateStr) {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    const now = new Date();
                    const diff = d - now;
                    if (diff < 0) return 'overdue';
                    if (diff < 3600000) return `in ${Math.round(diff / 60000)}m`;
                    if (diff < 86400000) return `in ${Math.round(diff / 3600000)}h`;
                    return d.toLocaleDateString('pt-BR');
                },

                formatUptime(seconds) {
                    if (!seconds) return '-';
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    if (h > 24) return `${Math.floor(h / 24)}d ${h % 24}h`;
                    if (h > 0) return `${h}h ${m}m`;
                    return `${m}m`;
                },

                toast(message, type = 'info') {
                    const id = Date.now();
                    this.toasts.push({ id, message, type, visible: true });
                    setTimeout(() => {
                        const idx = this.toasts.findIndex(t => t.id === id);
                        if (idx > -1) this.toasts.splice(idx, 1);
                    }, 3000);
                }
            };
        }
    </script>
</body>
</html>
