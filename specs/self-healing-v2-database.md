# Self-Healing v2 - Database Schema

## Overview
New SQLite tables for storing healing reviews, suggestions, and actions.

## Tables

### healing_reviews
Stores each periodic analysis execution.

| Column | Type | Description |
|--------|------|-------------|
| id | INTEGER PK | Auto-increment |
| job_id | TEXT NOT NULL | Job being analyzed |
| started_at | TIMESTAMP NOT NULL | When analysis started |
| finished_at | TIMESTAMP | When analysis finished |
| status | TEXT NOT NULL | 'running', 'completed', 'failed' |
| runs_analyzed | INTEGER | Number of runs analyzed |
| logs_lines | INTEGER | Lines of logs analyzed |
| ai_sessions_count | INTEGER | AI sessions analyzed |
| sla_violations_count | INTEGER | SLA violations found |
| suggestions_count | INTEGER | Suggestions generated |
| auto_applied_count | INTEGER | Auto-applied suggestions |
| error_message | TEXT | Error if failed |
| analysis_duration_ms | INTEGER | Duration in ms |
| ai_tokens_used | INTEGER | Tokens consumed |
| created_at | TIMESTAMP | Record creation |

### healing_suggestions
Stores suggestions generated by analysis.

| Column | Type | Description |
|--------|------|-------------|
| id | INTEGER PK | Auto-increment |
| review_id | INTEGER FK | Links to healing_reviews |
| job_id | TEXT NOT NULL | Job this suggestion is for |
| category | TEXT NOT NULL | 'performance', 'cost', 'reliability', 'security', 'config', 'prompt', 'script' |
| severity | TEXT NOT NULL | 'low', 'medium', 'high', 'critical' |
| title | TEXT NOT NULL | Short title |
| description | TEXT NOT NULL | Full explanation |
| current_state | TEXT | Current code/config |
| suggested_change | TEXT | Proposed change |
| expected_impact | TEXT | Expected improvement |
| affected_files | TEXT | JSON array of paths |
| status | TEXT NOT NULL | 'pending', 'approved', 'rejected', 'applied', 'failed' |
| reviewed_at | TIMESTAMP | When reviewed |
| reviewed_by | TEXT | 'auto' or 'human' |
| rejection_reason | TEXT | If rejected |
| applied_at | TIMESTAMP | When applied |
| action_id | INTEGER FK | Links to healing_actions |
| created_at | TIMESTAMP | Record creation |

### healing_actions
Stores executed actions with rollback capability.

| Column | Type | Description |
|--------|------|-------------|
| id | INTEGER PK | Auto-increment |
| suggestion_id | INTEGER FK | Links to healing_suggestions |
| job_id | TEXT NOT NULL | Job affected |
| action_type | TEXT NOT NULL | 'edit_script', 'edit_prompt', 'edit_config', 'run_command', 'restart_job' |
| file_path | TEXT | File modified |
| original_content | TEXT | Backup of original |
| new_content | TEXT | New content applied |
| command_executed | TEXT | If command was run |
| status | TEXT NOT NULL | 'success', 'failed', 'rolled_back' |
| error_message | TEXT | Error if failed |
| can_rollback | BOOLEAN | If rollback is possible |
| rolled_back_at | TIMESTAMP | When rolled back |
| execution_duration_ms | INTEGER | Duration in ms |
| ai_session_key | TEXT | AI session if used |
| created_at | TIMESTAMP | Record creation |

## Indexes
- `idx_healing_reviews_job` on healing_reviews(job_id)
- `idx_healing_reviews_started` on healing_reviews(started_at DESC)
- `idx_healing_suggestions_job` on healing_suggestions(job_id)
- `idx_healing_suggestions_status` on healing_suggestions(status)
- `idx_healing_suggestions_created` on healing_suggestions(created_at DESC)
- `idx_healing_actions_job` on healing_actions(job_id)
- `idx_healing_actions_suggestion` on healing_actions(suggestion_id)

## Migration
This is migration version 8. Must be applied after version 7.

## Acceptance Criteria
- [ ] All three tables created successfully
- [ ] All indexes created
- [ ] Foreign key constraints work
- [ ] Migration is idempotent (can run multiple times safely)
- [ ] Existing data not affected
